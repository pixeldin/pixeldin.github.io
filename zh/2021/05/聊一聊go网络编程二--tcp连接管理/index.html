<!DOCTYPE html>
<html lang="zh-cn">
  <head>
    
    <script type="application/ld+json">

{  
  "@context":"http://schema.org",
  "@type":"Website",
  "@id":"",
  "author": {
    "@type": "Person",
    "name": "pixelpig",
    
    "image": "https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/pig.jpg"
    
  },
  "name":"pixelpig.tech",
  "description":"\u003cp\u003e上一篇我们聊到在Go中是如何发起一个TCP连接的，以及列举一个全双工的Demo，这次接着填补上一节留下的坑，连接池管理。\u003c\/p\u003e",
  "url":"\/zh\/2021\/05\/%E8%81%8A%E4%B8%80%E8%81%8Ago%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E4%BA%8C--tcp%E8%BF%9E%E6%8E%A5%E7%AE%A1%E7%90%86\/",
  "keywords":"[]"
}

</script>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.111.3 with theme Tranquilpeak 0.5.3-BETA">
<meta name="author" content="pixelpig">
<meta name="keywords" content="">
<meta name="description" content="上一篇我们聊到在Go中是如何发起一个TCP连接的，以及列举一个全双工的Demo，这次接着填补上一节留下的坑，连接池管理。">


<meta property="og:description" content="上一篇我们聊到在Go中是如何发起一个TCP连接的，以及列举一个全双工的Demo，这次接着填补上一节留下的坑，连接池管理。">
<meta property="og:type" content="article">
<meta property="og:title" content="聊一聊Go网络编程(二)--TCP连接管理">
<meta name="twitter:title" content="聊一聊Go网络编程(二)--TCP连接管理">
<meta property="og:url" content="/zh/2021/05/%E8%81%8A%E4%B8%80%E8%81%8Ago%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E4%BA%8C--tcp%E8%BF%9E%E6%8E%A5%E7%AE%A1%E7%90%86/">
<meta property="twitter:url" content="/zh/2021/05/%E8%81%8A%E4%B8%80%E8%81%8Ago%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E4%BA%8C--tcp%E8%BF%9E%E6%8E%A5%E7%AE%A1%E7%90%86/">
<meta property="og:site_name" content="pixelpig.tech">
<meta property="og:description" content="上一篇我们聊到在Go中是如何发起一个TCP连接的，以及列举一个全双工的Demo，这次接着填补上一节留下的坑，连接池管理。">
<meta name="twitter:description" content="上一篇我们聊到在Go中是如何发起一个TCP连接的，以及列举一个全双工的Demo，这次接着填补上一节留下的坑，连接池管理。">
<meta property="og:locale" content="zh">

  
    <meta property="article:published_time" content="2021-05-16T00:00:00">
  
  
    <meta property="article:modified_time" content="2021-05-16T00:00:00">
  
  
  
    
      <meta property="article:section" content="Go">
    
      <meta property="article:section" content="网络编程">
    
  
  
    
      <meta property="article:tag" content="TCP">
    
      <meta property="article:tag" content="连接池">
    
  


<meta name="twitter:card" content="summary">

  <meta name="twitter:site" content="@pixelpigpigpig">


  <meta name="twitter:creator" content="@pixelpigpigpig">






  <meta property="og:image" content="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/pig.jpg">
  <meta property="twitter:image" content="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/pig.jpg">





  <meta property="og:image" content="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/blog/net-2.png">
  <meta property="twitter:image" content="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/blog/net-2.png">


    <title>聊一聊Go网络编程(二)--TCP连接管理</title>

    <link rel="icon" href="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/blog/static/pig_round_circle.png">
    

    

    <link rel="canonical" href="/zh/2021/05/%E8%81%8A%E4%B8%80%E8%81%8Ago%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E4%BA%8C--tcp%E8%BF%9E%E6%8E%A5%E7%AE%A1%E7%90%86/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha512-H9jrZiiopUdsLpg94A333EfumgUBpO9MdbxStdeITo+KEIMaNfHNvwyjjDJb+ERPaRS6DpyRlKbvPUasNItRyw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    
    
    <link rel="stylesheet" href="css/style-hzezrmckmobe762t6uelutfaiasrbqfuvrnardmpe6x0eunosl9tyqk61.min.css" />
    
    

    
      
    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="5">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="/zh/" aria-label="去首页">pixelpig.tech</a>
  </div>
  
    
      <a class="header-right-picture "
         href="/#about" aria-label="打开链接: /#about">
    
    
    
      
        <img class="header-picture" src="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/pig.jpg" alt="作者的图片" />
      
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="5">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="/#about" aria-label="阅读有关作者的更多信息">
          <img class="sidebar-profile-picture" src="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/pig.jpg" alt="作者的图片" />
        </a>
        <h4 class="sidebar-profile-name">pixelpig</h4>
        
          <h5 class="sidebar-profile-bio">With enthusiasm for open source and I am looking forward to be a better developer. Stay hungry, stay foolish <strong>:）</strong></h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/en" title="English">
    
      <i class="sidebar-button-icon fa fa-lg fa-language"></i>
      
      <span class="sidebar-button-desc">English</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/zh/" title="Home">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">首页</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/zh/categories" title="Categories">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">分类</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/zh/tags" title="Tags">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">标签</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/zh/archives" title="Archives">
    
      <i class="sidebar-button-icon fa fa-lg fa-archive"></i>
      
      <span class="sidebar-button-desc">归档</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/zh/#about" title="About">
    
      <i class="sidebar-button-icon fa fa-lg fa-question-circle"></i>
      
      <span class="sidebar-button-desc">关于我</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/pixeldin" target="_blank" rel="noopener" title="pixeldin">
    
      <i class="sidebar-button-icon fab fa-lg fa-github-alt"></i>
      
      <span class="sidebar-button-desc">github</span>
    </a>
  </li>



    </ul>
    <ul class="sidebar-buttons">
      


    </ul>
    <ul class="sidebar-buttons">
      


    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="5"
        class="
               hasCoverMetaIn
               ">
        <article class="post" id="top">
          
          
            <div class="post-header main-content-wrap text-left">
  
    <h1 class="post-title">
      聊一聊Go网络编程(二)--TCP连接管理
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time datetime="2021-05-16T00:00:00Z">
        
  五月 16, 2021

      </time>
    
    
  
  
    <span>发布在</span>
    
      <a class="category-link" href="/zh/categories/go">Go</a>, 
    
      <a class="category-link" href="/zh/categories/%e7%bd%91%e7%bb%9c%e7%bc%96%e7%a8%8b">网络编程</a>
    
  

  </div>

</div>
          
          <div class="post-content markdown">
            <div class="main-content-wrap">
              <p>上一篇我们聊到在Go中是如何发起一个TCP连接的，以及列举一个全双工的Demo，这次接着填补上一节留下的坑，连接池管理。</p>
<h3 id="前言">前言</h3>
<p>在上一节提到，计算机连接的每次tcp建立，都要进行三次握手，而为了避免频繁创建销毁，并且维持连接的活性，引入了keepalive的api，然而keepalive仅仅是告诉tcp链接在空闲时候进行探测（有别于HTTP），如果我们要真正复用连接的话，可以采用连接池，示例图如下。<br>
<img src="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/blog/tcp-pool.png" alt="image"></p>
<h3 id="连接池特性">连接池特性</h3>
<p>如上图所示，一个连接池应该具备什么特性呢？</p>
<ol>
<li>使用者可以从池子获取连接</li>
<li>连接用完可以归还</li>
<li>连接数有个<strong>上限</strong>，避免频繁创建导致连接复用率低</li>
<li>对不健康的连接进行善后处理(关闭连接)，并把活跃连接数减一</li>
</ol>
<h3 id="边界情况">边界情况</h3>
<p>除了满足连接池的常用操作之外，我们要考虑如果连接数达到上限，而没有空闲连接怎么办，这里可以使用Go原生<code>sync</code>包<code>Mutex</code>自带的“<strong>让步</strong>”功能，类似于<strong>Java</strong>的<code>yield()</code>方法，释放当前互斥锁，并且等待其他连接归还时触发条件并<strong>唤醒</strong>。</p>
<h4 id="抛砖引玉">抛砖引玉</h4>
<p>我们先用一个例子来实现等待与唤醒，这里主要是熟悉<code>wait()</code>和<code>Signal()</code>函数的用法。</p>
<ul>
<li>wait()<br>
当<code>wait()</code>执行时，会做两个操作：
<ol>
<li>释放当前绑定的互斥锁，源码执行了<code>c.L.Unlock()</code>，所以并不会阻塞长期占有资源，会释放让给其他协程唤醒。</li>
<li>把当前函数所在协程加入等待唤醒的队列</li>
</ol>
</li>
<li>Signal()<br>
唤醒等待的协程有两个触发条件：
<ol>
<li>同一个互斥cond实例执行了<code>Signal()</code>函数</li>
<li><code>wait()</code>函数之前等待的<code>for{}</code>条件被打破</li>
</ol>
</li>
</ul>
<p><strong>完整示例：</strong><br>
这里我们使用两个协程，id为&lt;G-等待方&gt;的协程先执行，并且在条件未允许处释放互斥锁，并等待唤醒，在函数<code>ForWhileSignal()</code>中实现。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">ForWhileSignal</span>(<span style="color:#a6e22e">sig</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">signal</span>, <span style="color:#a6e22e">gid</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">mutx</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Mutex</span>, <span style="color:#a6e22e">cd</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Cond</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">mutx</span>.<span style="color:#a6e22e">Lock</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#a6e22e">gid</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; 执行defer()\n&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">mutx</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 等待打破条件
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> !<span style="color:#a6e22e">sig</span>.<span style="color:#a6e22e">ready</span> {
</span></span><span style="display:flex;"><span>	    <span style="color:#75715e">// 等待ready信号
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#a6e22e">gid</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; 等待唤醒...\n&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">cd</span>.<span style="color:#a6e22e">Wait</span>()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#a6e22e">gid</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; 被叫醒! \n&#34;</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>另外一方，id为&lt;G-唤醒方&gt;的协程后续执行唤醒，在<code>Condition()</code>函数实现</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Condition</span>(<span style="color:#a6e22e">sig</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">signal</span>, <span style="color:#a6e22e">gid</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">mutx</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Mutex</span>, <span style="color:#a6e22e">cd</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Cond</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">mutx</span>.<span style="color:#a6e22e">Lock</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>() {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#a6e22e">gid</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; 执行defer()\n&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">mutx</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>	}()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#a6e22e">gid</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; do something...\n&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">sig</span>.<span style="color:#a6e22e">ready</span> = <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#a6e22e">gid</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;旋转开关，唤醒等待方...\n&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">cd</span>.<span style="color:#a6e22e">Signal</span>()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="主函数代码">主函数代码</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 协程通信信号
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">signal</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 用于wait()条件的检测
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ready</span> <span style="color:#66d9ef">bool</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 构建互斥共享变量
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">mtx</span> <span style="color:#f92672">:=</span> new(<span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Mutex</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">cond</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">NewCond</span>(<span style="color:#a6e22e">mtx</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">signal</span> <span style="color:#f92672">:=</span> new(<span style="color:#a6e22e">signal</span>)
</span></span><span style="display:flex;"><span>	
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">ForWhileSignal</span>(<span style="color:#a6e22e">signal</span>, <span style="color:#e6db74">&#34;G-等待方&#34;</span>, <span style="color:#a6e22e">mtx</span>, <span style="color:#a6e22e">cond</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">100</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">Condition</span>(<span style="color:#a6e22e">signal</span>, <span style="color:#e6db74">&#34;G-唤醒方&#34;</span>, <span style="color:#a6e22e">mtx</span>, <span style="color:#a6e22e">cond</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="输出示例">输出示例：</h4>
<pre tabindex="0"><code>2021/05/15 23:25:54 G-等待方 等待唤醒...
2021/05/15 23:25:54 G-唤醒方 do something...
2021/05/15 23:25:57 G-唤醒方 旋转开关，唤醒等待方...
2021/05/15 23:25:57 G-唤醒方 执行defer()
2021/05/15 23:25:57 G-等待方 被叫醒!
2021/05/15 23:25:57 G-等待方 执行defer()
</code></pre><h4 id="程序时序图">程序时序图</h4>
<p>完整的流程图如下，Wait()会把当前协程加入等待队列，等待由相同cond实例持有者进行唤醒。</p>
<h2 id="wait-signalhttpspixelpig-1253685321cosap-guangzhoumyqcloudcomblogwait-signalpng"><img src="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/blog/wait-signal.png" alt="wait-signal"></h2>
<h3 id="实现">实现</h3>
<p>根据上面的原生API，可以利用唤醒机制着手连接池的实现。</p>
<h4 id="定义连接池">定义连接池</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Pool</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#f92672">*</span><span style="color:#a6e22e">Option</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">idle</span>    <span style="color:#f92672">*</span><span style="color:#a6e22e">list</span>.<span style="color:#a6e22e">List</span>  <span style="color:#75715e">// 空闲队列(双向)链表
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">actives</span> <span style="color:#66d9ef">int</span>         <span style="color:#75715e">// 总连接数
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">mtx</span>     <span style="color:#f92672">*</span><span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Mutex</span> <span style="color:#75715e">// 同步锁
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">cond</span>    <span style="color:#f92672">*</span><span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Cond</span>  <span style="color:#75715e">// 用于阻塞/唤醒
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span></code></pre></div><h4 id="创建连接">创建连接</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// NewPool 创建连接池,初始化连接队列,更新队列大小
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewPool</span>(<span style="color:#a6e22e">opt</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Option</span>) (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Pool</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">idle</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">list</span>.<span style="color:#a6e22e">New</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">conn</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Conn</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">opt</span>.<span style="color:#a6e22e">size</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">NewConn</span>(<span style="color:#a6e22e">opt</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 加入队列
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#a6e22e">idle</span>.<span style="color:#a6e22e">PushBack</span>(<span style="color:#a6e22e">conn</span>)
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// whether close all idle conn when one of err occurs?
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// mutex用于隔离临界区
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">mutx</span> <span style="color:#f92672">:=</span> new(<span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Mutex</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// cond用于唤醒/等待当前函数块
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">cond</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">NewCond</span>(<span style="color:#a6e22e">mutx</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">p</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Pool</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">opt</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">idle</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">idle</span>.<span style="color:#a6e22e">Len</span>(),
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">mutx</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">cond</span>,
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="获取连接">获取连接</h4>
<p>获取连接本质上是对空闲列表的分支判断，其中连接池共享成员mtx的<code>wait()</code>函数是关键点。<br>
结合前面的例子，当++连接池没有可用连接并且连接数上限已满时候++，即当for条件不成立时，程序会唤醒当前函数栈。</p>
<p>这里可以简单理解为唤醒其他协程需要的前提是：</p>
<ol>
<li>cond实例<code>wait()</code>前面的for循环条件，即连接池空闲数大于0，或者连接数小于上限的条件被打破</li>
<li>在归还连接时候，也就是<code>put()</code>函数的cond实例显示调用了<code>Signal()</code></li>
</ol>
<p><strong>详细实现：</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	Get 获取连接:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	空闲列表是否有库存:
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		- 没有
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">			- 连接数是否达到上限
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">				- 是, 解锁, 阻塞等待唤醒
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">				- 否, 创建连接
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">		- 从队头出队获取
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Pool</span>) <span style="color:#a6e22e">Get</span>() (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">mtx</span>.<span style="color:#a6e22e">Lock</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">mtx</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 如果当前活跃大于限制数量, 阻塞等待
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">idle</span>.<span style="color:#a6e22e">Len</span>() <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">actives</span> <span style="color:#f92672">&gt;=</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">size</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#e6db74">&#34;idle size full, blocking...&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 让出使用权并且释放mutex锁，当for条件不成立会自动唤醒
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">cond</span>.<span style="color:#a6e22e">Wait</span>()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 空闲列表如果有且连接, 则从空闲队头获取
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">idle</span>.<span style="color:#a6e22e">Len</span>() &gt; <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">c</span> = <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">idle</span>.<span style="color:#a6e22e">Remove</span>(<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">idle</span>.<span style="color:#a6e22e">Front</span>()).(<span style="color:#f92672">*</span><span style="color:#a6e22e">Conn</span>)
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#75715e">// 创建连接
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">NewConn</span>(<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Option</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">actives</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="归还连接">归还连接</h4>
<p>归还连接需要注意判断连接是否健康，如果异常则不能归还连接池，并更新活跃连接数。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  Put() 归还连接
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  - 连接是否异常
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	- 是, 关闭异常连接
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">	- 否, 归还连接至队尾
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">  - 更新占用连接数, 唤醒等待方
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">*/</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Pool</span>) <span style="color:#a6e22e">Put</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">mtx</span>.<span style="color:#a6e22e">Lock</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">mtx</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>	    <span style="color:#75715e">// 如果当前连接异常，执行关闭
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>	    <span style="color:#75715e">// 健康连接放入队尾
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">idle</span>.<span style="color:#a6e22e">PushBack</span>(<span style="color:#a6e22e">c</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">actives</span><span style="color:#f92672">--</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 唤醒等待队列
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">cond</span>.<span style="color:#a6e22e">Signal</span>()
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="示例程序">示例程序</h4>
<p>至此，一个基本的连接池操作就实现了，下面我们开始测试。</p>
<p>创建一个初始化5个连接的连接池，并启用10个协程并发进行连接交互。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">opt</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Option</span>{
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">addr</span>:        <span style="color:#e6db74">&#34;127.0.0.1:3000&#34;</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 初始化5个连接
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">size</span>:        <span style="color:#ae81ff">5</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">readTimeout</span>: <span style="color:#ae81ff">30</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">dialTimeout</span>: <span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>,
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">keepAlive</span>:   <span style="color:#ae81ff">30</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>,
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestNewPool</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">pool</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewPool</span>(<span style="color:#a6e22e">opt</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">10</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">id</span> <span style="color:#66d9ef">int</span>) {
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">SendInPool</span>(<span style="color:#a6e22e">pool</span>, <span style="color:#e6db74">&#34;Uid-&#34;</span><span style="color:#f92672">+</span><span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Itoa</span>(<span style="color:#a6e22e">id</span>)); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>				<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#e6db74">&#34;Send in pool err: &#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>			}
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">// 注意闭包的id传入值
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>		}(<span style="color:#a6e22e">i</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// just holding
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">SendInPool</span>(<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Pool</span>, <span style="color:#a6e22e">uid</span> <span style="color:#66d9ef">string</span>) (<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Conn</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Get</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Put</span>(<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">msg</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">body</span>.<span style="color:#a6e22e">Message</span>{<span style="color:#a6e22e">Uid</span>: <span style="color:#a6e22e">uid</span>, <span style="color:#a6e22e">Val</span>: <span style="color:#e6db74">&#34;pixelpig!&#34;</span>}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">rec</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Send</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">msg</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>	} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#a6e22e">uid</span>, <span style="color:#e6db74">&#34;, Msg: &#34;</span>, <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">rec</span>)
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><strong>输出示例：</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#f92672">==</span>= <span style="color:#a6e22e">RUN</span>   <span style="color:#a6e22e">TestNewPool</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2021</span><span style="color:#f92672">/</span><span style="color:#ae81ff">05</span><span style="color:#f92672">/</span><span style="color:#ae81ff">17</span> <span style="color:#ae81ff">01</span>:<span style="color:#ae81ff">22</span>:<span style="color:#ae81ff">59</span> <span style="color:#a6e22e">idle</span> <span style="color:#a6e22e">size</span> <span style="color:#a6e22e">full</span>, <span style="color:#a6e22e">blocking</span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2021</span><span style="color:#f92672">/</span><span style="color:#ae81ff">05</span><span style="color:#f92672">/</span><span style="color:#ae81ff">17</span> <span style="color:#ae81ff">01</span>:<span style="color:#ae81ff">22</span>:<span style="color:#ae81ff">59</span> <span style="color:#a6e22e">idle</span> <span style="color:#a6e22e">size</span> <span style="color:#a6e22e">full</span>, <span style="color:#a6e22e">blocking</span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2021</span><span style="color:#f92672">/</span><span style="color:#ae81ff">05</span><span style="color:#f92672">/</span><span style="color:#ae81ff">17</span> <span style="color:#ae81ff">01</span>:<span style="color:#ae81ff">22</span>:<span style="color:#ae81ff">59</span> <span style="color:#a6e22e">idle</span> <span style="color:#a6e22e">size</span> <span style="color:#a6e22e">full</span>, <span style="color:#a6e22e">blocking</span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2021</span><span style="color:#f92672">/</span><span style="color:#ae81ff">05</span><span style="color:#f92672">/</span><span style="color:#ae81ff">17</span> <span style="color:#ae81ff">01</span>:<span style="color:#ae81ff">22</span>:<span style="color:#ae81ff">59</span> <span style="color:#a6e22e">idle</span> <span style="color:#a6e22e">size</span> <span style="color:#a6e22e">full</span>, <span style="color:#a6e22e">blocking</span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2021</span><span style="color:#f92672">/</span><span style="color:#ae81ff">05</span><span style="color:#f92672">/</span><span style="color:#ae81ff">17</span> <span style="color:#ae81ff">01</span>:<span style="color:#ae81ff">22</span>:<span style="color:#ae81ff">59</span> <span style="color:#a6e22e">idle</span> <span style="color:#a6e22e">size</span> <span style="color:#a6e22e">full</span>, <span style="color:#a6e22e">blocking</span><span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2021</span><span style="color:#f92672">/</span><span style="color:#ae81ff">05</span><span style="color:#f92672">/</span><span style="color:#ae81ff">17</span> <span style="color:#ae81ff">01</span>:<span style="color:#ae81ff">22</span>:<span style="color:#ae81ff">59</span> <span style="color:#a6e22e">Uid</span><span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>, <span style="color:#a6e22e">Msg</span>: <span style="color:#a6e22e">ts</span>(<span style="color:#a6e22e">ns</span>): <span style="color:#ae81ff">1621185779673605400</span>, <span style="color:#a6e22e">server</span>: <span style="color:#a6e22e">hello</span>, <span style="color:#a6e22e">pixelpig</span>!
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2021</span><span style="color:#f92672">/</span><span style="color:#ae81ff">05</span><span style="color:#f92672">/</span><span style="color:#ae81ff">17</span> <span style="color:#ae81ff">01</span>:<span style="color:#ae81ff">22</span>:<span style="color:#ae81ff">59</span> <span style="color:#a6e22e">Uid</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">Msg</span>: <span style="color:#a6e22e">ts</span>(<span style="color:#a6e22e">ns</span>): <span style="color:#ae81ff">1621185779673605400</span>, <span style="color:#a6e22e">server</span>: <span style="color:#a6e22e">hello</span>, <span style="color:#a6e22e">pixelpig</span>!
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2021</span><span style="color:#f92672">/</span><span style="color:#ae81ff">05</span><span style="color:#f92672">/</span><span style="color:#ae81ff">17</span> <span style="color:#ae81ff">01</span>:<span style="color:#ae81ff">22</span>:<span style="color:#ae81ff">59</span> <span style="color:#a6e22e">Uid</span><span style="color:#f92672">-</span><span style="color:#ae81ff">6</span>, <span style="color:#a6e22e">Msg</span>: <span style="color:#a6e22e">ts</span>(<span style="color:#a6e22e">ns</span>): <span style="color:#ae81ff">1621185779673605400</span>, <span style="color:#a6e22e">server</span>: <span style="color:#a6e22e">hello</span>, <span style="color:#a6e22e">pixelpig</span>!
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2021</span><span style="color:#f92672">/</span><span style="color:#ae81ff">05</span><span style="color:#f92672">/</span><span style="color:#ae81ff">17</span> <span style="color:#ae81ff">01</span>:<span style="color:#ae81ff">22</span>:<span style="color:#ae81ff">59</span> <span style="color:#a6e22e">Uid</span><span style="color:#f92672">-</span><span style="color:#ae81ff">9</span>, <span style="color:#a6e22e">Msg</span>: <span style="color:#a6e22e">ts</span>(<span style="color:#a6e22e">ns</span>): <span style="color:#ae81ff">1621185779672609700</span>, <span style="color:#a6e22e">server</span>: <span style="color:#a6e22e">hello</span>, <span style="color:#a6e22e">pixelpig</span>!
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2021</span><span style="color:#f92672">/</span><span style="color:#ae81ff">05</span><span style="color:#f92672">/</span><span style="color:#ae81ff">17</span> <span style="color:#ae81ff">01</span>:<span style="color:#ae81ff">22</span>:<span style="color:#ae81ff">59</span> <span style="color:#a6e22e">Uid</span><span style="color:#f92672">-</span><span style="color:#ae81ff">3</span>, <span style="color:#a6e22e">Msg</span>: <span style="color:#a6e22e">ts</span>(<span style="color:#a6e22e">ns</span>): <span style="color:#ae81ff">1621185779673605400</span>, <span style="color:#a6e22e">server</span>: <span style="color:#a6e22e">hello</span>, <span style="color:#a6e22e">pixelpig</span>!
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2021</span><span style="color:#f92672">/</span><span style="color:#ae81ff">05</span><span style="color:#f92672">/</span><span style="color:#ae81ff">17</span> <span style="color:#ae81ff">01</span>:<span style="color:#ae81ff">22</span>:<span style="color:#ae81ff">59</span> <span style="color:#a6e22e">Uid</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">Msg</span>: <span style="color:#a6e22e">ts</span>(<span style="color:#a6e22e">ns</span>): <span style="color:#ae81ff">1621185779690594100</span>, <span style="color:#a6e22e">server</span>: <span style="color:#a6e22e">hello</span>, <span style="color:#a6e22e">pixelpig</span>!
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2021</span><span style="color:#f92672">/</span><span style="color:#ae81ff">05</span><span style="color:#f92672">/</span><span style="color:#ae81ff">17</span> <span style="color:#ae81ff">01</span>:<span style="color:#ae81ff">22</span>:<span style="color:#ae81ff">59</span> <span style="color:#a6e22e">Uid</span><span style="color:#f92672">-</span><span style="color:#ae81ff">8</span>, <span style="color:#a6e22e">Msg</span>: <span style="color:#a6e22e">ts</span>(<span style="color:#a6e22e">ns</span>): <span style="color:#ae81ff">1621185779690594100</span>, <span style="color:#a6e22e">server</span>: <span style="color:#a6e22e">hello</span>, <span style="color:#a6e22e">pixelpig</span>!
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2021</span><span style="color:#f92672">/</span><span style="color:#ae81ff">05</span><span style="color:#f92672">/</span><span style="color:#ae81ff">17</span> <span style="color:#ae81ff">01</span>:<span style="color:#ae81ff">22</span>:<span style="color:#ae81ff">59</span> <span style="color:#a6e22e">Uid</span><span style="color:#f92672">-</span><span style="color:#ae81ff">5</span>, <span style="color:#a6e22e">Msg</span>: <span style="color:#a6e22e">ts</span>(<span style="color:#a6e22e">ns</span>): <span style="color:#ae81ff">1621185779690594100</span>, <span style="color:#a6e22e">server</span>: <span style="color:#a6e22e">hello</span>, <span style="color:#a6e22e">pixelpig</span>!
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2021</span><span style="color:#f92672">/</span><span style="color:#ae81ff">05</span><span style="color:#f92672">/</span><span style="color:#ae81ff">17</span> <span style="color:#ae81ff">01</span>:<span style="color:#ae81ff">22</span>:<span style="color:#ae81ff">59</span> <span style="color:#a6e22e">Uid</span><span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>, <span style="color:#a6e22e">Msg</span>: <span style="color:#a6e22e">ts</span>(<span style="color:#a6e22e">ns</span>): <span style="color:#ae81ff">1621185779690594100</span>, <span style="color:#a6e22e">server</span>: <span style="color:#a6e22e">hello</span>, <span style="color:#a6e22e">pixelpig</span>!
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">2021</span><span style="color:#f92672">/</span><span style="color:#ae81ff">05</span><span style="color:#f92672">/</span><span style="color:#ae81ff">17</span> <span style="color:#ae81ff">01</span>:<span style="color:#ae81ff">22</span>:<span style="color:#ae81ff">59</span> <span style="color:#a6e22e">Uid</span><span style="color:#f92672">-</span><span style="color:#ae81ff">7</span>, <span style="color:#a6e22e">Msg</span>: <span style="color:#a6e22e">ts</span>(<span style="color:#a6e22e">ns</span>): <span style="color:#ae81ff">1621185779690594100</span>, <span style="color:#a6e22e">server</span>: <span style="color:#a6e22e">hello</span>, <span style="color:#a6e22e">pixelpig</span>!
</span></span></code></pre></div><p>可以看到程序输出符合预期，因为连接池大小只有5，所以并发10个连接大概率会有5个连接需要等待排队，因此如上输出有5个协程在队列等待(blocking)。</p>
<h3 id="拓展">拓展</h3>
<p>以上是维护一个TCP连接池的简单示例，还有比较常见的Redis/Kafka等数据库连接等，本质上都是TCP连接。<br>
虽然引入连接池增加了维护成本，需要注意临界区的读写冲突，连接池大小控制等，但是可以有效减少频繁的连接创建。<br>
此外，上述例子使用的是Go内置的双向队列维护多个连接，其实还有一种更加优雅的实现，就是利用Go的通道原生特性“阻塞与唤醒”，具体可参考《Go语言实战》连接池的代码。</p>
<p>这里缓冲的是任意Closer实例，通用性更高，部分代码如下：</p>
<h4 id="连接池结构">连接池结构</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Pool</span> <span style="color:#66d9ef">struct</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">m</span>        <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Mutex</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//可以管理任意实现了Closer接口的资源类型
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">resource</span> <span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">Closer</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">maxSize</span>  <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">usedSize</span> <span style="color:#66d9ef">int</span>
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 构建连接的工厂函数，返回实现io.Closer的实例
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#a6e22e">factory</span>  <span style="color:#66d9ef">func</span>() (<span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">Closer</span>, <span style="color:#66d9ef">error</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">closed</span>   <span style="color:#66d9ef">bool</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>其中用于通信的通道类型是<code>io.Closer</code>，经常能在框架中看到一个用于检验接口实现类是否完整实现了接口的方式，</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">// 如果Conn没有实现io.Closer接口，则编译器会提示：
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Cannot use &#39;new(Conn)&#39; (type *Conn) as type io.Closer 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">// Type does not implement &#39;io.Closer&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">Closer</span> = new(<span style="color:#a6e22e">Conn</span>)
</span></span></code></pre></div><p>下面是相关代码：</p>
<h4 id="获取连接-1">获取连接</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#75715e">//get resource
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Pool</span>) <span style="color:#a6e22e">Acquire</span>() (<span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">Closer</span>, <span style="color:#66d9ef">error</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Lock</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">select</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">// 有闲置连接则取出
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">r</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">resource</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Acquire:&#34;</span>, <span style="color:#e6db74">&#34;Shard Resource&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">//管道已经关闭
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">ErrPoolClosed</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">r</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">default</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">usedSize</span> &lt; <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">maxSize</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">usedSize</span><span style="color:#f92672">++</span>
</span></span><span style="display:flex;"><span>			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Acquire:&#34;</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;New Resource.&#34;</span> <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>				<span style="color:#e6db74">&#34;resource present size/max: %d/%d\n&#34;</span>, <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">usedSize</span>, <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">maxSize</span>)
</span></span><span style="display:flex;"><span>			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">factory</span>()
</span></span><span style="display:flex;"><span>		} <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>			<span style="color:#75715e">//log.Printf(&#34;Acquire:&#34; +
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#75715e">//	&#34;block for pool&#39;s dry, present size: %d/%d&#34;, p.usedSize, p.maxSize)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>		}
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="释放并归还连接">释放并归还连接</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-go" data-lang="go"><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Pool</span>) <span style="color:#a6e22e">Release</span>(<span style="color:#a6e22e">r</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">Closer</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Lock</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Unlock</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">closed</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">usedSize</span><span style="color:#f92672">--</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">select</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//资源放回队列
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">resource</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">r</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Release:&#34;</span>, <span style="color:#e6db74">&#34;into queue&#34;</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#75715e">//队列满的情况关闭资源
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	<span style="color:#66d9ef">default</span>:
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Release:&#34;</span>, <span style="color:#e6db74">&#34;Closing&#34;</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Close</span>()
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="他山之石">他山之石</h4>
<p>不知读者是否能感觉到，使用Go通道自带的语言特性实现的阻塞与唤醒的通信模型，看起来更加简介且优雅。<br>
相信对Go的并发哲学：“<em>不用通过共享内存来通信，而是通过通信来共享内存</em>”的理解又有更深的体会了。</p>
              


            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">标签</span><br/>
                    
  <a class="tag tag--primary tag--small" href="/zh/tags/tcp/">TCP</a>

  <a class="tag tag--primary tag--small" href="/zh/tags/%E8%BF%9E%E6%8E%A5%E6%B1%A0/">连接池</a>

                  </div>
                
              
            
            
<div class="post-actions-wrap">
  <nav >
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/zh/2021/06/%E8%81%8A%E4%B8%80%E8%81%8Ago%E5%AE%9E%E7%8E%B0%E7%9A%84%E5%A4%9A%E5%8D%8F%E7%A8%8B%E4%B8%8B%E8%BD%BD%E5%99%A8-gopeed-core/" data-tooltip="聊一聊Go实现的多协程下载器: gopeed-core" aria-label="后一篇: 聊一聊Go实现的多协程下载器: gopeed-core">
          
              <i class="fa fa-angle-left"></i>
              <span class="hide-xs hide-sm text-small icon-ml">后一篇</span>
            </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/zh/2021/05/%E8%81%8A%E4%B8%80%E8%81%8Ago%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E4%B8%80--tcp%E9%80%9A%E4%BF%A1/" data-tooltip="聊一聊Go网络编程(一)--TCP通信" aria-label="前一篇: 聊一聊Go网络编程(一)--TCP通信">
          
              <span class="hide-xs hide-sm text-small icon-mr">前一篇</span>
              <i class="fa fa-angle-right"></i>
            </a>
        </li>
      
    </ul>
  </nav>
<ul class="post-actions post-action-share" >
  
  
  <li class="post-action">
    
      <a class="post-action-btn btn btn--default" href="#top" aria-label="回到顶部">
      <i class="fa fa-arrow-up" aria-hidden="true"></i>
    
    </a>
  </li>
</ul>
</div>


            
  


          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2023 <a href="https://github.com/pixeldin">pixeldin</a>. All Rights Reserved
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
        
<div class="post-actions-wrap">
  <nav >
    <ul class="post-actions post-action-nav">
      
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/zh/2021/06/%E8%81%8A%E4%B8%80%E8%81%8Ago%E5%AE%9E%E7%8E%B0%E7%9A%84%E5%A4%9A%E5%8D%8F%E7%A8%8B%E4%B8%8B%E8%BD%BD%E5%99%A8-gopeed-core/" data-tooltip="聊一聊Go实现的多协程下载器: gopeed-core" aria-label="后一篇: 聊一聊Go实现的多协程下载器: gopeed-core">
          
              <i class="fa fa-angle-left"></i>
              <span class="hide-xs hide-sm text-small icon-ml">后一篇</span>
            </a>
        </li>
        <li class="post-action">
          
            <a class="post-action-btn btn btn--default tooltip--top" href="/zh/2021/05/%E8%81%8A%E4%B8%80%E8%81%8Ago%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B%E4%B8%80--tcp%E9%80%9A%E4%BF%A1/" data-tooltip="聊一聊Go网络编程(一)--TCP通信" aria-label="前一篇: 聊一聊Go网络编程(一)--TCP通信">
          
              <span class="hide-xs hide-sm text-small icon-mr">前一篇</span>
              <i class="fa fa-angle-right"></i>
            </a>
        </li>
      
    </ul>
  </nav>
<ul class="post-actions post-action-share" >
  
  
  <li class="post-action">
    
      <a class="post-action-btn btn btn--default" href="#top" aria-label="回到顶部">
      <i class="fa fa-arrow-up" aria-hidden="true"></i>
    
    </a>
  </li>
</ul>
</div>


      </div>
      

    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-times"></i>
    </div>
    
      <img id="about-card-picture" src="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/pig.jpg" alt="作者的图片" />
    
    <h4 id="about-card-name">pixelpig</h4>
    
      <div id="about-card-bio">With enthusiasm for open source and I am looking forward to be a better developer. Stay hungry, stay foolish <strong>:）</strong></div>
    
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker-alt"></i>
        <br/>
        GuangDong - CHINA
      </div>
    
  </div>
</div>

    

    
  
    <div id="cover" style="background-image:url('https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/cover.jpg');"></div>
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.1.0/highlight.min.js" integrity="sha512-z+/WWfyD5tccCukM4VvONpEtLmbAm5LDu7eKiyMQJ9m7OfPEDL7gENyDRL3Yfe8XAuGsS2fS4xSMnl6d30kqGQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha512-uURl+ZXMBrF4AwGaWmEetzrd+J5/8NRkWAvJx5sbPSSuOb0bZLqf+tOzniObO00BjHa/dD7gub9oCGMLPQHtQA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


<script src="/js/script-1zdg58d80rvvnb0viabadlivdd03cwll0zhobn8d3xl8weau7iwypjdnclx.min.js"></script>



<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>




    
  </body>
</html>

