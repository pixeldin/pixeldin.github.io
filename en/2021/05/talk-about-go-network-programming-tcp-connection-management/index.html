<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.80.0 with theme Tranquilpeak 0.4.8-BETA">
<meta name="author" content="pixelpig">
<meta name="keywords" content="">
<meta name="description" content="In the last article, we talked about how to initiate a TCP connection in Go, and listed a full-duplex demo. Today, we will talk about connection pool management further.">


<meta property="og:description" content="In the last article, we talked about how to initiate a TCP connection in Go, and listed a full-duplex demo. Today, we will talk about connection pool management further.">
<meta property="og:type" content="article">
<meta property="og:title" content="Talk about Go: Network programming--TCP Connection Management">
<meta name="twitter:title" content="Talk about Go: Network programming--TCP Connection Management">
<meta property="og:url" content="/en/2021/05/talk-about-go-network-programming-tcp-connection-management/">
<meta property="twitter:url" content="/en/2021/05/talk-about-go-network-programming-tcp-connection-management/">
<meta property="og:site_name" content="pixelpig - tech">
<meta property="og:description" content="In the last article, we talked about how to initiate a TCP connection in Go, and listed a full-duplex demo. Today, we will talk about connection pool management further.">
<meta name="twitter:description" content="In the last article, we talked about how to initiate a TCP connection in Go, and listed a full-duplex demo. Today, we will talk about connection pool management further.">
<meta property="og:locale" content="en">

  
    <meta property="article:published_time" content="2021-05-16T00:00:00">
  
  
    <meta property="article:modified_time" content="2021-05-16T00:00:00">
  
  
  
    
      <meta property="article:section" content="Go">
    
      <meta property="article:section" content="Network">
    
      <meta property="article:section" content="TCP">
    
  
  
    
      <meta property="article:tag" content="Talk about Go">
    
  


<meta name="twitter:card" content="summary">

  <meta name="twitter:site" content="@pixelpigpigpig">


  <meta name="twitter:creator" content="@pixelpigpigpig">










  <meta property="og:image" content="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/pig.jpg">
  <meta property="twitter:image" content="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/pig.jpg">


    <title>Talk about Go: Network programming--TCP Connection Management</title>

    <link rel="icon" href="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/blog/static/pixel.ico">
    

    

    <link rel="canonical" href="/en/2021/05/talk-about-go-network-programming-tcp-connection-management/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.min.css" integrity="sha256-vuXZ9LGmmwtjqFX1F+EKin1ThZMub58gKULUyf0qECk=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.css" integrity="sha256-SEa4XYAHihTcEP1f5gARTB2K26Uk8PsndQYHQC1f4jU=" crossorigin="anonymous" />
    
    
    <link rel="stylesheet" href="/css/style-twzjdbqhmnnacqs0pwwdzcdbt8yhv8giawvjqjmyfoqnvazl0dalmnhdkvp7.min.css" />
    
    

    
      
    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="5">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="/en/">pixelpig - tech</a>
  </div>
  
    
      <a class="header-right-picture "
         href="/#about">
    
    
    
      
        <img class="header-picture" src="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/pig.jpg" alt="Author&#39;s picture" />
      
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="5">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="/#about">
          <img class="sidebar-profile-picture" src="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/pig.jpg" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">pixelpig</h4>
        
          <h5 class="sidebar-profile-bio">a backend development living in GD, China. Stay hungry, stay foolish <strong>:）</strong></h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/zh">
    
      <i class="sidebar-button-icon fa fa-lg fa-language"></i>
      
      <span class="sidebar-button-desc">简/中</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/en/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/en/categories">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/en/tags">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/en/archives">
    
      <i class="sidebar-button-icon fa fa-lg fa-archive"></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/en/#about">
    
      <i class="sidebar-button-icon fa fa-lg fa-question"></i>
      
      <span class="sidebar-button-desc">About me</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://twitter.com/pixelpigpigpig/" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-twitter"></i>
      
      <span class="sidebar-button-desc">Twitter</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="5"
        class="
               hasCoverMetaIn
               ">
        <article class="post" itemscope itemType="http://schema.org/BlogPosting">
          
          
            <div class="post-header main-content-wrap text-left">
  
    <h1 class="post-title" itemprop="headline">
      Talk about Go: Network programming--TCP Connection Management
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time itemprop="datePublished" datetime="2021-05-16T00:00:00Z">
        
  May 16, 2021

      </time>
    
    
  
  
    <span>in</span>
    
      <a class="category-link" href="/en/categories/go">Go</a>, 
    
      <a class="category-link" href="/en/categories/network">Network</a>, 
    
      <a class="category-link" href="/en/categories/tcp">TCP</a>
    
  

  </div>

</div>
          
          <div class="post-content markdown" itemprop="articleBody">
            <div class="main-content-wrap">
              <p>In the last article, we talked about how to initiate a TCP connection in Go, and listed a full-duplex demo. Today, we will talk about connection pool management further.</p>
<h3 id="foreword">Foreword</h3>
<p>As mentioned in the previous section, a three-way handshake is required for each tcp establishment of a computer connection. In order to avoid frequent creation and destruction and maintain the activity of the connection, the keepalive api is introduced. However, keepalive only tells the tcp link when it is idle. For detection (different from HTTP), if we want to really reuse connections, we can use connection pooling, as shown in the following example.
<img src="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/blog/tcp-pool/EN-conn-pool.png" alt="tcp-pool"></p>
<h3 id="features">Features</h3>
<p>What characteristics should a connection pool have?</p>
<ol>
<li>Consumers can get connections from the pool</li>
<li>The connection can be returned when used up</li>
<li>There is an upper limit on the number of connections to avoid frequent creation and low connection reuse rate</li>
<li>Remediate unhealthy connections (close connections) and decrement the number of active connections by one</li>
</ol>
<h3 id="edge-case">Edge Case</h3>
<p>In addition to satisfying the common operations of connection pools, we need to consider what if the number of connections reaches the upper limit and there are no idle connections. Here, we can use the native <code>sync</code> package <code>Mutex</code> that comes with Go. <strong>Yield</strong>&quot; function, similar to <strong>Java</strong>&rsquo;s <code>yield()</code> method, releases the current mutex, and waits for the return of other connections to trigger the condition and <strong>wake</strong>.</p>
<h4 id="step-by-step">Step By Step</h4>
<p>Let&rsquo;s use an example to implement wait and wake up. Here we are mainly familiar with the usage of <code>wait()</code> and <code>Signal()</code> functions.</p>
<ul>
<li>wait()<br>
When <code>wait()</code> executes, it does two things:
<ol>
<li>Release the currently bound mutex. The source code executes <code>c.L.Unlock()</code>, so it will not block the long-term occupied resources, and will release it to other coroutines to wake up.</li>
<li>Add the coroutine where the current function is located to the queue waiting to wake up</li>
</ol>
</li>
<li>Signal()<br>
There are two trigger conditions to wake up a waiting coroutine:
<ol>
<li>The same mutex cond instance executes the <code>Signal()</code> function</li>
<li>The <code>for{}</code> condition waiting before the <code>wait()</code> function is broken</li>
</ol>
</li>
</ul>
<p><strong>Code example</strong><br>
Here we use two coroutines, the coroutine whose id is <!-- raw HTML omitted --> executes first, and releases the mutex when the condition is not allowed, and waits for wake-up, which is implemented in the function <code>ForWhileSignal()</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">ForWhileSignal</span>(<span style="color:#a6e22e">sig</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">signal</span>, <span style="color:#a6e22e">gid</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">mutx</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Mutex</span>, <span style="color:#a6e22e">cd</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Cond</span>) {
	<span style="color:#a6e22e">mutx</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#a6e22e">gid</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; execute defer()\n&#34;</span>)
		<span style="color:#a6e22e">mutx</span>.<span style="color:#a6e22e">Unlock</span>()
	}()

    <span style="color:#75715e">// wail till condition break
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> !<span style="color:#a6e22e">sig</span>.<span style="color:#a6e22e">ready</span> {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#a6e22e">gid</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;wait for notify...\n&#34;</span>)
		<span style="color:#a6e22e">cd</span>.<span style="color:#a6e22e">Wait</span>()
	}

	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#a6e22e">gid</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; notify! \n&#34;</span>)
}
</code></pre></div><p>the other side, id as <!-- raw HTML omitted --> will wakes the waiting side up, which is implemented in the <code>Condition()</code> function</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Condition</span>(<span style="color:#a6e22e">sig</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">signal</span>, <span style="color:#a6e22e">gid</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">mutx</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Mutex</span>, <span style="color:#a6e22e">cd</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Cond</span>) {
	<span style="color:#a6e22e">mutx</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#66d9ef">func</span>() {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#a6e22e">gid</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; defer()\n&#34;</span>)
		<span style="color:#a6e22e">mutx</span>.<span style="color:#a6e22e">Unlock</span>()
	}()

	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#a6e22e">gid</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; do something...\n&#34;</span>)
	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">3</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
	<span style="color:#a6e22e">sig</span>.<span style="color:#a6e22e">ready</span> = <span style="color:#66d9ef">true</span>
	<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#a6e22e">gid</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;Rotary switch to wake up waiting side...\n&#34;</span>)
	<span style="color:#a6e22e">cd</span>.<span style="color:#a6e22e">Signal</span>()
}
</code></pre></div><h4 id="main-function">Main function</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">signal</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">// detection of wait() conditions
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ready</span> <span style="color:#66d9ef">bool</span>
}
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
	<span style="color:#a6e22e">mtx</span> <span style="color:#f92672">:=</span> new(<span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Mutex</span>)
	<span style="color:#a6e22e">cond</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">NewCond</span>(<span style="color:#a6e22e">mtx</span>)
	<span style="color:#a6e22e">signal</span> <span style="color:#f92672">:=</span> new(<span style="color:#a6e22e">signal</span>)
	
	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">ForWhileSignal</span>(<span style="color:#a6e22e">signal</span>, <span style="color:#e6db74">&#34;G-waiting&#34;</span>, <span style="color:#a6e22e">mtx</span>, <span style="color:#a6e22e">cond</span>)
	<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">100</span>)
	<span style="color:#66d9ef">go</span> <span style="color:#a6e22e">Condition</span>(<span style="color:#a6e22e">signal</span>, <span style="color:#e6db74">&#34;G-notify&#34;</span>, <span style="color:#a6e22e">mtx</span>, <span style="color:#a6e22e">cond</span>)

	<span style="color:#66d9ef">for</span> {
		<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">1</span>)
	}
}
</code></pre></div><h4 id="output-example">Output example：</h4>
<pre><code>2021/05/15 23:25:54 G-waiting wait for notify......
2021/05/15 23:25:54 G-notify do something...
2021/05/15 23:25:57 G-notify Rotary switch to wake up waiting side...
2021/05/15 23:25:57 G-notify defer()
2021/05/15 23:25:57 G-waiting notify!
2021/05/15 23:25:57 G-waiting defer()
</code></pre><h4 id="timing-diagram">Timing diagram</h4>
<p>The complete flow chart is as follows, wait() will add the current coroutine to the waiting queue, waiting for the same cond instance holder to wake up.</p>
<p><img src="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/blog/wait-signal.png" alt="wait-signal"></p>
<hr>
<h3 id="gets-hands-dirty">Get&rsquo;s hands dirty</h3>
<p>According to the above native API, the implementation of the connection pool can be started by using the wake-up mechanism.</p>
<h4 id="define">Define</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Pool</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#f92672">*</span><span style="color:#a6e22e">Option</span>
	<span style="color:#a6e22e">idle</span>    <span style="color:#f92672">*</span><span style="color:#a6e22e">list</span>.<span style="color:#a6e22e">List</span>  <span style="color:#75715e">// free queue (doubly) linked list
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">actives</span> <span style="color:#66d9ef">int</span>         <span style="color:#75715e">// total connections
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">mtx</span>     <span style="color:#f92672">*</span><span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Mutex</span> 
	<span style="color:#a6e22e">cond</span>    <span style="color:#f92672">*</span><span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Cond</span>  <span style="color:#75715e">// for blocking/awakening
</span><span style="color:#75715e"></span>}
</code></pre></div><h4 id="create-a-connection">Create a connection</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// initialize connection queue, update queue size
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewPool</span>(<span style="color:#a6e22e">opt</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Option</span>) (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Pool</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">idle</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">list</span>.<span style="color:#a6e22e">New</span>()
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">conn</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Conn</span>
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#a6e22e">opt</span>.<span style="color:#a6e22e">size</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">NewConn</span>(<span style="color:#a6e22e">opt</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#75715e">// enqueue
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">idle</span>.<span style="color:#a6e22e">PushBack</span>(<span style="color:#a6e22e">conn</span>)
		}
		<span style="color:#75715e">// whether close all idle conn when one of err occurs?
</span><span style="color:#75715e"></span>	}

    <span style="color:#75715e">// mutex use for quarantine area
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">mutx</span> <span style="color:#f92672">:=</span> new(<span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Mutex</span>)
	<span style="color:#75715e">// cond used to wake/wait the current function block
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">cond</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">NewCond</span>(<span style="color:#a6e22e">mutx</span>)

	<span style="color:#a6e22e">p</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Pool</span>{
		<span style="color:#a6e22e">opt</span>,
		<span style="color:#a6e22e">idle</span>,
		<span style="color:#a6e22e">idle</span>.<span style="color:#a6e22e">Len</span>(),
		<span style="color:#a6e22e">mutx</span>,
		<span style="color:#a6e22e">cond</span>,
	}
	<span style="color:#66d9ef">return</span>
}
</code></pre></div><h4 id="get-connected">Get connected</h4>
<p>Getting a connection is essentially a branch judgment on the free list, where the <code>wait()</code> function of the connection pool shared member mtx is the key point.<br>
Combined with the previous example, when the ++ connection pool has no available connections and the upper limit of the number of connections is full, that is, when the for condition does not hold, the program will wake up the current function stack.</p>
<p>This can be simply understood as the premise required to wake up other coroutines:</p>
<ol>
<li>The for loop condition in front of the cond instance <code>wait()</code>, that is, the condition that the idle number of the connection pool is greater than 0, or the condition that the number of connections is less than the upper limit is broken.</li>
<li>When returning the connection, that is, the cond instance of the <code>put()</code> function shows that <code>Signal()</code> is called.</li>
</ol>
<p><strong>Implement detail:</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">/*
</span><span style="color:#75715e">	Get() :
</span><span style="color:#75715e">	Is the free list in idle queue:
</span><span style="color:#75715e">		- no
</span><span style="color:#75715e">			- Whether the number of connections has reached the upper limit
</span><span style="color:#75715e">				- yes, unlocked, blocked waiting to wake up
</span><span style="color:#75715e">				- no, Create a connection
</span><span style="color:#75715e">		- pop from head of the queue
</span><span style="color:#75715e">*/</span>
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Pool</span>) <span style="color:#a6e22e">Get</span>() (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">mtx</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">mtx</span>.<span style="color:#a6e22e">Unlock</span>()
	<span style="color:#75715e">// If the current activity over the limit number, block and wait
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">idle</span>.<span style="color:#a6e22e">Len</span>() <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">actives</span> <span style="color:#f92672">&gt;=</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">size</span> {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#e6db74">&#34;idle size full, blocking...&#34;</span>)
		<span style="color:#75715e">// cancle possessing and release the mutex lock, it will wake up automatically when the for condition does not hold
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">cond</span>.<span style="color:#a6e22e">Wait</span>()
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">idle</span>.<span style="color:#a6e22e">Len</span>() &gt; <span style="color:#ae81ff">0</span> {
		<span style="color:#a6e22e">c</span> = <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">idle</span>.<span style="color:#a6e22e">Remove</span>(<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">idle</span>.<span style="color:#a6e22e">Front</span>()).(<span style="color:#f92672">*</span><span style="color:#a6e22e">Conn</span>)
	} <span style="color:#66d9ef">else</span> {
		<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">NewConn</span>(<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Option</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">actives</span><span style="color:#f92672">++</span>
		}
	}
	<span style="color:#66d9ef">return</span>
}
</code></pre></div><h4 id="return-connection">Return Connection</h4>
<p>Returning the connection requires attention to determine whether the connection is healthy. If it is abnormal, the connection pool cannot be returned, and the number of active connections is updated.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">/*
</span><span style="color:#75715e">  Put() 
</span><span style="color:#75715e">  - Is the connection alive?
</span><span style="color:#75715e">	- no, close it
</span><span style="color:#75715e">	- yes, return link to end of line
</span><span style="color:#75715e">  - Update the number of occupied connections, wake up the waiting side
</span><span style="color:#75715e">*/</span>
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Pool</span>) <span style="color:#a6e22e">Put</span>(<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Conn</span>, <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">mtx</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">mtx</span>.<span style="color:#a6e22e">Unlock</span>()

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Close</span>()
		}
	} <span style="color:#66d9ef">else</span> {
		<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">idle</span>.<span style="color:#a6e22e">PushBack</span>(<span style="color:#a6e22e">c</span>)
	}
	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">actives</span><span style="color:#f92672">--</span>
	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">cond</span>.<span style="color:#a6e22e">Signal</span>()
}
</code></pre></div><h4 id="example">Example</h4>
<p>Let&rsquo;s create a connection pool that initializes 5 connections, and enables 10 coroutines to interact with connections concurrently.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">opt</span> = <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Option</span>{
	<span style="color:#a6e22e">addr</span>:        <span style="color:#e6db74">&#34;127.0.0.1:3000&#34;</span>,
	<span style="color:#a6e22e">size</span>:        <span style="color:#ae81ff">5</span>,
	<span style="color:#a6e22e">readTimeout</span>: <span style="color:#ae81ff">30</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>,
	<span style="color:#a6e22e">dialTimeout</span>: <span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>,
	<span style="color:#a6e22e">keepAlive</span>:   <span style="color:#ae81ff">30</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>,
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">TestNewPool</span>(<span style="color:#a6e22e">t</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">T</span>) {
	<span style="color:#a6e22e">pool</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewPool</span>(<span style="color:#a6e22e">opt</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">t</span>.<span style="color:#a6e22e">Fatal</span>(<span style="color:#a6e22e">err</span>)
	}

	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">i</span> &lt; <span style="color:#ae81ff">10</span>; <span style="color:#a6e22e">i</span><span style="color:#f92672">++</span> {
		<span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">id</span> <span style="color:#66d9ef">int</span>) {
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">SendInPool</span>(<span style="color:#a6e22e">pool</span>, <span style="color:#e6db74">&#34;Uid-&#34;</span><span style="color:#f92672">+</span><span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">Itoa</span>(<span style="color:#a6e22e">id</span>)); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#e6db74">&#34;Send in pool err: &#34;</span>, <span style="color:#a6e22e">err</span>)
			}
		}(<span style="color:#a6e22e">i</span>)
	}

    <span style="color:#75715e">// just holding
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">for</span> {
		<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#ae81ff">1</span>)
	}
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">SendInPool</span>(<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Pool</span>, <span style="color:#a6e22e">uid</span> <span style="color:#66d9ef">string</span>) (<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Conn</span>
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Get</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span>
	}
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">Put</span>(<span style="color:#a6e22e">c</span>, <span style="color:#a6e22e">err</span>)
	<span style="color:#a6e22e">msg</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">body</span>.<span style="color:#a6e22e">Message</span>{<span style="color:#a6e22e">Uid</span>: <span style="color:#a6e22e">uid</span>, <span style="color:#a6e22e">Val</span>: <span style="color:#e6db74">&#34;pixelpig!&#34;</span>}
	<span style="color:#a6e22e">rec</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">Send</span>(<span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Background</span>(), <span style="color:#a6e22e">msg</span>)
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#a6e22e">err</span>)
	} <span style="color:#66d9ef">else</span> {
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Print</span>(<span style="color:#a6e22e">uid</span>, <span style="color:#e6db74">&#34;, Msg: &#34;</span>, <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">rec</span>)
	}
	<span style="color:#66d9ef">return</span>
}
</code></pre></div><p><strong>Output:</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">==</span>= <span style="color:#a6e22e">RUN</span>   <span style="color:#a6e22e">TestNewPool</span>
<span style="color:#ae81ff">2021</span><span style="color:#f92672">/</span><span style="color:#ae81ff">05</span><span style="color:#f92672">/</span><span style="color:#ae81ff">17</span> <span style="color:#ae81ff">01</span>:<span style="color:#ae81ff">22</span>:<span style="color:#ae81ff">59</span> <span style="color:#a6e22e">idle</span> <span style="color:#a6e22e">size</span> <span style="color:#a6e22e">full</span>, <span style="color:#a6e22e">blocking</span><span style="color:#f92672">...</span>
<span style="color:#ae81ff">2021</span><span style="color:#f92672">/</span><span style="color:#ae81ff">05</span><span style="color:#f92672">/</span><span style="color:#ae81ff">17</span> <span style="color:#ae81ff">01</span>:<span style="color:#ae81ff">22</span>:<span style="color:#ae81ff">59</span> <span style="color:#a6e22e">idle</span> <span style="color:#a6e22e">size</span> <span style="color:#a6e22e">full</span>, <span style="color:#a6e22e">blocking</span><span style="color:#f92672">...</span>
<span style="color:#ae81ff">2021</span><span style="color:#f92672">/</span><span style="color:#ae81ff">05</span><span style="color:#f92672">/</span><span style="color:#ae81ff">17</span> <span style="color:#ae81ff">01</span>:<span style="color:#ae81ff">22</span>:<span style="color:#ae81ff">59</span> <span style="color:#a6e22e">idle</span> <span style="color:#a6e22e">size</span> <span style="color:#a6e22e">full</span>, <span style="color:#a6e22e">blocking</span><span style="color:#f92672">...</span>
<span style="color:#ae81ff">2021</span><span style="color:#f92672">/</span><span style="color:#ae81ff">05</span><span style="color:#f92672">/</span><span style="color:#ae81ff">17</span> <span style="color:#ae81ff">01</span>:<span style="color:#ae81ff">22</span>:<span style="color:#ae81ff">59</span> <span style="color:#a6e22e">idle</span> <span style="color:#a6e22e">size</span> <span style="color:#a6e22e">full</span>, <span style="color:#a6e22e">blocking</span><span style="color:#f92672">...</span>
<span style="color:#ae81ff">2021</span><span style="color:#f92672">/</span><span style="color:#ae81ff">05</span><span style="color:#f92672">/</span><span style="color:#ae81ff">17</span> <span style="color:#ae81ff">01</span>:<span style="color:#ae81ff">22</span>:<span style="color:#ae81ff">59</span> <span style="color:#a6e22e">idle</span> <span style="color:#a6e22e">size</span> <span style="color:#a6e22e">full</span>, <span style="color:#a6e22e">blocking</span><span style="color:#f92672">...</span>
<span style="color:#ae81ff">2021</span><span style="color:#f92672">/</span><span style="color:#ae81ff">05</span><span style="color:#f92672">/</span><span style="color:#ae81ff">17</span> <span style="color:#ae81ff">01</span>:<span style="color:#ae81ff">22</span>:<span style="color:#ae81ff">59</span> <span style="color:#a6e22e">Uid</span><span style="color:#f92672">-</span><span style="color:#ae81ff">4</span>, <span style="color:#a6e22e">Msg</span>: <span style="color:#a6e22e">ts</span>(<span style="color:#a6e22e">ns</span>): <span style="color:#ae81ff">1621185779673605400</span>, <span style="color:#a6e22e">server</span>: <span style="color:#a6e22e">hello</span>, <span style="color:#a6e22e">pixelpig</span>!
<span style="color:#ae81ff">2021</span><span style="color:#f92672">/</span><span style="color:#ae81ff">05</span><span style="color:#f92672">/</span><span style="color:#ae81ff">17</span> <span style="color:#ae81ff">01</span>:<span style="color:#ae81ff">22</span>:<span style="color:#ae81ff">59</span> <span style="color:#a6e22e">Uid</span><span style="color:#f92672">-</span><span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">Msg</span>: <span style="color:#a6e22e">ts</span>(<span style="color:#a6e22e">ns</span>): <span style="color:#ae81ff">1621185779673605400</span>, <span style="color:#a6e22e">server</span>: <span style="color:#a6e22e">hello</span>, <span style="color:#a6e22e">pixelpig</span>!
<span style="color:#ae81ff">2021</span><span style="color:#f92672">/</span><span style="color:#ae81ff">05</span><span style="color:#f92672">/</span><span style="color:#ae81ff">17</span> <span style="color:#ae81ff">01</span>:<span style="color:#ae81ff">22</span>:<span style="color:#ae81ff">59</span> <span style="color:#a6e22e">Uid</span><span style="color:#f92672">-</span><span style="color:#ae81ff">6</span>, <span style="color:#a6e22e">Msg</span>: <span style="color:#a6e22e">ts</span>(<span style="color:#a6e22e">ns</span>): <span style="color:#ae81ff">1621185779673605400</span>, <span style="color:#a6e22e">server</span>: <span style="color:#a6e22e">hello</span>, <span style="color:#a6e22e">pixelpig</span>!
<span style="color:#ae81ff">2021</span><span style="color:#f92672">/</span><span style="color:#ae81ff">05</span><span style="color:#f92672">/</span><span style="color:#ae81ff">17</span> <span style="color:#ae81ff">01</span>:<span style="color:#ae81ff">22</span>:<span style="color:#ae81ff">59</span> <span style="color:#a6e22e">Uid</span><span style="color:#f92672">-</span><span style="color:#ae81ff">9</span>, <span style="color:#a6e22e">Msg</span>: <span style="color:#a6e22e">ts</span>(<span style="color:#a6e22e">ns</span>): <span style="color:#ae81ff">1621185779672609700</span>, <span style="color:#a6e22e">server</span>: <span style="color:#a6e22e">hello</span>, <span style="color:#a6e22e">pixelpig</span>!
<span style="color:#ae81ff">2021</span><span style="color:#f92672">/</span><span style="color:#ae81ff">05</span><span style="color:#f92672">/</span><span style="color:#ae81ff">17</span> <span style="color:#ae81ff">01</span>:<span style="color:#ae81ff">22</span>:<span style="color:#ae81ff">59</span> <span style="color:#a6e22e">Uid</span><span style="color:#f92672">-</span><span style="color:#ae81ff">3</span>, <span style="color:#a6e22e">Msg</span>: <span style="color:#a6e22e">ts</span>(<span style="color:#a6e22e">ns</span>): <span style="color:#ae81ff">1621185779673605400</span>, <span style="color:#a6e22e">server</span>: <span style="color:#a6e22e">hello</span>, <span style="color:#a6e22e">pixelpig</span>!
<span style="color:#ae81ff">2021</span><span style="color:#f92672">/</span><span style="color:#ae81ff">05</span><span style="color:#f92672">/</span><span style="color:#ae81ff">17</span> <span style="color:#ae81ff">01</span>:<span style="color:#ae81ff">22</span>:<span style="color:#ae81ff">59</span> <span style="color:#a6e22e">Uid</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">Msg</span>: <span style="color:#a6e22e">ts</span>(<span style="color:#a6e22e">ns</span>): <span style="color:#ae81ff">1621185779690594100</span>, <span style="color:#a6e22e">server</span>: <span style="color:#a6e22e">hello</span>, <span style="color:#a6e22e">pixelpig</span>!
<span style="color:#ae81ff">2021</span><span style="color:#f92672">/</span><span style="color:#ae81ff">05</span><span style="color:#f92672">/</span><span style="color:#ae81ff">17</span> <span style="color:#ae81ff">01</span>:<span style="color:#ae81ff">22</span>:<span style="color:#ae81ff">59</span> <span style="color:#a6e22e">Uid</span><span style="color:#f92672">-</span><span style="color:#ae81ff">8</span>, <span style="color:#a6e22e">Msg</span>: <span style="color:#a6e22e">ts</span>(<span style="color:#a6e22e">ns</span>): <span style="color:#ae81ff">1621185779690594100</span>, <span style="color:#a6e22e">server</span>: <span style="color:#a6e22e">hello</span>, <span style="color:#a6e22e">pixelpig</span>!
<span style="color:#ae81ff">2021</span><span style="color:#f92672">/</span><span style="color:#ae81ff">05</span><span style="color:#f92672">/</span><span style="color:#ae81ff">17</span> <span style="color:#ae81ff">01</span>:<span style="color:#ae81ff">22</span>:<span style="color:#ae81ff">59</span> <span style="color:#a6e22e">Uid</span><span style="color:#f92672">-</span><span style="color:#ae81ff">5</span>, <span style="color:#a6e22e">Msg</span>: <span style="color:#a6e22e">ts</span>(<span style="color:#a6e22e">ns</span>): <span style="color:#ae81ff">1621185779690594100</span>, <span style="color:#a6e22e">server</span>: <span style="color:#a6e22e">hello</span>, <span style="color:#a6e22e">pixelpig</span>!
<span style="color:#ae81ff">2021</span><span style="color:#f92672">/</span><span style="color:#ae81ff">05</span><span style="color:#f92672">/</span><span style="color:#ae81ff">17</span> <span style="color:#ae81ff">01</span>:<span style="color:#ae81ff">22</span>:<span style="color:#ae81ff">59</span> <span style="color:#a6e22e">Uid</span><span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>, <span style="color:#a6e22e">Msg</span>: <span style="color:#a6e22e">ts</span>(<span style="color:#a6e22e">ns</span>): <span style="color:#ae81ff">1621185779690594100</span>, <span style="color:#a6e22e">server</span>: <span style="color:#a6e22e">hello</span>, <span style="color:#a6e22e">pixelpig</span>!
<span style="color:#ae81ff">2021</span><span style="color:#f92672">/</span><span style="color:#ae81ff">05</span><span style="color:#f92672">/</span><span style="color:#ae81ff">17</span> <span style="color:#ae81ff">01</span>:<span style="color:#ae81ff">22</span>:<span style="color:#ae81ff">59</span> <span style="color:#a6e22e">Uid</span><span style="color:#f92672">-</span><span style="color:#ae81ff">7</span>, <span style="color:#a6e22e">Msg</span>: <span style="color:#a6e22e">ts</span>(<span style="color:#a6e22e">ns</span>): <span style="color:#ae81ff">1621185779690594100</span>, <span style="color:#a6e22e">server</span>: <span style="color:#a6e22e">hello</span>, <span style="color:#a6e22e">pixelpig</span>!
</code></pre></div><p>It can be seen that the program output is in line with expectations, because the connection pool size is only 5, so there is a high probability that 5 connections need to be queued for 10 concurrent connections, so there are 5 coroutines waiting in the queue for the above output (blocking).</p>
<p>The above is a simple implementation of a connection pool. If you are interested, you can know more with the project.<br>
<strong>Link:</strong> <a href="https://github.com/pixeldin/pool">https://github.com/pixeldin/pool</a></p>
<h3 id="whats-more">What&rsquo;s more</h3>
<p>The above is a simple example of maintaining a TCP connection pool, as well as the more common database connections such as Redis/Kafka, which are essentially TCP connections.
Although the introduction of connection pool increases maintenance costs, you need to pay attention to read and write conflicts in critical sections, and control the size of connection pools, but it can effectively reduce frequent connection creation.<br>
In addition, the above example uses the built-in two-way queue of Go to maintain multiple connections. In fact, there is a more elegant implementation, which is to use the native channel feature of Go to &ldquo;block and wake up&rdquo;. For details, please refer to the connection pool in &ldquo;Go in action&rdquo; code.</p>
<p>The buffer here is any Closer instance, which is more versatile. Part of the code is as follows:</p>
<h4 id="define-the-pool">Define the Pool</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Pool</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">m</span>        <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Mutex</span>
	<span style="color:#75715e">// manage any resource type that implements the Closer interface
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">resource</span> <span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">Closer</span>
	<span style="color:#a6e22e">maxSize</span>  <span style="color:#66d9ef">int</span>
	<span style="color:#a6e22e">usedSize</span> <span style="color:#66d9ef">int</span>
	<span style="color:#75715e">// A factory function that builds a connection, returning an instance that implements io.Closer
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">factory</span>  <span style="color:#66d9ef">func</span>() (<span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">Closer</span>, <span style="color:#66d9ef">error</span>)
	<span style="color:#a6e22e">closed</span>   <span style="color:#66d9ef">bool</span>
}
</code></pre></div><p>The channel type used for communication is <code>io.Closer</code>. You can often see a way to check whether the interface implementation class fully implements the interface in the framework.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// If Conn does not implement the io.Closer interface, 
</span><span style="color:#75715e">// the compiler will prompt:
</span><span style="color:#75715e">// Cannot use &#39;new(Conn)&#39; (type *Conn) as type io.Closer 
</span><span style="color:#75715e">// Type does not implement &#39;io.Closer&#39;
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">_</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">Closer</span> = new(<span style="color:#a6e22e">Conn</span>)
</code></pre></div><h4 id="acquire">Acquire</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">//get resource
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Pool</span>) <span style="color:#a6e22e">Acquire</span>() (<span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">Closer</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Unlock</span>()

	<span style="color:#66d9ef">select</span> {
	<span style="color:#75715e">// take out if there is an idle connection
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">r</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">resource</span>:
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Acquire:&#34;</span>, <span style="color:#e6db74">&#34;Shard Resource&#34;</span>)
		<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">ok</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">ErrPoolClosed</span>
		}
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">r</span>, <span style="color:#66d9ef">nil</span>
	<span style="color:#66d9ef">default</span>:
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">usedSize</span> &lt; <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">maxSize</span> {
			<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">usedSize</span><span style="color:#f92672">++</span>
			<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Acquire:&#34;</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;New Resource.&#34;</span> <span style="color:#f92672">+</span>
				<span style="color:#e6db74">&#34;resource present size/max: %d/%d\n&#34;</span>, <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">usedSize</span>, <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">maxSize</span>)
			<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">factory</span>()
		} <span style="color:#66d9ef">else</span> {
			<span style="color:#75715e">//log.Printf(&#34;Acquire:&#34; +
</span><span style="color:#75715e"></span>			<span style="color:#75715e">//	&#34;block for pool&#39;s dry, present size: %d/%d&#34;, p.usedSize, p.maxSize)
</span><span style="color:#75715e"></span>			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#66d9ef">nil</span>
		}
	}
}
</code></pre></div><h4 id="release-and-return-the-connection">Release and return the connection</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">p</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Pool</span>) <span style="color:#a6e22e">Release</span>(<span style="color:#a6e22e">r</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">Closer</span>) {
	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Unlock</span>()

	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">closed</span> {
		<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Close</span>()
		<span style="color:#66d9ef">return</span>
	}

	<span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">usedSize</span><span style="color:#f92672">--</span>

	<span style="color:#66d9ef">select</span> {
	<span style="color:#75715e">// put the resource back into the queue
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">p</span>.<span style="color:#a6e22e">resource</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">r</span>:
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Release:&#34;</span>, <span style="color:#e6db74">&#34;into queue&#34;</span>)
	<span style="color:#75715e">// close resources when the queue is full
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">default</span>:
		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;Release:&#34;</span>, <span style="color:#e6db74">&#34;Closing&#34;</span>)
		<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Close</span>()
	}
}
</code></pre></div><h4 id="stone-of-other-mountains">Stone of Other Mountains</h4>
<p>I wonder if you can feel that the communication model of blocking and awakening implemented by using the language features that comes with the Go channel looks more concise and elegant.<br>
I have a deeper understanding of Go&rsquo;s concurrency philosophy: &ldquo;<em>Do not communicate through shared memory, but share memory through communication</em>&rdquo;.</p>
              
            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="/en/tags/talk-about-go/">Talk about Go</a>

                  </div>
                
              
            
            <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="/en/2021/08/before-talking-about-the-gin-web-framework-lets-take-a-look-at-httprouter/" data-tooltip="Before talking about the Gin web framework, let&#39;s take a look at httprouter">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="/en/2021/05/talk-about-go-network-programming-tcp-communication/" data-tooltip="Talk about Go: Network programming--TCP Communication">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#">
        
          <i class="fa fa-list"></i>
        </a>
      </li>
    </ul>
  
</div>

            
              
            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2022 <a href="https://github.com/pixeldin">pixeldin</a>. All Rights Reserved
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
        <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="/en/2021/08/before-talking-about-the-gin-web-framework-lets-take-a-look-at-httprouter/" data-tooltip="Before talking about the Gin web framework, let&#39;s take a look at httprouter">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="/en/2021/05/talk-about-go-network-programming-tcp-communication/" data-tooltip="Talk about Go: Network programming--TCP Communication">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#">
        
          <i class="fa fa-list"></i>
        </a>
      </li>
    </ul>
  
</div>

      </div>
      <div id="share-options-bar" class="share-options-bar" data-behavior="5">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/pig.jpg" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">pixelpig</h4>
    
      <div id="about-card-bio">a backend development living in GD, China. Stay hungry, stay foolish <strong>:）</strong></div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Golang developer@Huya
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        CHINA-GD
      </div>
    
  </div>
</div>

    

    
  
    <div id="cover" style="background-image:url('https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/cover.jpg');"></div>
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.7/js/jquery.fancybox.min.js" integrity="sha256-GEAnjcTqVP+vBp3SSc8bEDQqvWAZMiHyUSIorrWwH50=" crossorigin="anonymous"></script>


<script src="/js/script-pcw6v3xilnxydl1vddzazdverrnn9ctynvnxgwho987mfyqkuylcb1nlt.min.js"></script>


<script lang="javascript">
window.onload = updateMinWidth;
window.onresize = updateMinWidth;
document.getElementById("sidebar").addEventListener("transitionend", updateMinWidth);
function updateMinWidth() {
  var sidebar = document.getElementById("sidebar");
  var main = document.getElementById("main");
  main.style.minWidth = "";
  var w1 = getComputedStyle(main).getPropertyValue("min-width");
  var w2 = getComputedStyle(sidebar).getPropertyValue("width");
  var w3 = getComputedStyle(sidebar).getPropertyValue("left");
  main.style.minWidth = `calc(${w1} - ${w2} - ${w3})`;
}
</script>

<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>


  
    
  




    
  </body>
</html>

