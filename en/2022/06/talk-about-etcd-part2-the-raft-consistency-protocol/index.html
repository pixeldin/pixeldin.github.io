<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.80.0 with theme Tranquilpeak 0.4.8-BETA">
<meta name="author" content="pixelpig">
<meta name="keywords" content="">
<meta name="description" content="The purpose of the consensus algorithm is to maintain a consensus conclusion when there is an abnormality in the machine cluster to ensure the provision of services to the outside world.
Today, let’s talk about the consensus mechanism of etcd, the raft protocol.">


<meta property="og:description" content="The purpose of the consensus algorithm is to maintain a consensus conclusion when there is an abnormality in the machine cluster to ensure the provision of services to the outside world.
Today, let’s talk about the consensus mechanism of etcd, the raft protocol.">
<meta property="og:type" content="article">
<meta property="og:title" content="Talk about etcd (Part2): the raft consistency protocol">
<meta name="twitter:title" content="Talk about etcd (Part2): the raft consistency protocol">
<meta property="og:url" content="/en/2022/06/talk-about-etcd-part2-the-raft-consistency-protocol/">
<meta property="twitter:url" content="/en/2022/06/talk-about-etcd-part2-the-raft-consistency-protocol/">
<meta property="og:site_name" content="pixelpig.tech">
<meta property="og:description" content="The purpose of the consensus algorithm is to maintain a consensus conclusion when there is an abnormality in the machine cluster to ensure the provision of services to the outside world.
Today, let’s talk about the consensus mechanism of etcd, the raft protocol.">
<meta name="twitter:description" content="The purpose of the consensus algorithm is to maintain a consensus conclusion when there is an abnormality in the machine cluster to ensure the provision of services to the outside world.
Today, let’s talk about the consensus mechanism of etcd, the raft protocol.">
<meta property="og:locale" content="en">

  
    <meta property="article:published_time" content="2022-06-03T00:00:00">
  
  
    <meta property="article:modified_time" content="2022-06-03T00:00:00">
  
  
  
    
      <meta property="article:section" content="Go">
    
      <meta property="article:section" content="backend">
    
  
  
    
      <meta property="article:tag" content="raft">
    
      <meta property="article:tag" content="etcd">
    
      <meta property="article:tag" content="distributed systems">
    
  


<meta name="twitter:card" content="summary">

  <meta name="twitter:site" content="@pixelpigpigpig">


  <meta name="twitter:creator" content="@pixelpigpigpig">










  <meta property="og:image" content="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/pig.jpg">
  <meta property="twitter:image" content="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/pig.jpg">


    <title>Talk about etcd (Part2): the raft consistency protocol</title>

    <link rel="icon" href="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/blog/static/pig_round_circle.png">
    

    

    <link rel="canonical" href="/en/2022/06/talk-about-etcd-part2-the-raft-consistency-protocol/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.min.css" integrity="sha256-vuXZ9LGmmwtjqFX1F+EKin1ThZMub58gKULUyf0qECk=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.css" integrity="sha256-SEa4XYAHihTcEP1f5gARTB2K26Uk8PsndQYHQC1f4jU=" crossorigin="anonymous" />
    
    
    <link rel="stylesheet" href="/css/style-twzjdbqhmnnacqs0pwwdzcdbt8yhv8giawvjqjmyfoqnvazl0dalmnhdkvp7.min.css" />
    
    

    
      
    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="5">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="/en/">pixelpig.tech</a>
  </div>
  
    
      <a class="header-right-picture "
         href="/#about">
    
    
    
      
        <img class="header-picture" src="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/pig.jpg" alt="Author&#39;s picture" />
      
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="5">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="/#about">
          <img class="sidebar-profile-picture" src="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/pig.jpg" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">pixelpig</h4>
        
          <h5 class="sidebar-profile-bio">With enthusiasm for open source and I am looking forward to be a  better developer. Stay hungry, stay foolish <strong>:）</strong></h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/zh">
    
      <i class="sidebar-button-icon fa fa-lg fa-language"></i>
      
      <span class="sidebar-button-desc">简/中</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/en/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/en/categories">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/en/tags">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/en/archives">
    
      <i class="sidebar-button-icon fa fa-lg fa-archive"></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/en/#about">
    
      <i class="sidebar-button-icon fa fa-lg fa-question"></i>
      
      <span class="sidebar-button-desc">About me</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://twitter.com/pixelpigpigpig/" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-twitter"></i>
      
      <span class="sidebar-button-desc">Twitter</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/pixeldin" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-github"></i>
      
      <span class="sidebar-button-desc">pixeldin</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="5"
        class="
               hasCoverMetaIn
               ">
        <article class="post" itemscope itemType="http://schema.org/BlogPosting">
          
          
            <div class="post-header main-content-wrap text-center">
  
    <h1 class="post-title" itemprop="headline">
      Talk about etcd (Part2): the raft consistency protocol
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time itemprop="datePublished" datetime="2022-06-03T00:00:00Z">
        
  June 3, 2022

      </time>
    
    
  
  
    <span>in</span>
    
      <a class="category-link" href="/en/categories/go">Go</a>, 
    
      <a class="category-link" href="/en/categories/backend">backend</a>
    
  

  </div>

</div>
          
          <div class="post-content markdown" itemprop="articleBody">
            <div class="main-content-wrap">
              <p>The purpose of the consensus algorithm is to maintain a consensus conclusion when there is an abnormality in the machine cluster to ensure the provision of services to the outside world.</p>
<p>Today, let’s talk about the consensus mechanism of etcd, the raft protocol.</p>
<p><img src="https://images.pexels.com/photos/966927/pexels-photo-966927.jpeg?auto=compress&amp;cs=tinysrgb&amp;w=1260&amp;h=750&amp;dpr=1" alt="etcd-cover-raft"></p>
<h2 id="what-problem-does-it-solve">What problem does it solve</h2>
<p>Before entering etcd&rsquo;s raft, let&rsquo;s talk about what the consistency of distributed systems is and what problems the raft protocol solves.</p>
<h3 id="different-semantics-of-consistency">Different Semantics of Consistency</h3>
<p>In fact, in the ACID transaction characteristics, consistency as C is more like a kind of energy conservation or quality conservation, such as transfer, snap-up, and the amount of items will not disappear out of thin air or appear redundant.<br>
In the distributed field, <strong>distributed consistency often refers to consensus, which means that multiple nodes reach an agreement (either everyone is wrong, or everyone is right)</strong>, the difference is if it is under the semantics of ACID transactions Consistency, generally refers to strong consistency.</p>
<h2 id="how-it-is-solved">How it is solved</h2>
<p>etcd internally achieves consistency through election and record synchronization.<br>
etcd notifies each node of the update record. After more than half of the nodes get ack, the master node submits it and notifies other nodes to submit it together to achieve consensus data synchronization. In addition, the etcd log records every approved operation and periodically compresses the archive.</p>
<h3 id="elections-and-state-transitions">Elections and state transitions</h3>
<p>In the raft protocol, each node has three role states, namely: Leader, Candidate, and Follower. Nodes update the status of each node through regular heartbeat detection and record synchronization. Each node has the awareness of being the leader. The leader sends a heartbeat with the follower regularly to inform that the term is not over. When the heartbeat times out or a network partition occurs, the follower will run for election, but there are some rules to follow:</p>
<ul>
<li>Leader must be generated by Candidate and get the majority of votes</li>
<li>If there is an existing leader and the current leader&rsquo;s term is the latest, the follower does not participate in the election</li>
<li>When the leader&rsquo;s heartbeat times out, the follower participates in the election and becomes a candidate, and records a vote for himself</li>
<li><strong>If the node&rsquo;s log is older than the candidate&rsquo;s log update time, the candidate&rsquo;s voting request will be rejected</strong></li>
</ul>
<p>The state transition of the three roles is shown in the following figure [FG-role state transition]:<br>
<img src="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/blog/etcd/raft/en-etcd-role%20tran.png" alt="FG-role state transition"></p>
<h3 id="log-replication">Log Replication</h3>
<p>We know that the distributed storage function of etcd must involve the concept of multiple storage versions of data. How is the data version of each node of etcd synchronized?<br>
etcd uses logs to record data. Each node has its own local log. These logs come from the leader&rsquo;s synchronization and record the leader&rsquo;s term number at that time, referred to as termId. This term number is used to distinguish the old and new versions of the log files. <strong>That is, if the node&rsquo;s log is older than the candidate&rsquo;s log update time, the candidate&rsquo;s voting request will be rejected.</strong></p>
<p>Once the new leader role takes office, the leader will synchronize the current log subscript that can be submitted to the follower. If a follower fails to keep up, the leader will send the last log subscript to the follower step by step, until the follower catches up with the alignment synchronization.</p>
<p>The log data format of each role is as follows, t represents the term number, and kv is a key-value pair.
Leader and Follower interact through <code>MatchIndex</code> and <code>NextIndex</code>, Follower will inform the Leader of the currently received maximum matching index <code>MatchIndex</code>, and the Leader will pass <code>NextIndex</code>  to synchronize the latest node to the Follower.</p>
<p>The log diagram of each node is as follows:<br>
<img src="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/blog/etcd/raft/etcd-logIndex.png" alt="log-Index"></p>
<p><strong>Through <code>MatchIndex</code>, the leader node can know the records that the current cluster has been recognized by most nodes, and can notify other followers to submit a block by broadcasting Msg.</strong></p>
<p>The structure of the synchronization request body is as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Entry</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Term</span>  <span style="color:#66d9ef">uint64</span>    <span style="color:#e6db74">`protobuf:&#34;varint,2,opt,name=Term&#34; json:&#34;Term&#34;`</span>         
	<span style="color:#a6e22e">Index</span> <span style="color:#66d9ef">uint64</span>    <span style="color:#e6db74">`protobuf:&#34;varint,3,opt,name=Index&#34; json:&#34;Index&#34;`</span>
	<span style="color:#a6e22e">Type</span>  <span style="color:#a6e22e">EntryType</span> <span style="color:#e6db74">`protobuf:&#34;varint,1,opt,name=Type,enum=raftpb.EntryType&#34; json:&#34;Type&#34;`</span>
	<span style="color:#a6e22e">Data</span>  []<span style="color:#66d9ef">byte</span>    <span style="color:#e6db74">`protobuf:&#34;bytes,4,opt,name=Data&#34; json:&#34;Data,omitempty&#34;`</span>
}
<span style="color:#75715e">// AppendEntries RPC request: Attempt to sync record to node
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">raft</span>) <span style="color:#a6e22e">appendEntry</span>(<span style="color:#a6e22e">es</span> <span style="color:#f92672">...</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Entry</span>) (<span style="color:#a6e22e">accepted</span> <span style="color:#66d9ef">bool</span>) {
	<span style="color:#a6e22e">li</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">raftLog</span>.<span style="color:#a6e22e">lastIndex</span>()
	<span style="color:#66d9ef">for</span> <span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">range</span> <span style="color:#a6e22e">es</span> {
		<span style="color:#a6e22e">es</span>[<span style="color:#a6e22e">i</span>].<span style="color:#a6e22e">Term</span> = <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Term</span>
		<span style="color:#a6e22e">es</span>[<span style="color:#a6e22e">i</span>].<span style="color:#a6e22e">Index</span> = <span style="color:#a6e22e">li</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> uint64(<span style="color:#a6e22e">i</span>)
	}
	<span style="color:#75715e">// Track the size of this uncommitted proposal.
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">increaseUncommittedSize</span>(<span style="color:#a6e22e">es</span>) {
	    <span style="color:#75715e">// The current log does not catch up with the Leader
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Debugf</span>(
			<span style="color:#e6db74">&#34;%x appending new entries to log would exceed uncommitted entry size limit; dropping proposal&#34;</span>,
			<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">id</span>,
		)
		<span style="color:#75715e">// Reject the new record of the leader, need to wait for catching up by majority
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
	}
	<span style="color:#75715e">// use latest &#34;last&#34; index after truncate/append
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">li</span> = <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">raftLog</span>.append(<span style="color:#a6e22e">es</span><span style="color:#f92672">...</span>)
	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">prs</span>.<span style="color:#a6e22e">Progress</span>[<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">id</span>].<span style="color:#a6e22e">MaybeUpdate</span>(<span style="color:#a6e22e">li</span>)
	<span style="color:#75715e">// Regardless of maybeCommit&#39;s return, our caller will call bcastAppend.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">maybeCommit</span>()
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
}
</code></pre></div><h3 id="log-compression">Log Compression</h3>
<p>Due to the incremental addition of the operation update log, the raft node will periodically archive and compress the log version after reaching an agreement, which is somewhat similar to the AOF and Snapshot backup strategies of Redis. One compression can free up space, reduce storage space and avoid a large number of operation logs. Replaying is also convenient for nodes that lag behind too many logs to quickly catch up with the leader.</p>
<p>Among them, raft startup will have an associated member <code>storage</code> to store the log data collection, and the specific related operations are implemented in the <code>raft.Storage</code> interface of etcd. The core members are as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">bootstrappedRaft</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">lg</span>        <span style="color:#f92672">*</span><span style="color:#a6e22e">zap</span>.<span style="color:#a6e22e">Logger</span>
	<span style="color:#a6e22e">heartbeat</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>

	<span style="color:#a6e22e">peers</span>   []<span style="color:#a6e22e">raft</span>.<span style="color:#a6e22e">Peer</span>
	<span style="color:#a6e22e">config</span>  <span style="color:#f92672">*</span><span style="color:#a6e22e">raft</span>.<span style="color:#a6e22e">Config</span>
	<span style="color:#75715e">// raft server associative storage implementation
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">storage</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">raft</span>.<span style="color:#a6e22e">MemoryStorage</span>
}

<span style="color:#75715e">//...
</span><span style="color:#75715e"></span>
<span style="color:#75715e">//Storage implement
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">MemoryStorage</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">Mutex</span>
	<span style="color:#a6e22e">hardState</span> <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">HardState</span>
	<span style="color:#a6e22e">snapshot</span>  <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Snapshot</span>
	<span style="color:#75715e">// ents stores the current node operation set, each Entry represents the log additional attributes
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ents</span> []<span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Entry</span>
}

<span style="color:#75715e">//Entry Additional properties
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Entry</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">Term</span>  <span style="color:#66d9ef">uint64</span>    <span style="color:#e6db74">`protobuf:&#34;varint,2,opt,name=Term&#34; json:&#34;Term&#34;`</span>
	<span style="color:#a6e22e">Index</span> <span style="color:#66d9ef">uint64</span>    <span style="color:#e6db74">`protobuf:&#34;varint,3,opt,name=Index&#34; json:&#34;Index&#34;`</span>
	<span style="color:#a6e22e">Type</span>  <span style="color:#a6e22e">EntryType</span> <span style="color:#e6db74">`protobuf:&#34;varint,1,opt,name=Type,enum=raftpb.EntryType&#34; json:&#34;Type&#34;`</span>
	<span style="color:#a6e22e">Data</span>  []<span style="color:#66d9ef">byte</span>    <span style="color:#e6db74">`protobuf:&#34;bytes,4,opt,name=Data&#34; json:&#34;Data,omitempty&#34;`</span>
}
</code></pre></div><p>raft will periodically create snapshots to compress the log, which is equivalent to saving the snapshot to a local file, and then execute the <code>Compact()</code> function to rotate the <code>ents</code> field, and retain a new round of subscripts .</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Compact discards all log entries prior to compactIndex.
</span><span style="color:#75715e">// It is the application&#39;s responsibility to not attempt to compact an index
</span><span style="color:#75715e">// greater than raftLog.applied.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">ms</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">MemoryStorage</span>) <span style="color:#a6e22e">Compact</span>(<span style="color:#a6e22e">compactIndex</span> <span style="color:#66d9ef">uint64</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#a6e22e">ms</span>.<span style="color:#a6e22e">Lock</span>()
	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">ms</span>.<span style="color:#a6e22e">Unlock</span>()
	<span style="color:#a6e22e">offset</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ms</span>.<span style="color:#a6e22e">ents</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">Index</span>
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">compactIndex</span> <span style="color:#f92672">&lt;=</span> <span style="color:#a6e22e">offset</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">ErrCompacted</span>
	}
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">compactIndex</span> &gt; <span style="color:#a6e22e">ms</span>.<span style="color:#a6e22e">lastIndex</span>() {
		<span style="color:#a6e22e">getLogger</span>().<span style="color:#a6e22e">Panicf</span>(<span style="color:#e6db74">&#34;compact %d is out of bound lastindex(%d)&#34;</span>, <span style="color:#a6e22e">compactIndex</span>, <span style="color:#a6e22e">ms</span>.<span style="color:#a6e22e">lastIndex</span>())
	}

	<span style="color:#a6e22e">i</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">compactIndex</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">offset</span>
	<span style="color:#a6e22e">ents</span> <span style="color:#f92672">:=</span> make([]<span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Entry</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">1</span><span style="color:#f92672">+</span>uint64(len(<span style="color:#a6e22e">ms</span>.<span style="color:#a6e22e">ents</span>))<span style="color:#f92672">-</span><span style="color:#a6e22e">i</span>)
	<span style="color:#a6e22e">ents</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">Index</span> = <span style="color:#a6e22e">ms</span>.<span style="color:#a6e22e">ents</span>[<span style="color:#a6e22e">i</span>].<span style="color:#a6e22e">Index</span>
	<span style="color:#a6e22e">ents</span>[<span style="color:#ae81ff">0</span>].<span style="color:#a6e22e">Term</span> = <span style="color:#a6e22e">ms</span>.<span style="color:#a6e22e">ents</span>[<span style="color:#a6e22e">i</span>].<span style="color:#a6e22e">Term</span>
	<span style="color:#a6e22e">ents</span> = append(<span style="color:#a6e22e">ents</span>, <span style="color:#a6e22e">ms</span>.<span style="color:#a6e22e">ents</span>[<span style="color:#a6e22e">i</span><span style="color:#f92672">+</span><span style="color:#ae81ff">1</span>:]<span style="color:#f92672">...</span>)
	<span style="color:#a6e22e">ms</span>.<span style="color:#a6e22e">ents</span> = <span style="color:#a6e22e">ents</span>
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>In fact, before committing <code>MemoryStorage</code>, the node will also write to the local disk for persistence. Once the fault occurs, the data can be reconstructed. This process is called the WAL write-ahead log.</p>
<p>More details on log storage will be discussed in <em>etcd storage analysis</em> of this series.</p>
<h3 id="network-partition-handling">Network Partition Handling</h3>
<p>We know that network node failures can actually happen. Here we divide it into two cases to analyze how to ensure consistency. Suppose there is a scenario as follow:<br>
The client sends a request to the leader, and the leader is responsible for distributing data to the followers and submitting it after receiving approval from most nodes.
<img src="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/blog/etcd/raft/FG-%E6%95%B0%E6%8D%AE%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B.png" alt="image"></p>
<p>If the client update process fails, what will the different roles do?</p>
<ul>
<li>Follower failure: The leader will continue to confirm the follower record through RPC requests to catch up</li>
<li>Leader failure:
The leader failure situation can be subdivided again. After the data log reaches the leader at the time of downtime, whether the follower submits two situations:
<ul>
<li>The data arrives at the leader and is not submitted to the follower. At this time, the leader is down and the client does not receive an ACK. The retry logic will be enabled, and the consistency will continue to be guaranteed after the new leader recovers.</li>
<li>The data reaches the leader and some followers have been submitted. At this time, the leader is down, and a new leader will be generated in the submitted followers because their records are up to date. Once again, the election is successful and becomes the new leader. Finally, consistency synchronization is performed. .</li>
<li>The leader node has a network partition, and a &ldquo;split brain&rdquo; occurs in a short period of time, that is, the network partition cannot contact the other party, and two leaders are generated in two local networks. At this time, in another partition, a new leader will be selected. , the term number of the new leader is +1. After the network partition is restored, because the term number of the new leader is larger than that of the old leader, it will eventually be synchronized with the data version of the new leader with the largest TermId.<br>
<em>There is also an optimization option here. etcd provides a <code>PreVote</code> parameter to optimize the situation of frequent leader elections due to network problems. If the current node wants to become a candidate candidate, there will be a <code>PreCandidate </code> as the state of pre-voting, if the pre-voting does not get a corresponding response from the majority of nodes, the election will be abandoned.</em>
<img src="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/blog/etcd/raft/en-brain-split.png" alt="image"></li>
</ul>
</li>
</ul>
<p>In addition, for split-brain scenarios, etcd also provides a switch for the Leader to check the votes itself.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// CheckQuorum specifies if the leader should check quorum activity. Leader
</span><span style="color:#75715e">// steps down when quorum is not active for an electionTimeout.
</span><span style="color:#75715e"></span><span style="color:#a6e22e">CheckQuorum</span> <span style="color:#66d9ef">bool</span>    
</code></pre></div><p><strong>Every once in a while, the leader obtains heartbeats from other nodes and records the number of connections. If the number of heartbeat connections is less than half, the leader will automatically drop to a follower</strong>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// tickHeartbeat is run by leaders to send a MsgBeat after r.heartbeatTimeout.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">raft</span>) <span style="color:#a6e22e">tickHeartbeat</span>() {
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// self checking
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">checkQuorum</span> {
    	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Step</span>(<span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Message</span>{<span style="color:#a6e22e">From</span>: <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">id</span>, <span style="color:#a6e22e">Type</span>: <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">MsgCheckQuorum</span>}); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
    		<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Debugf</span>(<span style="color:#e6db74">&#34;error occurred during checking sending heartbeat: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
    	}
    }
    <span style="color:#75715e">//...
</span><span style="color:#75715e"></span>}
<span style="color:#75715e">// Leader msg handle
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">stepLeader</span>(<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">raft</span>, <span style="color:#a6e22e">m</span> <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">Message</span>) <span style="color:#66d9ef">error</span> {
	<span style="color:#75715e">// These message types do not require any progress for m.From.
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">m</span>.<span style="color:#a6e22e">Type</span> {
	<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">MsgCheckQuorum</span>:
		<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>		<span style="color:#75715e">// Check if the leader has a majority vote
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">prs</span>.<span style="color:#a6e22e">QuorumActive</span>() {
			<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">logger</span>.<span style="color:#a6e22e">Warningf</span>(<span style="color:#e6db74">&#34;%x stepped down to follower since quorum is not active&#34;</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">id</span>)
			<span style="color:#75715e">// reduced to Follower
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">becomeFollower</span>(<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Term</span>, <span style="color:#a6e22e">None</span>)
		}
	    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    }
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>}
</code></pre></div><h3 id="linearizable-read">Linearizable Read</h3>
<p>In the above network partition failure scenario, we know that there may be dual leaders for a period of time, that is, the data version may have dirty data. In fact, there is a maximum commit index <code>CommitIndex</code> on the etcd data set, which represents the current subscript recognized by most nodes, and <code>ReadIndex</code> represents the latest index that can be obtained by the current node (maybe not yet recognized by most).<br>
Through these two records, etcd provides the option of whether to enable linear reading (Serializable bool type), which is used to block read requests.</p>
<p>When strong consistency is required, linear reading is enabled, and the request will <strong>wait until The Follower version <code>ReadIndex</code> catches up with the consistent subscript <code>CommitIndex</code> and returns the data</strong>. At this time, the read records can be guaranteed to be consistent in the cluster.</p>
<p>The relevant source code is as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">RangeRequest</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#75715e">// key is the first key for the range. If range_end is not given, the request only looks up key.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Key</span> []<span style="color:#66d9ef">byte</span> <span style="color:#e6db74">`protobuf:&#34;bytes,1,opt,name=key,proto3&#34; json:&#34;key,omitempty&#34;`</span>
	
	<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// serializable sets the range request to use serializable member-local reads.
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// Range requests are linearizable by default; linearizable requests have higher
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// latency and lower throughput than serializable requests but reflect the current
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// consensus of the cluster. For better performance, in exchange for possible stale reads,
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// a serializable range request is served locally without needing to reach consensus
</span><span style="color:#75715e"></span>	<span style="color:#75715e">// with other nodes in the cluster.
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">Serializable</span> <span style="color:#66d9ef">bool</span>
	
	<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">s</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">EtcdServer</span>) <span style="color:#a6e22e">Range</span>(<span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">Context</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">RangeRequest</span>) (<span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">RangeResponse</span>, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">trace</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">traceutil</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;range&#34;</span>,
		<span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Logger</span>(),
		<span style="color:#a6e22e">traceutil</span>.<span style="color:#a6e22e">Field</span>{<span style="color:#a6e22e">Key</span>: <span style="color:#e6db74">&#34;range_begin&#34;</span>, <span style="color:#a6e22e">Value</span>: string(<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Key</span>)},
		<span style="color:#a6e22e">traceutil</span>.<span style="color:#a6e22e">Field</span>{<span style="color:#a6e22e">Key</span>: <span style="color:#e6db74">&#34;range_end&#34;</span>, <span style="color:#a6e22e">Value</span>: string(<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">RangeEnd</span>)},
	)
	<span style="color:#a6e22e">ctx</span> = <span style="color:#a6e22e">context</span>.<span style="color:#a6e22e">WithValue</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">traceutil</span>.<span style="color:#a6e22e">TraceKey</span>, <span style="color:#a6e22e">trace</span>)

	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">resp</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">pb</span>.<span style="color:#a6e22e">RangeResponse</span>
	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>
	<span style="color:#75715e">//...
</span><span style="color:#75715e"></span>
	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Serializable</span> {
		<span style="color:#75715e">// blocking waiting
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">linearizableReadNotify</span>(<span style="color:#a6e22e">ctx</span>)
		<span style="color:#a6e22e">trace</span>.<span style="color:#a6e22e">Step</span>(<span style="color:#e6db74">&#34;agreement among raft nodes before linearized reading&#34;</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
		}
	}
	<span style="color:#a6e22e">chk</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">ai</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">auth</span>.<span style="color:#a6e22e">AuthInfo</span>) <span style="color:#66d9ef">error</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">authStore</span>.<span style="color:#a6e22e">IsRangePermitted</span>(<span style="color:#a6e22e">ai</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">Key</span>, <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">RangeEnd</span>)
	}

	<span style="color:#a6e22e">get</span> <span style="color:#f92672">:=</span> <span style="color:#66d9ef">func</span>() { <span style="color:#a6e22e">resp</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">txn</span>.<span style="color:#a6e22e">Range</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">Logger</span>(), <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">KV</span>(), <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">r</span>) }
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">serr</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">s</span>.<span style="color:#a6e22e">doSerialize</span>(<span style="color:#a6e22e">ctx</span>, <span style="color:#a6e22e">chk</span>, <span style="color:#a6e22e">get</span>); <span style="color:#a6e22e">serr</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">serr</span>
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">resp</span>, <span style="color:#a6e22e">err</span>
}
</code></pre></div><h2 id="summary">Summary</h2>
<p>This is some understanding of etcd&rsquo;s internal consensus mechanism in the past few days, mainly involving concepts such as election state transfer and log compression. The next chapter in this series will talk about how etcd nodes communicate.</p>
<h2 id="reference-link">Reference link</h2>
<ul>
<li>raft MessageType<br>
<a href="https://pkg.go.dev/go.etcd.io/etcd/raft/v3#hdr-MessageType">https://pkg.go.dev/go.etcd.io/etcd/raft/v3#hdr-MessageType</a></li>
<li>etc技术内幕 - 百里燊</li>
<li>云原生分布式存储基石etcd深入解析 - 华为云</li>
</ul>
              
            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="/en/tags/raft/">raft</a>

  <a class="tag tag--primary tag--small" href="/en/tags/etcd/">etcd</a>

  <a class="tag tag--primary tag--small" href="/en/tags/distributed-systems/">distributed systems</a>

                  </div>
                
              
            
            <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="/en/2022/06/talk-about-etcd-part3-the-communication-protocol-between-client-and-server/" data-tooltip="Talk about etcd (Part3): the Communication Protocol between Client and Server">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="/en/2022/05/talk-about-etcd-part1-hierarchy-overview-with-birds-eye-view/" data-tooltip="Talk about etcd (Part1): Hierarchy Overview with bird&#39;s eye view">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
      
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#">
        
          <i class="fa fa-list"></i>
        </a>
      </li>
    </ul>
  
</div>

            
              
            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2022 <a href="https://github.com/pixeldin">pixeldin</a>. All Rights Reserved
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
        <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="/en/2022/06/talk-about-etcd-part3-the-communication-protocol-between-client-and-server/" data-tooltip="Talk about etcd (Part3): the Communication Protocol between Client and Server">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="/en/2022/05/talk-about-etcd-part1-hierarchy-overview-with-birds-eye-view/" data-tooltip="Talk about etcd (Part1): Hierarchy Overview with bird&#39;s eye view">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
      
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#">
        
          <i class="fa fa-list"></i>
        </a>
      </li>
    </ul>
  
</div>

      </div>
      <div id="share-options-bar" class="share-options-bar" data-behavior="5">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/pig.jpg" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">pixelpig</h4>
    
      <div id="about-card-bio">With enthusiasm for open source and I am looking forward to be a  better developer. Stay hungry, stay foolish <strong>:）</strong></div>
    
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        GuangDong - CHINA
      </div>
    
  </div>
</div>

    

    
  
    <div id="cover" style="background-image:url('https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/cover.jpg');"></div>
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.7/js/jquery.fancybox.min.js" integrity="sha256-GEAnjcTqVP+vBp3SSc8bEDQqvWAZMiHyUSIorrWwH50=" crossorigin="anonymous"></script>


<script src="/js/script-pcw6v3xilnxydl1vddzazdverrnn9ctynvnxgwho987mfyqkuylcb1nlt.min.js"></script>


<script lang="javascript">
window.onload = updateMinWidth;
window.onresize = updateMinWidth;
document.getElementById("sidebar").addEventListener("transitionend", updateMinWidth);
function updateMinWidth() {
  var sidebar = document.getElementById("sidebar");
  var main = document.getElementById("main");
  main.style.minWidth = "";
  var w1 = getComputedStyle(main).getPropertyValue("min-width");
  var w2 = getComputedStyle(sidebar).getPropertyValue("width");
  var w3 = getComputedStyle(sidebar).getPropertyValue("left");
  main.style.minWidth = `calc(${w1} - ${w2} - ${w3})`;
}
</script>

<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>


  
    
  




    
  </body>
</html>

