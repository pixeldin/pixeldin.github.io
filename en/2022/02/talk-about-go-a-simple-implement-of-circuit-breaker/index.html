<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.80.0 with theme Tranquilpeak 0.4.8-BETA">
<meta name="author" content="pixelpig">
<meta name="keywords" content="">
<meta name="description" content="A simple implement of circuit breaker with Go, trigger for fail-fast and return quickly when your API comes to high error rate durning a period of time.
It&rsquo;s a protection strategy that prevents the upstream from retrying repeatedly so that the downstream is overwhelmed.">


<meta property="og:description" content="A simple implement of circuit breaker with Go, trigger for fail-fast and return quickly when your API comes to high error rate durning a period of time.
It&rsquo;s a protection strategy that prevents the upstream from retrying repeatedly so that the downstream is overwhelmed.">
<meta property="og:type" content="article">
<meta property="og:title" content="Talk about Go: A simple implement of Circuit Breaker">
<meta name="twitter:title" content="Talk about Go: A simple implement of Circuit Breaker">
<meta property="og:url" content="/en/2022/02/talk-about-go-a-simple-implement-of-circuit-breaker/">
<meta property="twitter:url" content="/en/2022/02/talk-about-go-a-simple-implement-of-circuit-breaker/">
<meta property="og:site_name" content="pixelpig - tech">
<meta property="og:description" content="A simple implement of circuit breaker with Go, trigger for fail-fast and return quickly when your API comes to high error rate durning a period of time.
It&rsquo;s a protection strategy that prevents the upstream from retrying repeatedly so that the downstream is overwhelmed.">
<meta name="twitter:description" content="A simple implement of circuit breaker with Go, trigger for fail-fast and return quickly when your API comes to high error rate durning a period of time.
It&rsquo;s a protection strategy that prevents the upstream from retrying repeatedly so that the downstream is overwhelmed.">
<meta property="og:locale" content="en">

  
    <meta property="article:published_time" content="2022-02-25T00:00:00">
  
  
    <meta property="article:modified_time" content="2022-02-25T00:00:00">
  
  
  
    
      <meta property="article:section" content="Go">
    
      <meta property="article:section" content="Middleware">
    
  
  
    
      <meta property="article:tag" content="circuit breaker">
    
      <meta property="article:tag" content="Talk about Go">
    
  


<meta name="twitter:card" content="summary">

  <meta name="twitter:site" content="@pixelpigpigpig">


  <meta name="twitter:creator" content="@pixelpigpigpig">










  <meta property="og:image" content="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/pig.jpg">
  <meta property="twitter:image" content="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/pig.jpg">


    <title>Talk about Go: A simple implement of Circuit Breaker</title>

    <link rel="icon" href="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/blog/static/pixel.ico">
    

    

    <link rel="canonical" href="/en/2022/02/talk-about-go-a-simple-implement-of-circuit-breaker/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.min.css" integrity="sha256-vuXZ9LGmmwtjqFX1F+EKin1ThZMub58gKULUyf0qECk=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.css" integrity="sha256-SEa4XYAHihTcEP1f5gARTB2K26Uk8PsndQYHQC1f4jU=" crossorigin="anonymous" />
    
    
    <link rel="stylesheet" href="/css/style-twzjdbqhmnnacqs0pwwdzcdbt8yhv8giawvjqjmyfoqnvazl0dalmnhdkvp7.min.css" />
    
    

    
      
    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="5">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="/en/">pixelpig - tech</a>
  </div>
  
    
      <a class="header-right-picture "
         href="/#about">
    
    
    
      
        <img class="header-picture" src="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/pig.jpg" alt="Author&#39;s picture" />
      
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="5">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="/#about">
          <img class="sidebar-profile-picture" src="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/pig.jpg" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">pixelpig</h4>
        
          <h5 class="sidebar-profile-bio">a backend development living in GD, China. Stay hungry, stay foolish <strong>:）</strong></h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/zh">
    
      <i class="sidebar-button-icon fa fa-lg fa-language"></i>
      
      <span class="sidebar-button-desc">简/中</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/en/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/en/categories">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/en/tags">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/en/archives">
    
      <i class="sidebar-button-icon fa fa-lg fa-archive"></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/en/#about">
    
      <i class="sidebar-button-icon fa fa-lg fa-question"></i>
      
      <span class="sidebar-button-desc">About me</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://twitter.com/pixelpigpigpig/" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-twitter"></i>
      
      <span class="sidebar-button-desc">Twitter</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="5"
        class="
               hasCoverMetaIn
               ">
        <article class="post" itemscope itemType="http://schema.org/BlogPosting">
          
          
            <div class="post-header main-content-wrap text-center">
  
    <h1 class="post-title" itemprop="headline">
      Talk about Go: A simple implement of Circuit Breaker
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time itemprop="datePublished" datetime="2022-02-25T00:00:00Z">
        
  February 25, 2022

      </time>
    
    
  
  
    <span>in</span>
    
      <a class="category-link" href="/en/categories/go">Go</a>, 
    
      <a class="category-link" href="/en/categories/middleware">Middleware</a>
    
  

  </div>

</div>
          
          <div class="post-content markdown" itemprop="articleBody">
            <div class="main-content-wrap">
              <p>A simple implement of circuit breaker with Go, trigger for fail-fast and return quickly when your API comes to <strong>high error rate durning a period of time</strong>.
It&rsquo;s a protection strategy that prevents the upstream from retrying repeatedly so that the downstream is overwhelmed.</p>
<p><img src="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/blog/cbk/cbk_front.png" alt="熔断器"></p>
<h2 id="foreword">Foreword</h2>
<p>Circuit Breaker can be said to be a high-frequency word that appears in microservice calls. It first came from the fuse of the old home circuit (power overload-tripping), and was later used by the stock market industry to describe the occurrence of an abnormal situation, temporarily suspending trading, and starting to protect the market scene.</p>
<p>In a microservice link, a circuit breaker refers to <strong>multiple exceptions/timeouts</strong> on the API in a short period of time (<strong>excessive error rate</strong>),</p>
<h2 id="related-concepts">Related concepts</h2>
<ul>
<li><strong>dynamic adjustment</strong><br>
The core function of the fuse is &ldquo;dynamic adjustment&rdquo;, that is to say, within a certain time window, when the number of errors on the interface, or the ratio reaches a dangerous value, the fuse must <strong>hold</strong> hold the request, return quickly (failure), and inform the upstream interface *<em>Need to calm down</em> *, mainly has the following parameters:
<ul>
<li><strong>threshold</strong>：Including two indicators: the minimum number of statistics and the proportion of errors. The minimum number of statistics is used to capture high-frequency requests, that is, the amount of requests must be at least greater than that before the circuit breaker starts to care about the error rate. Otherwise, a small number of failures on other low-frequency interfaces will trigger the circuit breaker.</li>
<li><strong>round interval</strong>：the time window of the fuse scheduling, which can be analogous to the unit time in the current limiting algorithm, that is, how long it takes to reset the total number of times and the error count of the interface in the fuse period.</li>
</ul>
</li>
<li><strong>recover interval</strong>：after breaker trigged, how long is the idle period to give the interface retry permission, and try to correct it and restore it to a normal state.</li>
</ul>
<p>The main difference between <strong>round interval</strong> and the <strong>recover interval</strong> is that after the fuse resets the count, the interface must reach the error rate again to trigger the fuse, while the recovery interval is only to allow the current blown interface request, and the error rate is still very high. If you try again If the request is still not recovered, keep the blown state and wait for the next recovery cycle or reset cycle. So <strong>recovery period</strong> &lt; <strong>round interval</strong>.</p>
<p>Regarding the state transition, this example diagram is more vivid:</p>
<p><img src="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/blog/cbk/en-CBK-state.png" alt="CBK status change"></p>
<ul>
<li>
<p><strong>AOP Pattern</strong><br>
Being familiar with the basic purpose of the fuse, let&rsquo;s analyze the location of its components in the project.
I believe you will understand the concept of slice-oriented. Many common components, such as traffic restriction and circuit breaker protection, are slice-oriented modules, which are usually used to collect and report traffic conditions and protect downstream according to specific rules. The most common is to put them at the gateway layer.</p>
<p><strong>As shown in the figure below:</strong>
<img src="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/blog/cbk/en-CBK-AOP.png" alt="AOP location"></p>
</li>
</ul>
<h2 id="code-implement">Code implement</h2>
<p>Let&rsquo;s look at the code implementation part.</p>
<h3 id="interface-definition">Interface definition</h3>
<p>Based on the characteristics of the circuit breaker, first define the circuit breaker interface ``CircuitBreaker```, where the key refers to the API collected by the circuit breaker, which can be the request identifier on the link to distinguish different requests.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">CircuitBreaker</span> <span style="color:#66d9ef">interface</span> {
    <span style="color:#75715e">// check if your api(key) allow to access
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">CanAccess</span>(<span style="color:#a6e22e">key</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">bool</span>
    <span style="color:#75715e">// mark failed api result
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">Failed</span>(<span style="color:#a6e22e">key</span> <span style="color:#66d9ef">string</span>)
    <span style="color:#75715e">// mark succeed api result
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">Succeed</span>(<span style="color:#a6e22e">key</span> <span style="color:#66d9ef">string</span>)
}
</code></pre></div><h3 id="interface-implement">Interface implement</h3>
<p>Based on several functional characteristics agreed upon above, create ``CircuitBreakerImp``` as the implementation body</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">CircuitBreakerImp</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#a6e22e">lock</span>            <span style="color:#a6e22e">sync</span>.<span style="color:#a6e22e">RWMutex</span>
    <span style="color:#a6e22e">apiMap</span>          <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#f92672">*</span><span style="color:#a6e22e">apiSnapShop</span> 
    <span style="color:#a6e22e">minCheck</span>        <span style="color:#66d9ef">int64</span>                   
    <span style="color:#a6e22e">cbkErrRate</span>      <span style="color:#66d9ef">float64</span>                 
    <span style="color:#a6e22e">recoverInterval</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>           
    <span style="color:#a6e22e">roundInterval</span>   <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Duration</span>           
}
</code></pre></div><p>The <code>apiMap</code> of the circuit breaker implementation body mainly stores the list of collection APIs, which is used to represent the overall snapshot of each API collected at the current stage.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">apiSnapShop</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#a6e22e">isPaused</span>   <span style="color:#66d9ef">bool</span> 
    <span style="color:#a6e22e">errCount</span>   <span style="color:#66d9ef">int64</span>
    <span style="color:#a6e22e">totalCount</span> <span style="color:#66d9ef">int64</span>

    <span style="color:#a6e22e">accessLast</span> <span style="color:#66d9ef">int64</span> <span style="color:#75715e">// The last access time of the api
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">roundLast</span>  <span style="color:#66d9ef">int64</span> <span style="color:#75715e">// fuse cycle time
</span><span style="color:#75715e"></span>}
</code></pre></div><hr>
<p><strong>Circuit breaker status</strong>, based on each failed request, the request snapshot will be stored in the apiMap of the current <code>CircuitBreakerImp</code> instance, so the implementation of the <code>IsBreak()</code> interface is relatively Simple, just return its status directly:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">CircuitBreakerImp</span>) <span style="color:#a6e22e">IsBreak</span>(<span style="color:#a6e22e">key</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">bool</span> {
    <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">RLock</span>()
    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">RUnlock</span>()

    <span style="color:#75715e">// Find out whether the current key (API) has reached a fuse
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">api</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">apiMap</span>[<span style="color:#a6e22e">key</span>]; <span style="color:#a6e22e">ok</span> {
        <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">isPaused</span>
    }
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
}
</code></pre></div><hr>
<p><strong>Access record</strong>，Every time the gateway receives a request, it will report the number of interface accesses and the information on whether the return is successful or not to the circuit breaker at the origin of the request and the return of the request, as shown in the AOP picture above, the <code>accessed()</code> function is used to report each time the API is requested.<br>
In addition, as mentioned earlier, the circuit breaker has a <strong>reset period</strong>, that is, after how long the interface will be accessed again, its snapshot count will be reset. Therefore, at each <code>access</code>, an additional judgment is required. Used to reset API counts.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// accessed record
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">CircuitBreakerImp</span>) <span style="color:#a6e22e">accessed</span>(<span style="color:#a6e22e">api</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">apiSnapShop</span>) {
    <span style="color:#75715e">/*
</span><span style="color:#75715e">        whether now it is older than the cycle time?
</span><span style="color:#75715e">        - yes: reset counter
</span><span style="color:#75715e">        - no: update counter
</span><span style="color:#75715e">    */</span>
    <span style="color:#a6e22e">now</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">UnixNano</span>()
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">util</span>.<span style="color:#a6e22e">Abs64</span>(<span style="color:#a6e22e">now</span><span style="color:#f92672">-</span><span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">roundLast</span>) &gt; int64(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">roundInterval</span>) {
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">roundLast</span> <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {            
            <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Warnf</span>(<span style="color:#e6db74">&#34;# Trigger circuit breaker windows，reset API counter!&#34;</span>)
        }
        <span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">errCount</span> = <span style="color:#ae81ff">0</span>
        <span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">totalCount</span> = <span style="color:#ae81ff">0</span>
        <span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">roundLast</span> = <span style="color:#a6e22e">now</span>
    }
    <span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">totalCount</span><span style="color:#f92672">++</span>
    <span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">accessLast</span> = <span style="color:#a6e22e">now</span>
}
</code></pre></div><hr>
<p><strong>report success</strong>，After the gateway receives the successful response code, it will record its success. Another detail is why the <code>accessed()</code> function above does not need to add a mutex, it is actually needed, but in <code>accessed()</code> function is added at the upper level of the call, that is, in the subsequent <code>Successd()</code> and <code>Failed()</code> function bodies.
Let&rsquo;s first look at the implementation of <code>Successd()</code>, <strong>If the current api is recorded in the circuit breaker (it has failed), then close the circuit breaker after success and give the request</strong>, even if the api fails again, it will be based on Request error rate redistribution circuit breaker.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">/*
</span><span style="color:#75715e">    Succeed record
</span><span style="color:#75715e">    Only collect which api in global map,
</span><span style="color:#75715e">    check whether is&#39;s paused:
</span><span style="color:#75715e">    - yes, cancel the paused breaker state.
</span><span style="color:#75715e">*/</span>
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">CircuitBreakerImp</span>) <span style="color:#a6e22e">Succeed</span>(<span style="color:#a6e22e">key</span> <span style="color:#66d9ef">string</span>) {
    <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">Lock</span>()
    <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">Unlock</span>()

    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">api</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">apiMap</span>[<span style="color:#a6e22e">key</span>]; <span style="color:#a6e22e">ok</span> {
        <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">accessed</span>(<span style="color:#a6e22e">api</span>)
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">isPaused</span> {
            <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Warnf</span>(<span style="color:#e6db74">&#34;# Trigger API: %v access succeed.&#34;</span>, <span style="color:#a6e22e">key</span>)
            <span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">isPaused</span> = <span style="color:#66d9ef">false</span>
        }
    }
}
</code></pre></div><hr>
<p><strong>Reporting failed access</strong>, the logic of counting failures is relatively simple. For the interface that fails for the first time, add it to the health check map. For the interface that has been recorded, it is necessary to judge the error rate and update it in time.<br>
In addition, the premise of triggering the circuit breaker is the request The amount has to reach a certain threshold.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">/*
</span><span style="color:#75715e">    Failed record
</span><span style="color:#75715e">    whether exists in api map,
</span><span style="color:#75715e">        - yes:
</span><span style="color:#75715e">            - record access and error count
</span><span style="color:#75715e">            - the percentage of failures reaches the threshold? yes, mark as paused
</span><span style="color:#75715e">        - no:
</span><span style="color:#75715e">            update in global map for access and error count
</span><span style="color:#75715e">*/</span>
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">CircuitBreakerImp</span>) <span style="color:#a6e22e">Failed</span>(<span style="color:#a6e22e">key</span> <span style="color:#66d9ef">string</span>) {
    <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">Lock</span>()
    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">Unlock</span>()

    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">api</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">apiMap</span>[<span style="color:#a6e22e">key</span>]; <span style="color:#a6e22e">ok</span> {
        <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">accessed</span>(<span style="color:#a6e22e">api</span>)
        <span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">errCount</span><span style="color:#f92672">++</span>

        <span style="color:#a6e22e">errRate</span> <span style="color:#f92672">:=</span> float64(<span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">errCount</span>) <span style="color:#f92672">/</span> float64(<span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">totalCount</span>)
        <span style="color:#75715e">// access count reaches the threshold &amp;&amp; failures rate above the fuse limit
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">totalCount</span> &gt; <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">minCheck</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">errRate</span> &gt; <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">cbkErrRate</span> {
            <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Warnf</span>(<span style="color:#e6db74">&#34;# Trigger CBK！: %v, total: %v, &#34;</span><span style="color:#f92672">+</span>
                <span style="color:#e6db74">&#34;errRate: %.3f.&#34;</span>, <span style="color:#a6e22e">key</span>, <span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">totalCount</span>, <span style="color:#a6e22e">errRate</span>)
            <span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">isPaused</span> = <span style="color:#66d9ef">true</span>
        }
    } <span style="color:#66d9ef">else</span> {
        <span style="color:#a6e22e">api</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">apiSnapShop</span>{}
        <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">accessed</span>(<span style="color:#a6e22e">api</span>)
        <span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">errCount</span><span style="color:#f92672">++</span>
        <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">apiMap</span>[<span style="color:#a6e22e">key</span>] = <span style="color:#a6e22e">api</span>
    }
}
</code></pre></div><hr>
<p><strong>Access permission query</strong>, Based on the core function of the function circuit breaker implemented above, it is necessary to provide the gateway layer with a circuit breaker status to obtain the current interface.<br>
The following is the <strong>access query</strong> provided for the caller.</p>
<p>One question here, isn&rsquo;t the <code>IsBreak()</code> function already implemented above, why do we need the <code>CanAccess()</code> function?<br>
Well, because <code>IsBreak()</code> returns only the blown state of the interface, but don&rsquo;t forget that there is a &ldquo;half-closed state&rdquo; in the fuse phase, that is, if the fuse time passes the recovery period (cooling off period), then access rights can be released, so this part of the logic is processed in <code>CanAccess()</code>, let&rsquo;s take a look at the code.<br>
Among them, the input key represents the identifier of the interface to be accessed by the gateway layer, such as <code>/get-hello</code>, and the return value of the function indicates the accessible status of the interface.</p>
<blockquote>
<p>During the fuse cycle, if the recovery period (cooling-off period) has passed, you can release access, or call the <code>Successd()</code> fuse state to temporarily recover, otherwise the fuse state will remain, and the interface will be restricted and fast The core code that fails is here.</p>
</blockquote>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">c</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">CircuitBreakerImp</span>) <span style="color:#a6e22e">CanAccess</span>(<span style="color:#a6e22e">key</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">bool</span> {
    <span style="color:#75715e">/*
</span><span style="color:#75715e">        return the api&#39;s status of isPaused
</span><span style="color:#75715e">        - not paused, return true
</span><span style="color:#75715e">        - paused, return whether current time oldder then recovery period
</span><span style="color:#75715e">    */</span>
    <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">RLock</span>()
    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">lock</span>.<span style="color:#a6e22e">RUnlock</span>()
    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Debugf</span>(<span style="color:#e6db74">&#34;# Cbk check accessable for api id-%v key&#34;</span>, <span style="color:#a6e22e">reqType</span>)

    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">api</span>, <span style="color:#a6e22e">ok</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">apiMap</span>[<span style="color:#a6e22e">key</span>]; <span style="color:#a6e22e">ok</span> {
        <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Debugf</span>(<span style="color:#e6db74">&#34;# Cbk detail for api id-%v key, total: %v, &#34;</span><span style="color:#f92672">+</span>
            <span style="color:#e6db74">&#34;errCount: %v, paused: %v&#34;</span>, <span style="color:#a6e22e">reqType</span>, <span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">totalCount</span>,
            <span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">errCount</span>, <span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">isPaused</span>)
            
        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">isPaused</span> {            
            <span style="color:#a6e22e">latency</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">util</span>.<span style="color:#a6e22e">Abs64</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Now</span>().<span style="color:#a6e22e">UnixNano</span>() <span style="color:#f92672">-</span> <span style="color:#a6e22e">api</span>.<span style="color:#a6e22e">accessLast</span>)
            <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">latency</span> &lt; int64(<span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">recoverInterval</span>) {
                <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">false</span>
            }
            <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Warnf</span>(<span style="color:#e6db74">&#34;# Trigger: The CBK has passed the recovery period: %v, key: %v!&#34;</span>, <span style="color:#a6e22e">c</span>.<span style="color:#a6e22e">recoverInterval</span>, <span style="color:#a6e22e">key</span>)
        }
    }    
    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">true</span>
}
</code></pre></div><h2 id="unit-test">Unit Test</h2>
<p>Based on the above implementation, next write test code to cover the case, demonstrate and keep these two processes in loop scrolling:</p>
<ul>
<li><strong>Fail -&gt; Keep failed -&gt; Fuse on -&gt; Cooldown time elapsed</strong></li>
<li><strong>Enter Recovery Period -&gt; Continue Access</strong></li>
</ul>
<h3 id="mock-api-access">Mock API Access</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">const</span> <span style="color:#a6e22e">API_PREFIX</span> = <span style="color:#e6db74">&#34;/fake-api&#34;</span>
<span style="color:#66d9ef">var</span> (
    <span style="color:#a6e22e">HasCbk</span> = <span style="color:#66d9ef">false</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">StartJob</span>(<span style="color:#a6e22e">cbk</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">CircuitBreakerImp</span>) {
    <span style="color:#66d9ef">for</span> {
        <span style="color:#75715e">// 1 failure per second, parameter 0 means failed, 1 means success
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">ReqForTest</span>(<span style="color:#a6e22e">cbk</span>, <span style="color:#ae81ff">0</span>)
        <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Sleep</span>(<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">1</span>)
    }
}

<span style="color:#75715e">// Build request scheduling, fuse to restore it and let it succeed 1 time
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">ReqForTest</span>(<span style="color:#a6e22e">cbk</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">CircuitBreakerImp</span>, <span style="color:#a6e22e">req</span> <span style="color:#66d9ef">int</span>) {
    <span style="color:#75715e">// mock failed case
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">mockAPI</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">API_PREFIX</span> <span style="color:#75715e">//+ strconv.Itoa(req)
</span><span style="color:#75715e"></span>    <span style="color:#75715e">//log.Infof(&#34;Ready to reqForTest: %s, req-id-%v&#34;, HOST_PREFIX+mockAPI, req)
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">cbk</span>.<span style="color:#a6e22e">CanAccess</span>(<span style="color:#a6e22e">mockAPI</span>, <span style="color:#a6e22e">req</span>) {
        <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Warnf</span>(<span style="color:#e6db74">&#34;Api: %v is break, req-id-%v, wait for next round or success for one...&#34;</span>, <span style="color:#a6e22e">mockAPI</span>, <span style="color:#a6e22e">req</span>)
        <span style="color:#a6e22e">HasCbk</span> = <span style="color:#66d9ef">true</span>
        <span style="color:#66d9ef">return</span>
    } <span style="color:#66d9ef">else</span> {
        <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;Request can access: %s, req-id-%v&#34;</span>, <span style="color:#a6e22e">HOST_PREFIX</span><span style="color:#f92672">+</span><span style="color:#a6e22e">mockAPI</span>, <span style="color:#a6e22e">req</span>)
        <span style="color:#75715e">// After the recovery period, after the circuit breaker is recovered, skip the error and let it succeed
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">HasCbk</span> <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">req</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
            <span style="color:#a6e22e">HasCbk</span> = <span style="color:#66d9ef">false</span>
            <span style="color:#a6e22e">req</span> = <span style="color:#ae81ff">1</span>
            <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Warnf</span>(<span style="color:#e6db74">&#34;Transfer fail to success: %s, req-id-%v&#34;</span>, <span style="color:#a6e22e">HOST_PREFIX</span><span style="color:#f92672">+</span><span style="color:#a6e22e">mockAPI</span>, <span style="color:#a6e22e">req</span>)
        }
    }

    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">req</span> <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span> {
        <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;# Meet failed ReqForTest: %s&#34;</span>, <span style="color:#a6e22e">HOST_PREFIX</span><span style="color:#f92672">+</span><span style="color:#a6e22e">mockAPI</span>)
        <span style="color:#a6e22e">cbk</span>.<span style="color:#a6e22e">Failed</span>(<span style="color:#a6e22e">mockAPI</span>)
    } <span style="color:#66d9ef">else</span> {
        <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Infof</span>(<span style="color:#e6db74">&#34;# Meet success ReqForTest: %s&#34;</span>, <span style="color:#a6e22e">HOST_PREFIX</span><span style="color:#f92672">+</span><span style="color:#a6e22e">mockAPI</span>)
        <span style="color:#a6e22e">cbk</span>.<span style="color:#a6e22e">Succeed</span>(<span style="color:#a6e22e">mockAPI</span>)
    }
}
</code></pre></div><h3 id="initialize-the-fuse">Initialize the fuse</h3>
<p>Initialize the circuit breaker and assign relevant parameters</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">cbk</span> <span style="color:#f92672">:=</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">CircuitBreakerImp</span>{}
<span style="color:#a6e22e">cbk</span>.<span style="color:#a6e22e">apiMap</span> = make(<span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#f92672">*</span><span style="color:#a6e22e">apiSnapShop</span>)
<span style="color:#75715e">// 15s per round to reset the err rate
</span><span style="color:#75715e"></span><span style="color:#a6e22e">cbk</span>.<span style="color:#a6e22e">roundInterval</span> = <span style="color:#a6e22e">util</span>.<span style="color:#a6e22e">ToDuration</span>(<span style="color:#ae81ff">15</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
<span style="color:#75715e">// when breaker is triggered, recover for next try
</span><span style="color:#75715e"></span><span style="color:#a6e22e">cbk</span>.<span style="color:#a6e22e">recoverInterval</span> = <span style="color:#a6e22e">util</span>.<span style="color:#a6e22e">ToDuration</span>(<span style="color:#ae81ff">5</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Second</span>)
<span style="color:#75715e">// consider the api at least request for 5 time durning the round interval
</span><span style="color:#75715e"></span><span style="color:#a6e22e">cbk</span>.<span style="color:#a6e22e">minCheck</span> = <span style="color:#ae81ff">5</span>
<span style="color:#75715e">// when error rate comes to 50%, circuit breaker triggered
</span><span style="color:#75715e"></span><span style="color:#a6e22e">cbk</span>.<span style="color:#a6e22e">cbkErrRate</span> = <span style="color:#ae81ff">0.5</span>
</code></pre></div><h3 id="output-explanation">Output explanation</h3>
<p><img src="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/blog/cbk/en-cbk-output.png" alt="CBK status"></p>
<p>As we expected, although the failure rate of the first 5 requests on the interface is 100%, the request volume has not increased, so the circuit breaker is not triggered until continued fusing condition is met, breaker trigged.<br>
After the breaker trigged lasts for 5 seconds, it turns to the idle period, the API becomes accessible, and the interface is accessed again. If the error rate is still satisfied, the fuse state will continue to be restored.</p>
<p>And after the reset cycle, the API count is reset, and it returns to the state where the program was started, and the interface resumes <strong>continuous accessible</strong> until the error rate is reached and the fuse is turned on.</p>
<h2 id="summary">Summary</h2>
<p>At this point, a simple circuit breaker implementation has been completed. At the beginning, many of the concepts are easy to get around. Later, combined with scene simulation and code debugging, as well as the state transition picture at the beginning, it is easy to understand. Although many off-the-shelf components are available out of the box, their internal implementation is not so unfathomable as long as you put some thought into it.</p>
<h2 id="project-link">Project link</h2>
<p><a href="https://github.com/pixeldin/cbk-s1mpl3">https://github.com/pixeldin/cbk-s1mpl3</a></p>
<h2 id="references">References</h2>
<p><strong>Circuit Breaker Pattern</strong><br>
<a href="https://docs.microsoft.com/en-us/previous-versions/msp-n-p/dn589784(v=pandp.10)">https://docs.microsoft.com/en-us/previous-versions/msp-n-p/dn589784(v=pandp.10)</a><br>
<strong>Sony&rsquo;s implement of gobreaker</strong><br>
<a href="https://github.com/sony/gobreaker">https://github.com/sony/gobreaker</a><br>
<strong>微服务架构中的熔断器设计与实现</strong><br>
<a href="https://mp.weixin.qq.com/s/DGRnUhyv6SS_E36ZQKGpPA">https://mp.weixin.qq.com/s/DGRnUhyv6SS_E36ZQKGpPA</a></p>
              
            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="/en/tags/circuit-breaker/">circuit breaker</a>

  <a class="tag tag--primary tag--small" href="/en/tags/talk-about-go/">Talk about Go</a>

                  </div>
                
              
            
            <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="/en/2022/03/talk-about-go-goroutines-information-and-how-to-prevent-goroutine-leaks/" data-tooltip="Talk about Go: Goroutine&#39;s information and how to prevent goroutine leaks">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="/en/2022/02/talk-about-go-network-programming-about-grouping-and-unpacking-in-tcp-flow/" data-tooltip="Talk about Go: Network programming about grouping and unpacking in TCP flow">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
      
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#">
        
          <i class="fa fa-list"></i>
        </a>
      </li>
    </ul>
  
</div>

            
              
            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2022 <a href="https://github.com/pixeldin">pixeldin</a>. All Rights Reserved
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
        <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="/en/2022/03/talk-about-go-goroutines-information-and-how-to-prevent-goroutine-leaks/" data-tooltip="Talk about Go: Goroutine&#39;s information and how to prevent goroutine leaks">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="/en/2022/02/talk-about-go-network-programming-about-grouping-and-unpacking-in-tcp-flow/" data-tooltip="Talk about Go: Network programming about grouping and unpacking in TCP flow">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
      
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#">
        
          <i class="fa fa-list"></i>
        </a>
      </li>
    </ul>
  
</div>

      </div>
      <div id="share-options-bar" class="share-options-bar" data-behavior="5">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/pig.jpg" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">pixelpig</h4>
    
      <div id="about-card-bio">a backend development living in GD, China. Stay hungry, stay foolish <strong>:）</strong></div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Golang developer@Huya
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        CHINA-GD
      </div>
    
  </div>
</div>

    

    
  
    <div id="cover" style="background-image:url('https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/cover.jpg');"></div>
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.7/js/jquery.fancybox.min.js" integrity="sha256-GEAnjcTqVP+vBp3SSc8bEDQqvWAZMiHyUSIorrWwH50=" crossorigin="anonymous"></script>


<script src="/js/script-pcw6v3xilnxydl1vddzazdverrnn9ctynvnxgwho987mfyqkuylcb1nlt.min.js"></script>


<script lang="javascript">
window.onload = updateMinWidth;
window.onresize = updateMinWidth;
document.getElementById("sidebar").addEventListener("transitionend", updateMinWidth);
function updateMinWidth() {
  var sidebar = document.getElementById("sidebar");
  var main = document.getElementById("main");
  main.style.minWidth = "";
  var w1 = getComputedStyle(main).getPropertyValue("min-width");
  var w2 = getComputedStyle(sidebar).getPropertyValue("width");
  var w3 = getComputedStyle(sidebar).getPropertyValue("left");
  main.style.minWidth = `calc(${w1} - ${w2} - ${w3})`;
}
</script>

<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>


  
    
  




    
  </body>
</html>

