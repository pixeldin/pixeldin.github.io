<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.80.0 with theme Tranquilpeak 0.4.8-BETA">
<meta name="author" content="pixelpig">
<meta name="keywords" content="">
<meta name="description" content="As we all know, packet body transmission is an import part of network communication, whether it is the header or body of HTTP packets at the application layer, or the streaming data of TCP at the transport layer.">


<meta property="og:description" content="As we all know, packet body transmission is an import part of network communication, whether it is the header or body of HTTP packets at the application layer, or the streaming data of TCP at the transport layer.">
<meta property="og:type" content="article">
<meta property="og:title" content="Talk about Go: Network programming about grouping and unpacking in TCP flow">
<meta name="twitter:title" content="Talk about Go: Network programming about grouping and unpacking in TCP flow">
<meta property="og:url" content="/en/2022/02/talk-about-go-network-programming-about-grouping-and-unpacking-in-tcp-flow/">
<meta property="twitter:url" content="/en/2022/02/talk-about-go-network-programming-about-grouping-and-unpacking-in-tcp-flow/">
<meta property="og:site_name" content="pixelpig.space">
<meta property="og:description" content="As we all know, packet body transmission is an import part of network communication, whether it is the header or body of HTTP packets at the application layer, or the streaming data of TCP at the transport layer.">
<meta name="twitter:description" content="As we all know, packet body transmission is an import part of network communication, whether it is the header or body of HTTP packets at the application layer, or the streaming data of TCP at the transport layer.">
<meta property="og:locale" content="en">

  
    <meta property="article:published_time" content="2022-02-04T00:00:00">
  
  
    <meta property="article:modified_time" content="2022-02-04T00:00:00">
  
  
  
    
      <meta property="article:section" content="Go">
    
      <meta property="article:section" content="Network">
    
      <meta property="article:section" content="TCP">
    
  
  
    
      <meta property="article:tag" content="Talk about Go">
    
  


<meta name="twitter:card" content="summary">

  <meta name="twitter:site" content="@pixelpigpigpig">


  <meta name="twitter:creator" content="@pixelpigpigpig">






  <meta property="og:image" content="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/blog/tcp-pack/tcp-cover.png">
  <meta property="twitter:image" content="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/blog/tcp-pack/tcp-cover.png">





  <meta property="og:image" content="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/pig.jpg">
  <meta property="twitter:image" content="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/pig.jpg">


    <title>Talk about Go: Network programming about grouping and unpacking in TCP flow</title>

    <link rel="icon" href="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/blog/static/pig_round_circle.png">
    

    

    <link rel="canonical" href="/en/2022/02/talk-about-go-network-programming-about-grouping-and-unpacking-in-tcp-flow/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.min.css" integrity="sha256-vuXZ9LGmmwtjqFX1F+EKin1ThZMub58gKULUyf0qECk=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.css" integrity="sha256-SEa4XYAHihTcEP1f5gARTB2K26Uk8PsndQYHQC1f4jU=" crossorigin="anonymous" />
    
    
    <link rel="stylesheet" href="/css/style-qwvgrytlhpmhkj82t4ss9bygjnonvcnicxnmlqiwvstfkju0uynqoamj0jm.min.css" />
    
    

    
      
    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="4">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="/en/">pixelpig.space</a>
  </div>
  
    
      <a class="header-right-picture "
         href="/#about">
    
    
    
      
        <img class="header-picture" src="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/pig.jpg" alt="Author&#39;s picture" />
      
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="4">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="/#about">
          <img class="sidebar-profile-picture" src="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/pig.jpg" alt="Author&#39;s picture" />
        </a>
        <h4 class="sidebar-profile-name">pixelpig</h4>
        
          <h5 class="sidebar-profile-bio">Keep it simple, so as this bio :)</h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/zh">
    
      <i class="sidebar-button-icon fa fa-lg fa-language"></i>
      
      <span class="sidebar-button-desc">简/中</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/en/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">Home</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/en/categories">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">Categories</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/en/tags">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">Tags</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/en/archives">
    
      <i class="sidebar-button-icon fa fa-lg fa-archive"></i>
      
      <span class="sidebar-button-desc">Archives</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/en/#about">
    
      <i class="sidebar-button-icon fa fa-lg fa-question-circle"></i>
      
      <span class="sidebar-button-desc">About me</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://twitter.com/pixelpigpigpig/" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-twitter"></i>
      
      <span class="sidebar-button-desc">Twitter</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="https://github.com/pixeldin" target="_blank" rel="noopener">
    
      <i class="sidebar-button-icon fa fa-lg fa-github-alt"></i>
      
      <span class="sidebar-button-desc">pixeldin</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="4"
        class="
               hasCoverMetaIn
               ">
        <article class="post" itemscope itemType="http://schema.org/BlogPosting">
          
          
            <div class="post-header main-content-wrap text-left">
  
    <h1 class="post-title" itemprop="headline">
      Talk about Go: Network programming about grouping and unpacking in TCP flow
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time itemprop="datePublished" datetime="2022-02-04T00:00:00Z">
        
  February 4, 2022

      </time>
    
    
  
  
    <span>in</span>
    
      <a class="category-link" href="/en/categories/go">Go</a>, 
    
      <a class="category-link" href="/en/categories/network">Network</a>, 
    
      <a class="category-link" href="/en/categories/tcp">TCP</a>
    
  

  </div>

</div>
          
          <div class="post-content markdown" itemprop="articleBody">
            <div class="main-content-wrap">
              <p>As we all know, packet body transmission is an import part of network communication, whether it is the <code>header</code> or <code>body</code> of HTTP packets at the application layer, or the streaming data of TCP at the transport layer.</p>
<h2 id="foreword">Foreword</h2>
<p>Today, let&rsquo;s talk about the topic of packet body transmission in network communication. This article will compare the common packet body analysis methods in network programming from several practical application examples.</p>
<h2 id="concept">Concept</h2>
<p>Before entering the topic, let&rsquo;s sort out the related concepts of TCP connections in the network. The packets in the network connection are like boats one after another in the river.<br>
<img src="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/blog/tcp-pack/river-cover.png" alt="TCP flow and pack"></p>
<h3 id="tcp-connection">TCP Connection</h3>
<p>The establishment of a network connection, a TCP connection is composed of four tuples, namely <code>source IP + source port &lt;-&gt; target ip + target port </code>, The bottom layer is composed of file descriptor, also known as fd, so without considering connection multiplexing, the number of single-machine connections will be limited by the number of available file descriptor.</p>
<h3 id="transmission-format">Transmission format</h3>
<p>After the connection is established, the server and the client will each send and receive the connection. Since interaction is involved, a transmission format must be agreed. For example, the language format of the communication between the two countries, AB, is the unified use of which country Language, the order of the sentence, such as subject-predicate-object, etc.</p>
<h3 id="serialization">Serialization</h3>
<p>After the transmission format is agreed, the data needs to be processed in the network transmission, because the computer prefers the binary byte stream, so it is what we often call serialization. The information after serialization is equivalent to compressing it, saving the network bandwidth.<br>
A frequently discussed topic about serialization is <strong>big endian and little endian</strong>, which refers to whether to transmit the high-order byte address first or the low-order byte address first.</p>
<p>There is a corresponding API in <code>Go</code> to specify binary encoding/decoding:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// little endian: byte order starts with low address
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">LittleEndian</span> <span style="color:#a6e22e">littleEndian</span>

<span style="color:#75715e">// big endian: byte order starts with high address
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">BigEndian</span> <span style="color:#a6e22e">bigEndian</span>

<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">buf</span>, <span style="color:#a6e22e">LittleEndian</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">b1</span>)
<span style="color:#a6e22e">Read</span>(<span style="color:#a6e22e">buf</span>, <span style="color:#a6e22e">LittleEndian</span>, <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">p</span>)
</code></pre></div><p>Regarding the serialization method of binary big endian and little endian, you can see examples from the following Go open source projects:</p>
<h4 id="bigcache-local-cache-serialization">BigCache: Local cache serialization</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">wrapEntry</span>(<span style="color:#a6e22e">timestamp</span> <span style="color:#66d9ef">uint64</span>, <span style="color:#a6e22e">hash</span> <span style="color:#66d9ef">uint64</span>, <span style="color:#a6e22e">key</span> <span style="color:#66d9ef">string</span>, <span style="color:#a6e22e">entry</span> []<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">buffer</span> <span style="color:#f92672">*</span>[]<span style="color:#66d9ef">byte</span>) []<span style="color:#66d9ef">byte</span> {
	<span style="color:#a6e22e">keyLength</span> <span style="color:#f92672">:=</span> len(<span style="color:#a6e22e">key</span>)
	<span style="color:#a6e22e">blobLength</span> <span style="color:#f92672">:=</span> len(<span style="color:#a6e22e">entry</span>) <span style="color:#f92672">+</span> <span style="color:#a6e22e">headersSizeInBytes</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">keyLength</span>
	<span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">binary</span>.<span style="color:#a6e22e">LittleEndian</span>.<span style="color:#a6e22e">PutUint64</span>(<span style="color:#a6e22e">blob</span>, <span style="color:#a6e22e">timestamp</span>)
	<span style="color:#a6e22e">binary</span>.<span style="color:#a6e22e">LittleEndian</span>.<span style="color:#a6e22e">PutUint64</span>(<span style="color:#a6e22e">blob</span>[<span style="color:#a6e22e">timestampSizeInBytes</span>:], <span style="color:#a6e22e">hash</span>)
	<span style="color:#a6e22e">binary</span>.<span style="color:#a6e22e">LittleEndian</span>.<span style="color:#a6e22e">PutUint16</span>(<span style="color:#a6e22e">blob</span>[<span style="color:#a6e22e">timestampSizeInBytes</span><span style="color:#f92672">+</span><span style="color:#a6e22e">hashSizeInBytes</span>:], uint16(<span style="color:#a6e22e">keyLength</span>))
	copy(<span style="color:#a6e22e">blob</span>[<span style="color:#a6e22e">headersSizeInBytes</span>:], <span style="color:#a6e22e">key</span>)
	copy(<span style="color:#a6e22e">blob</span>[<span style="color:#a6e22e">headersSizeInBytes</span><span style="color:#f92672">+</span><span style="color:#a6e22e">keyLength</span>:], <span style="color:#a6e22e">entry</span>)

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">blob</span>[:<span style="color:#a6e22e">blobLength</span>]
}
</code></pre></div><h4 id="grpc-framed-messages-in-a-marked-byte-stream">grpc: Framed messages in a marked byte stream</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// MakeFrame creates a handshake frame.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">MakeFrame</span>(<span style="color:#a6e22e">pl</span> <span style="color:#66d9ef">string</span>) []<span style="color:#66d9ef">byte</span> {
	<span style="color:#a6e22e">f</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, len(<span style="color:#a6e22e">pl</span>)<span style="color:#f92672">+</span><span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">MsgLenFieldSize</span>)
	<span style="color:#a6e22e">binary</span>.<span style="color:#a6e22e">LittleEndian</span>.<span style="color:#a6e22e">PutUint32</span>(<span style="color:#a6e22e">f</span>, uint32(len(<span style="color:#a6e22e">pl</span>)))
	copy(<span style="color:#a6e22e">f</span>[<span style="color:#a6e22e">conn</span>.<span style="color:#a6e22e">MsgLenFieldSize</span>:], []byte(<span style="color:#a6e22e">pl</span>))
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">f</span>
}
</code></pre></div><h3 id="packing-and-unpacking">Packing and Unpacking</h3>
<p>Whether in big-endian or little-endian mode, the information obtained from the serialized byte stream after deserialization is also called <strong>packet</strong>. The next step is to semantically parse the packet.<br>
We all know that in a TCP stream, data packets are ordered, but in a pipeline of data, how does the application layer know the start and end of the data, that is, how to distinguish whether a certain piece of data belongs to the previous request or the next request , This is often referred to as unpacking and sticking. There are generally two solutions:</p>
<h4 id="tip-1-agree-on-special-separators">Tip 1: Agree on special separators</h4>
<p>Let&rsquo;s take a look at the usage scenarios. The most common case is like <strong>HTTP</strong>. Let&rsquo;s see how it is agreed:<br>
<img src="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/blog/tcp-pack/en-HTTP%20protocol.png" alt="HTTP protocol">
Use <code>CRLF(Carriage Return and Line Feed)</code> as the delimiter,</p>
<ol>
<li>Separate request method, URL, and protocol by spaces</li>
<li>Identified by <code>:</code> as a key-value pair</li>
<li>If <code>:</code> is not found, it means that the header parsing is over, and the next <code>CRLF</code> is followed by the body.</li>
</ol>
<p>We simulate a <strong>HTTP</strong> request, and use the <strong>WireShark</strong> software to capture and analyze the packet, and get the original text as follows:
<img src="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/blog/tcp-pack/WireShark_req.png" alt="WireShark parse">
It can be seen that with <code>\r\n</code> as the delimiter, the segmentation rules are in line with the protocol standards. (Note: Because this is a standard HTTP protocol instead of HTTPS, it is not encrypted, so the transmitted message is displayed in clear text)</p>
<p>Another typical example is also commonly used, which is the Redis protocol. Let&rsquo;s take a look at how Redis agrees:</p>
<p>Refer to <a href="https://redis.io/docs/reference/protocol-spec/">RESP Official Protocol</a>, Redis also uses <code>\r\n</code> as a separator, and each Redis command has a corresponding The prefix characters of ** are matched, which basically covers our daily needs of using <strong>Redis API</strong>.</p>
<blockquote>
<ul>
<li>For Simple Strings, the first byte of the reply is &ldquo;+&rdquo;</li>
<li>For Errors, the first byte of the reply is &ldquo;-&rdquo;</li>
<li>For Integers, the first byte of the reply is &ldquo;:&rdquo;</li>
<li>For Bulk Strings, the first byte of the reply is &ldquo;$&rdquo;</li>
<li>For Arrays, the first byte of the reply is &ldquo;*&rdquo;</li>
</ul>
</blockquote>
<p><strong>Redigo driver package</strong><br>
Let&rsquo;s take a look at how <strong>Redis</strong> is parsed in the Go driver. The following code is quoted from the go-redis driver</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">const</span> (
    <span style="color:#75715e">// convention prefix notation
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ErrorReply</span>  = <span style="color:#e6db74">&#39;-&#39;</span>   <span style="color:#75715e">// err type
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">StatusReply</span> = <span style="color:#e6db74">&#39;+&#39;</span>   <span style="color:#75715e">// simple type, such as &#34;+OK\r\n&#34;
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">IntReply</span>    = <span style="color:#e6db74">&#39;:&#39;</span>   <span style="color:#75715e">// integer type
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">StringReply</span> = <span style="color:#e6db74">&#39;$&#39;</span>   <span style="color:#75715e">// string type
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">ArrayReply</span>  = <span style="color:#e6db74">&#39;*&#39;</span>   <span style="color:#75715e">// array type, the number behind represents how many groups to bring
</span><span style="color:#75715e"></span>)

<span style="color:#75715e">//...
</span><span style="color:#75715e"></span>
<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">Reader</span>) <span style="color:#a6e22e">ReadReply</span>(<span style="color:#a6e22e">m</span> <span style="color:#a6e22e">MultiBulkParse</span>) (<span style="color:#66d9ef">interface</span>{}, <span style="color:#66d9ef">error</span>) {
	<span style="color:#a6e22e">line</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">ReadLine</span>()
	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">line</span>[<span style="color:#ae81ff">0</span>] {
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">ErrorReply</span>:
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">ParseErrorReply</span>(<span style="color:#a6e22e">line</span>)
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">StatusReply</span>:
		<span style="color:#66d9ef">return</span> string(<span style="color:#a6e22e">line</span>[<span style="color:#ae81ff">1</span>:]), <span style="color:#66d9ef">nil</span>
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">IntReply</span>:
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">util</span>.<span style="color:#a6e22e">ParseInt</span>(<span style="color:#a6e22e">line</span>[<span style="color:#ae81ff">1</span>:], <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">64</span>)
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">StringReply</span>:
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">readStringReply</span>(<span style="color:#a6e22e">line</span>)
	<span style="color:#66d9ef">case</span> <span style="color:#a6e22e">ArrayReply</span>:
		<span style="color:#a6e22e">n</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">parseArrayLen</span>(<span style="color:#a6e22e">line</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
		}
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">m</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;redis: got %.100q, but multi bulk parser is nil&#34;</span>, <span style="color:#a6e22e">line</span>)
			<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
		}
		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">m</span>(<span style="color:#a6e22e">r</span>, <span style="color:#a6e22e">n</span>)
	}
	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;redis: can&#39;t parse %.100q&#34;</span>, <span style="color:#a6e22e">line</span>)
}
</code></pre></div><p>According to the unit test case, the <strong>Redis</strong> command is converted by the packet protocol, and the format in <strong>Go</strong> is as follows:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">writeTests</span> = []<span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">args</span>     []<span style="color:#66d9ef">interface</span>{}
	<span style="color:#a6e22e">expected</span> <span style="color:#66d9ef">string</span>
}{
	{
		[]<span style="color:#66d9ef">interface</span>{}{<span style="color:#e6db74">&#34;SET&#34;</span>, <span style="color:#e6db74">&#34;key&#34;</span>, <span style="color:#e6db74">&#34;value&#34;</span>},
		<span style="color:#e6db74">&#34;*3\r\n$3\r\nSET\r\n$3\r\nkey\r\n$5\r\nvalue\r\n&#34;</span>,
	},
	{
		[]<span style="color:#66d9ef">interface</span>{}{<span style="color:#e6db74">&#34;SET&#34;</span>, <span style="color:#e6db74">&#34;key&#34;</span>, <span style="color:#e6db74">&#34;value&#34;</span>},
		<span style="color:#e6db74">&#34;*3\r\n$3\r\nSET\r\n$3\r\nkey\r\n$5\r\nvalue\r\n&#34;</span>,
	},
	{
		[]<span style="color:#66d9ef">interface</span>{}{<span style="color:#e6db74">&#34;SET&#34;</span>, <span style="color:#e6db74">&#34;key&#34;</span>, int64(<span style="color:#a6e22e">math</span>.<span style="color:#a6e22e">MinInt64</span>)},
		<span style="color:#e6db74">&#34;*3\r\n$3\r\nSET\r\n$3\r\nkey\r\n$20\r\n-9223372036854775808\r\n&#34;</span>,
	},
	{
		[]<span style="color:#66d9ef">interface</span>{}{<span style="color:#e6db74">&#34;SET&#34;</span>, <span style="color:#e6db74">&#34;key&#34;</span>, <span style="color:#a6e22e">durationArg</span>{<span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">Minute</span>}},
		<span style="color:#e6db74">&#34;*3\r\n$3\r\nSET\r\n$3\r\nkey\r\n$2\r\n60\r\n&#34;</span>,
	},
	{
		[]<span style="color:#66d9ef">interface</span>{}{<span style="color:#e6db74">&#34;SET&#34;</span>, <span style="color:#e6db74">&#34;key&#34;</span>, <span style="color:#a6e22e">recursiveArg</span>(<span style="color:#ae81ff">123</span>)},
		<span style="color:#e6db74">&#34;*3\r\n$3\r\nSET\r\n$3\r\nkey\r\n$3\r\n123\r\n&#34;</span>,
	},
	{
		[]<span style="color:#66d9ef">interface</span>{}{<span style="color:#e6db74">&#34;ECHO&#34;</span>, <span style="color:#66d9ef">true</span>, <span style="color:#66d9ef">false</span>},
		<span style="color:#e6db74">&#34;*3\r\n$4\r\nECHO\r\n$1\r\n1\r\n$1\r\n0\r\n&#34;</span>,
	},
}
</code></pre></div><p>The above is a case of packet restoration through special separators. Next, let&rsquo;s look at another common solution.</p>
<h4 id="tip-2-agree-fixed-interval-rules-and-then-read-according-to-the-length">Tip 2: Agree fixed interval rules, and then read according to the length</h4>
<p>This is called TLV (type-lenth-value), type-length-value. As the name implies, it is the first contract type, the second one agrees on the length to be read, and the end subscript is obtained according to the length.<br>
Sometimes type and length can be combined into one, for example, when type=1, the length is 3, when type=2, the length is 5, etc. According to the agreement between the server and the client, the agreement is as follows:
<img src="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/blog/tcp-pack/TCP_TLV.png" alt="TCP-tlv"></p>
<p>Before referring to the lightweight tcp server <a href="https://github.com/aceld/zinx">zinx framework</a> implemented by go, which includes the encapsulation and disassembly of the packet body in network communication, the protocol agreed by this framework is TLV way, let&rsquo;s take a look at its implementation details:
<img src="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/blog/tcp-pack/en-TCP%20protocol.png" alt="zinx-pack"></p>
<p>In the TCP flow, each network packet is divided into <code>Head</code> and <code>Body</code>, and each <code>Head</code> defines the <strong>data span</strong> and <strong>Business Id</strong> of the packet, the application layer can know the end subscript of <code>Body</code> according to the <strong>data span</strong> of the package when reading, so as to read the corresponding <code>Data </code> interval.</p>
<p>Code Example：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// Agreed on the structure of the Message body
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Message</span> <span style="color:#66d9ef">struct</span> {
	<span style="color:#a6e22e">DataLen</span> <span style="color:#66d9ef">uint32</span>
	<span style="color:#a6e22e">ID</span>      <span style="color:#66d9ef">uint32</span>
	<span style="color:#a6e22e">Data</span>    []<span style="color:#66d9ef">byte</span>
}

<span style="color:#75715e">// NewMsgPackage create a message pack
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NewMsgPackage</span>(<span style="color:#a6e22e">ID</span> <span style="color:#66d9ef">uint32</span>, <span style="color:#a6e22e">data</span> []<span style="color:#66d9ef">byte</span>) <span style="color:#f92672">*</span><span style="color:#a6e22e">Message</span> {
	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">Message</span>{
		<span style="color:#a6e22e">DataLen</span>: uint32(len(<span style="color:#a6e22e">data</span>)),
		<span style="color:#a6e22e">ID</span>:      <span style="color:#a6e22e">ID</span>,
		<span style="color:#a6e22e">Data</span>:    <span style="color:#a6e22e">data</span>,
	}
}

<span style="color:#75715e">// Packet method (compressed data)
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">dp</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">DataPack</span>) <span style="color:#a6e22e">Pack</span>(<span style="color:#a6e22e">msg</span> <span style="color:#a6e22e">ziface</span>.<span style="color:#a6e22e">IMessage</span>) ([]<span style="color:#66d9ef">byte</span>, <span style="color:#66d9ef">error</span>) {	
	<span style="color:#a6e22e">dataBuff</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">NewBuffer</span>([]<span style="color:#66d9ef">byte</span>{})

	<span style="color:#75715e">//1. write dataLen
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">binary</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">dataBuff</span>, <span style="color:#a6e22e">binary</span>.<span style="color:#a6e22e">LittleEndian</span>, <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">GetDataLen</span>()); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#75715e">//2. write msgID
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">binary</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">dataBuff</span>, <span style="color:#a6e22e">binary</span>.<span style="color:#a6e22e">LittleEndian</span>, <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">GetMsgID</span>()); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#75715e">//3. write data body
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">binary</span>.<span style="color:#a6e22e">Write</span>(<span style="color:#a6e22e">dataBuff</span>, <span style="color:#a6e22e">binary</span>.<span style="color:#a6e22e">LittleEndian</span>, <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">GetData</span>()); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
		<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>, <span style="color:#a6e22e">err</span>
	}

	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">dataBuff</span>.<span style="color:#a6e22e">Bytes</span>(), <span style="color:#66d9ef">nil</span>
}
</code></pre></div><p>The above is the encapsulation of the message. Let&rsquo;s see how to disassemble it on the reader side:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// header&#39;s fixed length span
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">defaultHeaderLen</span> <span style="color:#66d9ef">uint32</span> = <span style="color:#ae81ff">8</span>

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">dp</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">DataPack</span>) <span style="color:#a6e22e">GetHeadLen</span>() <span style="color:#66d9ef">uint32</span> {
	<span style="color:#75715e">//ID uint32(4 bytes) +  DataLen uint32(4 bytes)
</span><span style="color:#75715e"></span>	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">defaultHeaderLen</span>
}

<span style="color:#75715e">// handling client requests
</span><span style="color:#75715e"></span><span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>(<span style="color:#a6e22e">conn</span> <span style="color:#a6e22e">net</span>.<span style="color:#a6e22e">Conn</span>) {
	<span style="color:#75715e">// Create a packet unpacking object dp
</span><span style="color:#75715e"></span>	<span style="color:#a6e22e">dp</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">NewDataPack</span>()
	<span style="color:#66d9ef">for</span> {
		<span style="color:#75715e">// 1.read the head part of the stream
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">headData</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">dp</span>.<span style="color:#a6e22e">GetHeadLen</span>())
		<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadFull</span>(<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">headData</span>) <span style="color:#75715e">// ReadFull will fill up msg
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;read head error&#34;</span>)
		}
		<span style="color:#75715e">// 2.Unpack the headData byte stream into msg
</span><span style="color:#75715e"></span>		<span style="color:#a6e22e">msgHead</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">dp</span>.<span style="color:#a6e22e">Unpack</span>(<span style="color:#a6e22e">headData</span>)
		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
			<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;server unpack err:&#34;</span>, <span style="color:#a6e22e">err</span>)
			<span style="color:#66d9ef">return</span>
		}

        <span style="color:#75715e">// 3.when header span got length, reading the data
</span><span style="color:#75715e"></span>		<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">msgHead</span>.<span style="color:#a6e22e">GetDataLen</span>() &gt; <span style="color:#ae81ff">0</span> {
			
			<span style="color:#a6e22e">msg</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">msgHead</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">Message</span>)
			<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">Data</span> = make([]<span style="color:#66d9ef">byte</span>, <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">GetDataLen</span>())

			<span style="color:#75715e">// Read byte stream from io according to dataLen
</span><span style="color:#75715e"></span>			<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">io</span>.<span style="color:#a6e22e">ReadFull</span>(<span style="color:#a6e22e">conn</span>, <span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">Data</span>)
			<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
				<span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#e6db74">&#34;server unpack data err:&#34;</span>, <span style="color:#a6e22e">err</span>)
				<span style="color:#66d9ef">return</span>
			}
		}
	}
}(<span style="color:#a6e22e">conn</span>)
</code></pre></div><h2 id="references">References</h2>
<p>RESP Protocol</p>
<ul>
<li><a href="https://redis.io/docs/reference/protocol-spec/">https://redis.io/docs/reference/protocol-spec/</a></li>
</ul>
<p>Zinx TCP Communication Framework</p>
<ul>
<li><a href="https://www.kancloud.cn/aceld/zinx/1960226">https://www.kancloud.cn/aceld/zinx/1960226</a></li>
</ul>
              
            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">TAGGED IN</span><br/>
                    
  <a class="tag tag--primary tag--small" href="/en/tags/talk-about-go/">Talk about Go</a>

                  </div>
                
              
            
            <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="/en/2022/02/talk-about-go-a-simple-implement-of-circuit-breaker/" data-tooltip="Talk about Go: A simple implement of Circuit Breaker">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="/en/2021/12/talk-about-go-the-gracefully-handling-of-service-restart/" data-tooltip="Talk about Go: The gracefully handling of service restart">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#">
        
          <i class="fa fa-list"></i>
        </a>
      </li>
    </ul>
  
</div>

            
              
            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2025 <a href="https://github.com/pixeldin">pixeldin</a>. All Rights Reserved
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="4">
        <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="/en/2022/02/talk-about-go-a-simple-implement-of-circuit-breaker/" data-tooltip="Talk about Go: A simple implement of Circuit Breaker">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">NEXT</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="/en/2021/12/talk-about-go-the-gracefully-handling-of-service-restart/" data-tooltip="Talk about Go: The gracefully handling of service restart">
              
                  <span class="hide-xs hide-sm text-small icon-mr">PREVIOUS</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#">
        
          <i class="fa fa-list"></i>
        </a>
      </li>
    </ul>
  
</div>

      </div>
      <div id="share-options-bar" class="share-options-bar" data-behavior="4">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/pig.jpg" alt="Author&#39;s picture" />
    
    <h4 id="about-card-name">pixelpig</h4>
    
      <div id="about-card-bio">Keep it simple, so as this bio :)</div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        Software Developer
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        Guangdong - China
      </div>
    
  </div>
</div>

    

    
  
    <div id="cover" style="background-image:url('https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/cover.jpg');"></div>
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.7/js/jquery.fancybox.min.js" integrity="sha256-GEAnjcTqVP+vBp3SSc8bEDQqvWAZMiHyUSIorrWwH50=" crossorigin="anonymous"></script>


<script src="/js/script-0w8lsjkqkmgcwwmpghswuivbbbc4ghmfi8t2mn0xl0kqmiy2wucu0zovfp7b.min.js"></script>


<script lang="javascript">
window.onload = updateMinWidth;
window.onresize = updateMinWidth;
document.getElementById("sidebar").addEventListener("transitionend", updateMinWidth);
function updateMinWidth() {
  var sidebar = document.getElementById("sidebar");
  var main = document.getElementById("main");
  main.style.minWidth = "";
  var w1 = getComputedStyle(main).getPropertyValue("min-width");
  var w2 = getComputedStyle(sidebar).getPropertyValue("width");
  var w3 = getComputedStyle(sidebar).getPropertyValue("left");
  main.style.minWidth = `calc(${w1} - ${w2} - ${w3})`;
}
</script>

<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>


  
    
  




    
  </body>
</html>

