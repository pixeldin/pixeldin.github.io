<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.80.0 with theme Tranquilpeak 0.4.8-BETA">
<meta name="author" content="pixelpig">
<meta name="keywords" content="">
<meta name="description" content="协程在Go里面是一个常见的概念，伴随着go程序的生命周期开始至结束。今天来聊一聊Go的协程泄露。">


<meta property="og:description" content="协程在Go里面是一个常见的概念，伴随着go程序的生命周期开始至结束。今天来聊一聊Go的协程泄露。">
<meta property="og:type" content="article">
<meta property="og:title" content="聊一聊Go的协程泄露">
<meta name="twitter:title" content="聊一聊Go的协程泄露">
<meta property="og:url" content="/2021/09/%E8%81%8A%E4%B8%80%E8%81%8Ago%E7%9A%84%E5%8D%8F%E7%A8%8B%E6%B3%84%E9%9C%B2/">
<meta property="twitter:url" content="/2021/09/%E8%81%8A%E4%B8%80%E8%81%8Ago%E7%9A%84%E5%8D%8F%E7%A8%8B%E6%B3%84%E9%9C%B2/">
<meta property="og:site_name" content="Pixelpig&#39;s blog">
<meta property="og:description" content="协程在Go里面是一个常见的概念，伴随着go程序的生命周期开始至结束。今天来聊一聊Go的协程泄露。">
<meta name="twitter:description" content="协程在Go里面是一个常见的概念，伴随着go程序的生命周期开始至结束。今天来聊一聊Go的协程泄露。">
<meta property="og:locale" content="zh-cn">

  
    <meta property="article:published_time" content="2021-09-11T00:00:00">
  
  
    <meta property="article:modified_time" content="2021-09-11T00:00:00">
  
  
  
    
      <meta property="article:section" content="Go">
    
      <meta property="article:section" content="后端">
    
  
  
    
      <meta property="article:tag" content="协程">
    
      <meta property="article:tag" content="debug">
    
  


<meta name="twitter:card" content="summary">







  <meta property="og:image" content="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/blog/routine.PNG">
  <meta property="twitter:image" content="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/blog/routine.PNG">





  <meta property="og:image" content="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/pig.jpg">
  <meta property="twitter:image" content="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/pig.jpg">


    <title>聊一聊Go的协程泄露</title>

    <link rel="icon" href="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/blog/static/pixel.ico">
    

    

    <link rel="canonical" href="/2021/09/%E8%81%8A%E4%B8%80%E8%81%8Ago%E7%9A%84%E5%8D%8F%E7%A8%8B%E6%B3%84%E9%9C%B2/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.min.css" integrity="sha256-vuXZ9LGmmwtjqFX1F+EKin1ThZMub58gKULUyf0qECk=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.css" integrity="sha256-SEa4XYAHihTcEP1f5gARTB2K26Uk8PsndQYHQC1f4jU=" crossorigin="anonymous" />
    
    
    <link rel="stylesheet" href="/css/style-twzjdbqhmnnacqs0pwwdzcdbt8yhv8giawvjqjmyfoqnvazl0dalmnhdkvp7.min.css" />
    
    

    
      
    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="5">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="/">Pixelpig&#39;s blog</a>
  </div>
  
    
      <a class="header-right-picture "
         href="/#about">
    
    
    
      
        <img class="header-picture" src="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/pig.jpg" alt="作者的图片" />
      
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="5">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="/#about">
          <img class="sidebar-profile-picture" src="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/pig.jpg" alt="作者的图片" />
        </a>
        <h4 class="sidebar-profile-name">pixelpig</h4>
        
          <h5 class="sidebar-profile-bio">Stay hungry, stay foolish <strong>:）</strong></h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">首页</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/categories">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">分类</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/tags">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">标签</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/archives">
    
      <i class="sidebar-button-icon fa fa-lg fa-archive"></i>
      
      <span class="sidebar-button-desc">归档</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/#about">
    
      <i class="sidebar-button-icon fa fa-lg fa-question"></i>
      
      <span class="sidebar-button-desc">关于</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="5"
        class="
               hasCoverMetaIn
               ">
        <article class="post" itemscope itemType="http://schema.org/BlogPosting">
          
          
            <div class="post-header main-content-wrap text-center">
  
    <h1 class="post-title" itemprop="headline">
      聊一聊Go的协程泄露
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time itemprop="datePublished" datetime="2021-09-11T00:00:00Z">
        
  九月 11, 2021

      </time>
    
    
  
  
    <span>发布在</span>
    
      <a class="category-link" href="/categories/go">Go</a>, 
    
      <a class="category-link" href="/categories/%e5%90%8e%e7%ab%af">后端</a>
    
  

  </div>

</div>
          
          <div class="post-content markdown" itemprop="articleBody">
            <div class="main-content-wrap">
              <p>协程在Go里面是一个常见的概念，伴随着go程序的生命周期开始至结束。今天来聊一聊Go的协程泄露。</p>
<p><img src="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/blog/road.PNG" alt="协程通信"></p>
<h2 id="前言">前言</h2>
<p>协程在Go里面是一个常见的概念，伴随着go程序的生命周期开始至结束。今天来聊一聊Go的协程泄露。<br>
关于协程的底层概念，GMP模型等，之前在前面博客已经作过分析，感兴趣可以看下之前的文章<a href="https://note.youdao.com/">聊一聊操作系统线程调度与Go协程</a></p>
<h2 id="泄露案例">泄露案例</h2>
<p>关于协程泄露很常见的原因在于，有时候我们常常会忽略问题，直到资源负载异常才引起总是。
之前排除生产环境异常的时候，曾经遇到过go程序内存泄露的场景，内存泄漏和协程泄露有很大关系，本质上都是资源不回收导致的。这里简单还原一下现场，细节已经经过删减，大概形式如下：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">JumpForSignal</span>() <span style="color:#66d9ef">int</span> {
    <span style="color:#a6e22e">ch</span> <span style="color:#f92672">:=</span> make(<span style="color:#66d9ef">chan</span> <span style="color:#66d9ef">int</span>)
    <span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
        <span style="color:#a6e22e">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">bizMtx</span>
    }()

    <span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
        <span style="color:#a6e22e">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">bizMtx</span>
    }()

    <span style="color:#66d9ef">go</span> <span style="color:#66d9ef">func</span>() {
        <span style="color:#a6e22e">ch</span> <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">bizMtx</span>
    }()
    <span style="color:#75715e">//一有输入立刻返回
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">return</span> <span style="color:#f92672">&lt;-</span><span style="color:#a6e22e">ch</span>
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">JumpForSignal</span>()
    <span style="color:#75715e">// ...
</span><span style="color:#75715e"></span>}
</code></pre></div><p>事后分析这个demo可以得知，这个函数调用会阻塞两个子协程，预期只有一个协程会正常退出。</p>
<h2 id="获取协程信息">获取协程信息</h2>
<p>既然存在协程泄露，我们在日常工作怎么避免或者发现它呢？下面我们列举几个思路。</p>
<h3 id="遵守准则">遵守准则</h3>
<p>由于Go是自带GC的语言，很多时候写代码不需要关心变量的资源释放，不像C程序员变量申请之后需要在结束处释放。但是Go的<code>chan</code>在使用时候是有一些准则的，当确定chan不再使用时候，可以在输出方进行close，避免其他协程还在等待该<code>chan</code>的输出。</p>
<h3 id="协程数量">协程数量</h3>
<p>找到泄露的协程，第一个能够想到的是协程数量，当你的函数处理逻辑比较简单，除了主协程之外，预期协程应该都在结束前返回，可以在main函数结束处调用<code>runtime</code>包的函数：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// NumGoroutine returns the number of goroutines that currently exist.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">NumGoroutine</span>() <span style="color:#66d9ef">int</span> {
    <span style="color:#66d9ef">return</span> int(<span style="color:#a6e22e">gcount</span>())
}
</code></pre></div><p>通过它可以返回当前协程总数量：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">Count</span>()  {
    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;Number of goroutines:%d\n&#34;</span>, <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">NumGoroutine</span>())
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
    <span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">Count</span>()
    <span style="color:#a6e22e">Count</span>()
    <span style="color:#a6e22e">JumpForSignal</span>()
}
</code></pre></div><p>输出：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">Number of goroutines:1
Number of goroutines:3
</code></pre></div><h3 id="协程函数栈">协程函数栈</h3>
<p>还有一种比较常见定位协程的形式，在Go里面，可以用于分析协程函数的上下文，常见的比如go自带的pprof也是通过这种方式获取。</p>
<p>下面来看一个示例，我们在上面的例子加一个<code>http</code>端口监听，用于接入go自带的pprof分析工具。</p>
<p>随后在浏览器输入：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">http</span>:<span style="color:#75715e">//localhost:8899/debug/pprof/goroutine?debug=1
</span></code></pre></div><p>可以得到整个程序的协程列表：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">goroutine profile: total <span style="color:#ae81ff">7</span>
<span style="color:#ae81ff">1</span> @ 0x165eb6 0x126465 0x126235 0x29341e 0x19de01
<span style="color:#75715e">#   0x29341d    pixelgo/leak.JumpForSignal.func1+0x3d   F:/code/pixelGo/src/pix-demo/leak/leak.go:24</span>

<span style="color:#ae81ff">1</span> @ 0x165eb6 0x126465 0x126235 0x29347e 0x19de01
<span style="color:#75715e">#   0x29347d    pixelgo/leak.JumpForSignal.func2+0x3d   F:/code/pixelGo/src/pix-demo/leak/leak.go:28</span>

<span style="color:#ae81ff">1</span> @ 0x165eb6 0x15bb3d 0x1975a5 0x228d05 0x229d8d 0x22c40d 0x321765 0x33437c 0x447c89 0x285239 0x285606 0x4493f3 0x450da8 0x19de01
<span style="color:#75715e">#   0x1975a4    internal/poll.runtime_pollWait+0x64 D:/dev/go1.16/src/runtime/netpoll.go:227</span>
<span style="color:#75715e">#   0x228d04    internal/poll.(*pollDesc).wait+0xa4 D:/dev/go1.16/src/internal/poll/fd_poll_runtime.go:87</span>
<span style="color:#75715e">#   0x229d8c    internal/poll.execIO+0x2ac      D:/dev/go1.16/src/internal/poll/fd_windows.go:175</span>
<span style="color:#75715e">#   0x22c40c    internal/poll.(*FD).Read+0x56c      </span>

// ...
</code></pre></div><p>结论是：当前程序一共有7个协程，可以看出分别有1个协程分配在<code>F:/code/pixelGo/src/pix-demo/leak/leak.go:24</code> 和<code>F:/code/pixelGo/src/pix-demo/leak/leak.go:28</code>，正是上文泄露的代码块。</p>
<p>有时候还可以多维度去分析，比如输入：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">http</span>:<span style="color:#75715e">//localhost:8899/debug/pprof/goroutine?debug=2
</span></code></pre></div><p>可以通过协程后面的标签,看到当前协程的不同状态，<strong>running/io wait/chan send</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">9</span> [<span style="color:#a6e22e">running</span>]:
<span style="color:#a6e22e">runtime</span><span style="color:#f92672">/</span><span style="color:#a6e22e">pprof</span>.<span style="color:#a6e22e">writeGoroutineStacks</span>(<span style="color:#ae81ff">0x7f7d00</span>, <span style="color:#ae81ff">0xc0000aa000</span>, <span style="color:#ae81ff">0x0</span>, <span style="color:#ae81ff">0x0</span>)
    <span style="color:#a6e22e">D</span>:<span style="color:#f92672">/</span><span style="color:#a6e22e">dev</span><span style="color:#f92672">/</span><span style="color:#a6e22e">go1</span><span style="color:#ae81ff">.16</span><span style="color:#f92672">/</span><span style="color:#a6e22e">src</span><span style="color:#f92672">/</span><span style="color:#a6e22e">runtime</span><span style="color:#f92672">/</span><span style="color:#a6e22e">pprof</span><span style="color:#f92672">/</span><span style="color:#a6e22e">pprof</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">693</span> <span style="color:#f92672">+</span><span style="color:#ae81ff">0xc5</span>
<span style="color:#a6e22e">net</span><span style="color:#f92672">/</span><span style="color:#a6e22e">http</span><span style="color:#f92672">/</span><span style="color:#a6e22e">pprof</span>.<span style="color:#a6e22e">handler</span>.<span style="color:#a6e22e">ServeHTTP</span>(<span style="color:#ae81ff">0xc000094011</span>, <span style="color:#ae81ff">0x9</span>, <span style="color:#ae81ff">0x7fba40</span>, <span style="color:#ae81ff">0xc0000aa000</span>, <span style="color:#ae81ff">0xc000092000</span>)
    <span style="color:#75715e">//..
</span><span style="color:#75715e"></span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">1</span> [<span style="color:#a6e22e">IO</span> <span style="color:#a6e22e">wait</span>]:
<span style="color:#a6e22e">internal</span><span style="color:#f92672">/</span><span style="color:#a6e22e">poll</span>.<span style="color:#a6e22e">runtime_pollWait</span>(<span style="color:#ae81ff">0x223debb10d8</span>, <span style="color:#ae81ff">0x72</span>, <span style="color:#ae81ff">0xc000152f48</span>)
    <span style="color:#a6e22e">D</span>:<span style="color:#f92672">/</span><span style="color:#a6e22e">dev</span><span style="color:#f92672">/</span><span style="color:#a6e22e">go1</span><span style="color:#ae81ff">.16</span><span style="color:#f92672">/</span><span style="color:#a6e22e">src</span><span style="color:#f92672">/</span><span style="color:#a6e22e">runtime</span><span style="color:#f92672">/</span><span style="color:#a6e22e">netpoll</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">227</span> <span style="color:#f92672">+</span><span style="color:#ae81ff">0x65</span>
<span style="color:#a6e22e">internal</span><span style="color:#f92672">/</span><span style="color:#a6e22e">poll</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">pollDesc</span>).<span style="color:#a6e22e">wait</span>(<span style="color:#ae81ff">0xc0001530b8</span>, <span style="color:#ae81ff">0x72</span>, <span style="color:#ae81ff">0x93b400</span>, <span style="color:#ae81ff">0x0</span>, <span style="color:#ae81ff">0x0</span>)
    <span style="color:#75715e">//...
</span><span style="color:#75715e"></span>
<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">6</span> [<span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">send</span>]:
<span style="color:#a6e22e">pixelgo</span><span style="color:#f92672">/</span><span style="color:#a6e22e">rout</span>.<span style="color:#a6e22e">JumpForSignal</span>.<span style="color:#a6e22e">func1</span>(<span style="color:#ae81ff">0xc000053800</span>)
    <span style="color:#a6e22e">F</span>:<span style="color:#f92672">/</span><span style="color:#a6e22e">code</span><span style="color:#f92672">/</span><span style="color:#a6e22e">pixelGo</span><span style="color:#f92672">/</span><span style="color:#a6e22e">src</span><span style="color:#f92672">/</span><span style="color:#a6e22e">pix</span><span style="color:#f92672">-</span><span style="color:#a6e22e">demo</span><span style="color:#f92672">/</span><span style="color:#a6e22e">rout</span><span style="color:#f92672">/</span><span style="color:#a6e22e">leak</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">25</span> <span style="color:#f92672">+</span><span style="color:#ae81ff">0x10e</span>
<span style="color:#a6e22e">created</span> <span style="color:#a6e22e">by</span> <span style="color:#a6e22e">pixelgo</span><span style="color:#f92672">/</span><span style="color:#a6e22e">rout</span>.<span style="color:#a6e22e">JumpForSignal</span>
    <span style="color:#a6e22e">F</span>:<span style="color:#f92672">/</span><span style="color:#a6e22e">code</span><span style="color:#f92672">/</span><span style="color:#a6e22e">pixelGo</span><span style="color:#f92672">/</span><span style="color:#a6e22e">src</span><span style="color:#f92672">/</span><span style="color:#a6e22e">pix</span><span style="color:#f92672">-</span><span style="color:#a6e22e">demo</span><span style="color:#f92672">/</span><span style="color:#a6e22e">rout</span><span style="color:#f92672">/</span><span style="color:#a6e22e">leak</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">23</span> <span style="color:#f92672">+</span><span style="color:#ae81ff">0x71</span>

<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">7</span> [<span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">send</span>]:
<span style="color:#a6e22e">pixelgo</span><span style="color:#f92672">/</span><span style="color:#a6e22e">rout</span>.<span style="color:#a6e22e">JumpForSignal</span>.<span style="color:#a6e22e">func2</span>(<span style="color:#ae81ff">0xc000053800</span>)
    <span style="color:#a6e22e">F</span>:<span style="color:#f92672">/</span><span style="color:#a6e22e">code</span><span style="color:#f92672">/</span><span style="color:#a6e22e">pixelGo</span><span style="color:#f92672">/</span><span style="color:#a6e22e">src</span><span style="color:#f92672">/</span><span style="color:#a6e22e">pix</span><span style="color:#f92672">-</span><span style="color:#a6e22e">demo</span><span style="color:#f92672">/</span><span style="color:#a6e22e">rout</span><span style="color:#f92672">/</span><span style="color:#a6e22e">leak</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">30</span> <span style="color:#f92672">+</span><span style="color:#ae81ff">0x10e</span>
<span style="color:#a6e22e">created</span> <span style="color:#a6e22e">by</span> <span style="color:#a6e22e">pixelgo</span><span style="color:#f92672">/</span><span style="color:#a6e22e">rout</span>.<span style="color:#a6e22e">JumpForSignal</span>
    <span style="color:#a6e22e">F</span>:<span style="color:#f92672">/</span><span style="color:#a6e22e">code</span><span style="color:#f92672">/</span><span style="color:#a6e22e">pixelGo</span><span style="color:#f92672">/</span><span style="color:#a6e22e">src</span><span style="color:#f92672">/</span><span style="color:#a6e22e">pix</span><span style="color:#f92672">-</span><span style="color:#a6e22e">demo</span><span style="color:#f92672">/</span><span style="color:#a6e22e">rout</span><span style="color:#f92672">/</span><span style="color:#a6e22e">leak</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">28</span> <span style="color:#f92672">+</span><span style="color:#ae81ff">0x93</span>
</code></pre></div><hr>
<h3 id="协程id">协程id</h3>
<p>接下来我们来探索协程标识：<strong>协程id</strong>，在Go中，每个运行的协程都会分配一个协程id，一个常见的方式是从函数运行栈获取，引用之前网上其他玩家的写法：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
    <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">getGID</span>())
}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">getGID</span>() <span style="color:#66d9ef">uint64</span> {
    <span style="color:#a6e22e">b</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">byte</span>, <span style="color:#ae81ff">64</span>)
    <span style="color:#a6e22e">b</span> = <span style="color:#a6e22e">b</span>[:<span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">Stack</span>(<span style="color:#a6e22e">b</span>, <span style="color:#66d9ef">false</span>)]
    <span style="color:#a6e22e">b</span> = <span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">TrimPrefix</span>(<span style="color:#a6e22e">b</span>, []byte(<span style="color:#e6db74">&#34;goroutine &#34;</span>))
    <span style="color:#a6e22e">b</span> = <span style="color:#a6e22e">b</span>[:<span style="color:#a6e22e">bytes</span>.<span style="color:#a6e22e">IndexByte</span>(<span style="color:#a6e22e">b</span>, <span style="color:#e6db74">&#39; &#39;</span>)]
    <span style="color:#a6e22e">n</span>, <span style="color:#a6e22e">_</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">strconv</span>.<span style="color:#a6e22e">ParseUint</span>(string(<span style="color:#a6e22e">b</span>), <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">64</span>)
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">n</span>
}
</code></pre></div><p>我们来看看<code>runtime.stack()</code> 会返回什么呢，其中真实内容是这样的：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">21</span> [<span style="color:#a6e22e">running</span>]:
<span style="color:#a6e22e">leaktest</span>.<span style="color:#a6e22e">interestingGoroutines</span>(<span style="color:#ae81ff">0xdb9980</span>, <span style="color:#ae81ff">0xc00038e018</span>, <span style="color:#ae81ff">0x0</span>, <span style="color:#ae81ff">0x0</span>, <span style="color:#ae81ff">0x0</span>)
    <span style="color:#a6e22e">F</span>:<span style="color:#f92672">/</span><span style="color:#a6e22e">code</span><span style="color:#f92672">/</span><span style="color:#a6e22e">pixelGo</span><span style="color:#f92672">/</span><span style="color:#a6e22e">src</span><span style="color:#f92672">/</span><span style="color:#a6e22e">leaktest</span><span style="color:#f92672">/</span><span style="color:#a6e22e">leaktest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">81</span> <span style="color:#f92672">+</span><span style="color:#ae81ff">0xbf</span>
<span style="color:#a6e22e">leaktest</span>.<span style="color:#a6e22e">CheckContext</span>(<span style="color:#ae81ff">0xdbe398</span>, <span style="color:#ae81ff">0xc000108040</span>, <span style="color:#ae81ff">0xdb9980</span>, <span style="color:#ae81ff">0xc00038e018</span>, <span style="color:#ae81ff">0x0</span>)
    <span style="color:#a6e22e">F</span>:<span style="color:#f92672">/</span><span style="color:#a6e22e">code</span><span style="color:#f92672">/</span><span style="color:#a6e22e">pixelGo</span><span style="color:#f92672">/</span><span style="color:#a6e22e">src</span><span style="color:#f92672">/</span><span style="color:#a6e22e">leaktest</span><span style="color:#f92672">/</span><span style="color:#a6e22e">leaktest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">141</span> <span style="color:#f92672">+</span><span style="color:#ae81ff">0x6e</span>
<span style="color:#a6e22e">leaktest</span>.<span style="color:#a6e22e">CheckTimeout</span>(<span style="color:#ae81ff">0xdb9980</span>, <span style="color:#ae81ff">0xc00038e018</span>, <span style="color:#ae81ff">0x3b9aca00</span>, <span style="color:#ae81ff">0x0</span>)
    <span style="color:#a6e22e">F</span>:<span style="color:#f92672">/</span><span style="color:#a6e22e">code</span><span style="color:#f92672">/</span><span style="color:#a6e22e">pixelGo</span><span style="color:#f92672">/</span><span style="color:#a6e22e">src</span><span style="color:#f92672">/</span><span style="color:#a6e22e">leaktest</span><span style="color:#f92672">/</span><span style="color:#a6e22e">leaktest</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">127</span> <span style="color:#f92672">+</span><span style="color:#ae81ff">0xe5</span>
<span style="color:#a6e22e">leaktest</span>.<span style="color:#a6e22e">TestCheck</span>.<span style="color:#a6e22e">func8</span>(<span style="color:#ae81ff">0xc000384780</span>)
    <span style="color:#a6e22e">F</span>:<span style="color:#f92672">/</span><span style="color:#a6e22e">code</span><span style="color:#f92672">/</span><span style="color:#a6e22e">pixelGo</span><span style="color:#f92672">/</span><span style="color:#a6e22e">src</span><span style="color:#f92672">/</span><span style="color:#a6e22e">leaktest</span><span style="color:#f92672">/</span><span style="color:#a6e22e">leaktest_test</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">122</span> <span style="color:#f92672">+</span><span style="color:#ae81ff">0xaf</span>
<span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">tRunner</span>(<span style="color:#ae81ff">0xc000384780</span>, <span style="color:#ae81ff">0xc000100050</span>)
    <span style="color:#a6e22e">D</span>:<span style="color:#f92672">/</span><span style="color:#a6e22e">dev</span><span style="color:#f92672">/</span><span style="color:#a6e22e">go1</span><span style="color:#ae81ff">.16</span><span style="color:#f92672">/</span><span style="color:#a6e22e">src</span><span style="color:#f92672">/</span><span style="color:#a6e22e">testing</span><span style="color:#f92672">/</span><span style="color:#a6e22e">testing</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">1193</span> <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1a3</span>
<span style="color:#a6e22e">created</span> <span style="color:#a6e22e">by</span> <span style="color:#a6e22e">testing</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">T</span>).<span style="color:#a6e22e">Run</span>
    <span style="color:#a6e22e">D</span>:<span style="color:#f92672">/</span><span style="color:#a6e22e">dev</span><span style="color:#f92672">/</span><span style="color:#a6e22e">go1</span><span style="color:#ae81ff">.16</span><span style="color:#f92672">/</span><span style="color:#a6e22e">src</span><span style="color:#f92672">/</span><span style="color:#a6e22e">testing</span><span style="color:#f92672">/</span><span style="color:#a6e22e">testing</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">1238</span> <span style="color:#f92672">+</span><span style="color:#ae81ff">0x63c</span>

<span style="color:#a6e22e">goroutine</span> <span style="color:#ae81ff">1</span> [<span style="color:#66d9ef">chan</span> <span style="color:#a6e22e">receive</span>]:
<span style="color:#a6e22e">testing</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">T</span>).<span style="color:#a6e22e">Run</span>(<span style="color:#ae81ff">0xc000037080</span>, <span style="color:#ae81ff">0xd8486a</span>, <span style="color:#ae81ff">0x9</span>, <span style="color:#ae81ff">0xd9ebc8</span>, <span style="color:#ae81ff">0x304bd824304bd800</span>)
    <span style="color:#a6e22e">D</span>:<span style="color:#f92672">/</span><span style="color:#a6e22e">dev</span><span style="color:#f92672">/</span><span style="color:#a6e22e">go1</span><span style="color:#ae81ff">.16</span><span style="color:#f92672">/</span><span style="color:#a6e22e">src</span><span style="color:#f92672">/</span><span style="color:#a6e22e">testing</span><span style="color:#f92672">/</span><span style="color:#a6e22e">testing</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">1239</span> <span style="color:#f92672">+</span><span style="color:#ae81ff">0x66a</span>
<span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">runTests</span>.<span style="color:#a6e22e">func1</span>(<span style="color:#ae81ff">0xc000036f00</span>)
    <span style="color:#a6e22e">D</span>:<span style="color:#f92672">/</span><span style="color:#a6e22e">dev</span><span style="color:#f92672">/</span><span style="color:#a6e22e">go1</span><span style="color:#ae81ff">.16</span><span style="color:#f92672">/</span><span style="color:#a6e22e">src</span><span style="color:#f92672">/</span><span style="color:#a6e22e">testing</span><span style="color:#f92672">/</span><span style="color:#a6e22e">testing</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">1511</span> <span style="color:#f92672">+</span><span style="color:#ae81ff">0xbd</span>
<span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">tRunner</span>(<span style="color:#ae81ff">0xc000036f00</span>, <span style="color:#ae81ff">0xc00008fc00</span>)
    <span style="color:#a6e22e">D</span>:<span style="color:#f92672">/</span><span style="color:#a6e22e">dev</span><span style="color:#f92672">/</span><span style="color:#a6e22e">go1</span><span style="color:#ae81ff">.16</span><span style="color:#f92672">/</span><span style="color:#a6e22e">src</span><span style="color:#f92672">/</span><span style="color:#a6e22e">testing</span><span style="color:#f92672">/</span><span style="color:#a6e22e">testing</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">1193</span> <span style="color:#f92672">+</span><span style="color:#ae81ff">0x1a3</span>
<span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">runTests</span>(<span style="color:#ae81ff">0xc0000040d8</span>, <span style="color:#ae81ff">0xf40460</span>, <span style="color:#ae81ff">0x5</span>, <span style="color:#ae81ff">0x5</span>, <span style="color:#ae81ff">0x0</span>, <span style="color:#ae81ff">0x0</span>, <span style="color:#ae81ff">0x0</span>, <span style="color:#ae81ff">0x21cbf1c0100</span>)
    <span style="color:#a6e22e">D</span>:<span style="color:#f92672">/</span><span style="color:#a6e22e">dev</span><span style="color:#f92672">/</span><span style="color:#a6e22e">go1</span><span style="color:#ae81ff">.16</span><span style="color:#f92672">/</span><span style="color:#a6e22e">src</span><span style="color:#f92672">/</span><span style="color:#a6e22e">testing</span><span style="color:#f92672">/</span><span style="color:#a6e22e">testing</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">1509</span> <span style="color:#f92672">+</span><span style="color:#ae81ff">0x448</span>
<span style="color:#a6e22e">testing</span>.(<span style="color:#f92672">*</span><span style="color:#a6e22e">M</span>).<span style="color:#a6e22e">Run</span>(<span style="color:#ae81ff">0xc0000c0000</span>, <span style="color:#ae81ff">0x0</span>)
    <span style="color:#a6e22e">D</span>:<span style="color:#f92672">/</span><span style="color:#a6e22e">dev</span><span style="color:#f92672">/</span><span style="color:#a6e22e">go1</span><span style="color:#ae81ff">.16</span><span style="color:#f92672">/</span><span style="color:#a6e22e">src</span><span style="color:#f92672">/</span><span style="color:#a6e22e">testing</span><span style="color:#f92672">/</span><span style="color:#a6e22e">testing</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">1417</span> <span style="color:#f92672">+</span><span style="color:#ae81ff">0x514</span>
<span style="color:#a6e22e">main</span>.<span style="color:#a6e22e">main</span>()
    <span style="color:#a6e22e">_testmain</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">51</span> <span style="color:#f92672">+</span><span style="color:#ae81ff">0xc8</span>
</code></pre></div><p>可以发现这个栈和我们运行panic抛出的信息非常类似，需要注意的是，++通过这种方式获取协程id并不是一个高效的方式。++<br>
实际生产使用过程并不提倡，值得一提的是，有时候日志框架又<strong>需要我们打印出当前协程id，方便我们更好的定位问题上下文</strong>。</p>
<p>比如这是一个生产案例日志输出：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// 1号协程用于初始化资源
</span><span style="color:#75715e"></span>[<span style="color:#ae81ff">0224</span><span style="color:#f92672">/</span><span style="color:#ae81ff">162532.310</span>:<span style="color:#a6e22e">INFO</span>:<span style="color:#a6e22e">gid</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>:<span style="color:#a6e22e">yx_trace</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">66</span>] <span style="color:#a6e22e">cfg</span>:<span style="color:#f92672">&amp;</span>{ <span style="color:#66d9ef">false</span> <span style="color:#66d9ef">false</span> [] <span style="color:#ae81ff">0xc000295140</span> <span style="color:#ae81ff">0xc0001d4e00</span> &lt;<span style="color:#66d9ef">nil</span>&gt; &lt;<span style="color:#66d9ef">nil</span>&gt; &lt;<span style="color:#66d9ef">nil</span>&gt;}
[<span style="color:#ae81ff">0224</span><span style="color:#f92672">/</span><span style="color:#ae81ff">162532.320</span>:<span style="color:#a6e22e">INFO</span>:<span style="color:#a6e22e">gid</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>:<span style="color:#a6e22e">main</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">50</span>] <span style="color:#a6e22e">GameRoom</span> <span style="color:#a6e22e">Startup</span><span style="color:#f92672">-</span>&gt;
[<span style="color:#ae81ff">0224</span><span style="color:#f92672">/</span><span style="color:#ae81ff">162532.320</span>:<span style="color:#a6e22e">INFO</span>:<span style="color:#a6e22e">gid</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>:<span style="color:#a6e22e">config_manager</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">107</span>] <span style="color:#a6e22e">configManager</span> <span style="color:#a6e22e">SetHttpListenAddr</span>:<span style="color:#ae81ff">8080</span>
[<span style="color:#ae81ff">0224</span><span style="color:#f92672">/</span><span style="color:#ae81ff">162532.320</span>:<span style="color:#a6e22e">INFO</span>:<span style="color:#a6e22e">gid</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>:<span style="color:#a6e22e">room_manager</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">57</span>] <span style="color:#a6e22e">roomManager</span> <span style="color:#a6e22e">Startup</span>
[<span style="color:#ae81ff">0224</span><span style="color:#f92672">/</span><span style="color:#ae81ff">162532.323</span>:<span style="color:#a6e22e">INFO</span>:<span style="color:#a6e22e">gid</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>:<span style="color:#a6e22e">room_manager</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">72</span>] <span style="color:#a6e22e">roomManager</span> <span style="color:#a6e22e">initPrx</span>.
[<span style="color:#ae81ff">0224</span><span style="color:#f92672">/</span><span style="color:#ae81ff">162532.330</span>:<span style="color:#a6e22e">INFO</span>:<span style="color:#a6e22e">gid</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>:<span style="color:#a6e22e">bootstrap</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">153</span>] <span style="color:#a6e22e">GameRoom</span> <span style="color:#a6e22e">START</span> <span style="color:#a6e22e">ok</span>.
<span style="color:#75715e">// 60号协程分配用于启动HTTP Server
</span><span style="color:#75715e"></span>[<span style="color:#ae81ff">0224</span><span style="color:#f92672">/</span><span style="color:#ae81ff">162533.277</span>:<span style="color:#a6e22e">INFO</span>:<span style="color:#a6e22e">gid</span><span style="color:#f92672">-</span><span style="color:#ae81ff">60</span>:<span style="color:#a6e22e">expose</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">36</span>] <span style="color:#a6e22e">Start</span> <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">HTTP</span> <span style="color:#a6e22e">server</span><span style="color:#f92672">...</span>
[<span style="color:#ae81ff">0224</span><span style="color:#f92672">/</span><span style="color:#ae81ff">162533.277</span>:<span style="color:#a6e22e">INFO</span>:<span style="color:#a6e22e">gid</span><span style="color:#f92672">-</span><span style="color:#ae81ff">60</span>:<span style="color:#a6e22e">expose</span>.<span style="color:#66d9ef">go</span>:<span style="color:#ae81ff">39</span>] <span style="color:#a6e22e">register</span> <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">debug</span> <span style="color:#a6e22e">server</span><span style="color:#f92672">...</span>
</code></pre></div><p>日志框架是力求对业务性能影响最低的，那么他是怎么获取协程id的呢？</p>
<h3 id="汇编获取">汇编获取</h3>
<p>通过协程绑定的g指针，具体可以参考<a href="https://chai2010.cn/advanced-go-programming-book/ch3-asm/ch3-08-goroutine-id.html">《Go高级编程》的做法</a></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// 记录各个版本的偏移量
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">offsetDictMap</span> = <span style="color:#66d9ef">map</span>[<span style="color:#66d9ef">string</span>]<span style="color:#66d9ef">int64</span>{
    <span style="color:#e6db74">&#34;go1.12&#34;</span>:    <span style="color:#ae81ff">152</span>,
    <span style="color:#e6db74">&#34;go1.12.1&#34;</span>:  <span style="color:#ae81ff">152</span>,
    <span style="color:#e6db74">&#34;go1.12.2&#34;</span>:  <span style="color:#ae81ff">152</span>,
    <span style="color:#e6db74">&#34;go1.12.3&#34;</span>:  <span style="color:#ae81ff">152</span>,
    <span style="color:#e6db74">&#34;go1.12.4&#34;</span>:  <span style="color:#ae81ff">152</span>,
    <span style="color:#e6db74">&#34;go1.12.5&#34;</span>:  <span style="color:#ae81ff">152</span>,
    <span style="color:#e6db74">&#34;go1.12.6&#34;</span>:  <span style="color:#ae81ff">152</span>,
    <span style="color:#e6db74">&#34;go1.12.7&#34;</span>:  <span style="color:#ae81ff">152</span>,
    <span style="color:#e6db74">&#34;go1.13&#34;</span>:    <span style="color:#ae81ff">152</span>,
    <span style="color:#e6db74">&#34;go1.14&#34;</span>:    <span style="color:#ae81ff">152</span>,
    <span style="color:#e6db74">&#34;go1.16.12&#34;</span>:    <span style="color:#ae81ff">152</span>,
}

<span style="color:#75715e">// offset for go1.12
</span><span style="color:#75715e"></span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">goid_offset</span> <span style="color:#66d9ef">uintptr</span> = <span style="color:#ae81ff">152</span>
<span style="color:#75715e">//go:nosplit
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">getG</span>() <span style="color:#66d9ef">interface</span>{}

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">GoId</span>() <span style="color:#66d9ef">int64</span>

<span style="color:#75715e">// 部分汇编代码
</span><span style="color:#75715e">// func getGptr() unsafe.Pointer
</span><span style="color:#75715e"></span><span style="color:#a6e22e">TEXT</span> <span style="color:#960050;background-color:#1e0010">·</span><span style="color:#a6e22e">getGptr</span>(<span style="color:#a6e22e">SB</span>), <span style="color:#a6e22e">NOSPLIT</span>, <span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span><span style="color:#f92672">-</span><span style="color:#ae81ff">8</span>
    <span style="color:#a6e22e">MOVQ</span> (<span style="color:#a6e22e">TLS</span>), <span style="color:#a6e22e">BX</span>
    <span style="color:#a6e22e">MOVQ</span> <span style="color:#a6e22e">BX</span>, <span style="color:#a6e22e">ret</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0</span>(<span style="color:#a6e22e">FP</span>)
    <span style="color:#a6e22e">RET</span>

<span style="color:#a6e22e">TEXT</span> <span style="color:#960050;background-color:#1e0010">·</span><span style="color:#a6e22e">GoId</span>(<span style="color:#a6e22e">SB</span>),<span style="color:#a6e22e">NOSPLIT</span>,<span style="color:#960050;background-color:#1e0010">$</span><span style="color:#ae81ff">0</span><span style="color:#f92672">-</span><span style="color:#ae81ff">8</span>
    <span style="color:#a6e22e">NO_LOCAL_POINTERS</span>
    <span style="color:#a6e22e">MOVQ</span> <span style="color:#960050;background-color:#1e0010">·</span><span style="color:#a6e22e">goid_offset</span>(<span style="color:#a6e22e">SB</span>),<span style="color:#a6e22e">AX</span>
    <span style="color:#75715e">// get runtime.g
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">MOVQ</span> (<span style="color:#a6e22e">TLS</span>),<span style="color:#a6e22e">BX</span>
    <span style="color:#a6e22e">ADDQ</span> <span style="color:#a6e22e">BX</span>,<span style="color:#a6e22e">AX</span>
    <span style="color:#a6e22e">MOVQ</span> (<span style="color:#a6e22e">AX</span>),<span style="color:#a6e22e">BX</span>
    <span style="color:#a6e22e">MOVQ</span> <span style="color:#a6e22e">BX</span>,<span style="color:#a6e22e">ret</span><span style="color:#f92672">+</span><span style="color:#ae81ff">0</span>(<span style="color:#a6e22e">FP</span>)
    <span style="color:#a6e22e">RET</span>
</code></pre></div><h3 id="性能比较">性能比较：</h3>
<p>我们来简单测试下两种获取go协程id方式性能差距：</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">// BenchmarkGId-8       1000000000           0.0005081 ns/op
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">BenchmarkGRtId</span>(<span style="color:#a6e22e">b</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">B</span>) {
    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">n</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">n</span> &lt; <span style="color:#ae81ff">1000000000</span>; <span style="color:#a6e22e">n</span><span style="color:#f92672">++</span> {
        <span style="color:#75715e">// runtime获取协程id
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">getGID</span>()
    }
}

<span style="color:#75715e">// BenchmarkLog-8       1000000000           0.05731 ns/op
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">BenchmarkGoId</span>(<span style="color:#a6e22e">b</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">testing</span>.<span style="color:#a6e22e">B</span>) {
    <span style="color:#66d9ef">for</span> <span style="color:#a6e22e">n</span> <span style="color:#f92672">:=</span> <span style="color:#ae81ff">0</span>; <span style="color:#a6e22e">n</span> &lt; <span style="color:#ae81ff">1000000000</span>; <span style="color:#a6e22e">n</span><span style="color:#f92672">++</span> {
        <span style="color:#75715e">// 汇编方式获取
</span><span style="color:#75715e"></span>        <span style="color:#a6e22e">GoId</span>()
    }
}
</code></pre></div><p>可以看到通过汇编方式获取协程id的方式性能更优，相差两个数量级。</p>
<h2 id="参考链接">参考链接</h2>
<p>pprof介绍</p>
<ul>
<li><a href="https://qcrao.com/2019/11/10/dive-into-go-pprof/">https://qcrao.com/2019/11/10/dive-into-go-pprof/</a></li>
</ul>
<p>协程泄露：</p>
<ul>
<li><a href="https://www.storj.io/blog/finding-goroutine-leaks-in-tests">https://www.storj.io/blog/finding-goroutine-leaks-in-tests</a></li>
<li><a href="https://github.com/fortytw2/leaktest">https://github.com/fortytw2/leaktest</a></li>
</ul>
<p>协程id：</p>
<ul>
<li><a href="https://blog.sgmansfield.com/2015/12/goroutine-ids/">https://blog.sgmansfield.com/2015/12/goroutine-ids/</a></li>
</ul>
              
            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">标签</span><br/>
                    
  <a class="tag tag--primary tag--small" href="/tags/%E5%8D%8F%E7%A8%8B/">协程</a>

  <a class="tag tag--primary tag--small" href="/tags/debug/">debug</a>

                  </div>
                
              
            
            <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="/2021/10/%E8%81%8A%E4%B8%80%E8%81%8Ago%E7%BD%91%E7%BB%9C%E6%A1%86%E6%9E%B6gin%E4%B9%8B%E5%A6%82%E4%BD%95%E5%AE%9A%E5%88%B6%E9%80%9A%E7%94%A8%E6%8B%A6%E6%88%AA%E5%99%A8/" data-tooltip="聊一聊Go网络框架Gin之如何定制通用拦截器">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">下一篇</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="/2021/06/%E8%81%8A%E4%B8%80%E8%81%8Ago%E5%AE%9E%E7%8E%B0%E7%9A%84%E5%A4%9A%E5%8D%8F%E7%A8%8B%E4%B8%8B%E8%BD%BD%E5%99%A8-gopeed-core/" data-tooltip="聊一聊Go实现的多协程下载器: gopeed-core">
              
                  <span class="hide-xs hide-sm text-small icon-mr">上一篇</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
      
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#">
        
          <i class="fa fa-list"></i>
        </a>
      </li>
    </ul>
  
</div>

            
              
            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2022 <a href="https://github.com/pixeldin">pixeldin</a>. All Rights Reserved
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
        <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="/2021/10/%E8%81%8A%E4%B8%80%E8%81%8Ago%E7%BD%91%E7%BB%9C%E6%A1%86%E6%9E%B6gin%E4%B9%8B%E5%A6%82%E4%BD%95%E5%AE%9A%E5%88%B6%E9%80%9A%E7%94%A8%E6%8B%A6%E6%88%AA%E5%99%A8/" data-tooltip="聊一聊Go网络框架Gin之如何定制通用拦截器">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">下一篇</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="/2021/06/%E8%81%8A%E4%B8%80%E8%81%8Ago%E5%AE%9E%E7%8E%B0%E7%9A%84%E5%A4%9A%E5%8D%8F%E7%A8%8B%E4%B8%8B%E8%BD%BD%E5%99%A8-gopeed-core/" data-tooltip="聊一聊Go实现的多协程下载器: gopeed-core">
              
                  <span class="hide-xs hide-sm text-small icon-mr">上一篇</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
        <li class="post-action hide-lg hide-md hide-sm">
          <a class="post-action-btn btn btn--default btn-open-shareoptions" href="#btn-open-shareoptions">
            <i class="fa fa-share-alt"></i>
          </a>
        </li>
        
      
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#">
        
          <i class="fa fa-list"></i>
        </a>
      </li>
    </ul>
  
</div>

      </div>
      <div id="share-options-bar" class="share-options-bar" data-behavior="5">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/pig.jpg" alt="作者的图片" />
    
    <h4 id="about-card-name">pixelpig</h4>
    
      <div id="about-card-bio">Stay hungry, stay foolish <strong>:）</strong></div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        后端开发@广州虎牙
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        CHINA-ZH
      </div>
    
  </div>
</div>

    

    
  
    <div id="cover" style="background-image:url('https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/cover.jpg');"></div>
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.7/js/jquery.fancybox.min.js" integrity="sha256-GEAnjcTqVP+vBp3SSc8bEDQqvWAZMiHyUSIorrWwH50=" crossorigin="anonymous"></script>


<script src="/js/script-pcw6v3xilnxydl1vddzazdverrnn9ctynvnxgwho987mfyqkuylcb1nlt.min.js"></script>


<script lang="javascript">
window.onload = updateMinWidth;
window.onresize = updateMinWidth;
document.getElementById("sidebar").addEventListener("transitionend", updateMinWidth);
function updateMinWidth() {
  var sidebar = document.getElementById("sidebar");
  var main = document.getElementById("main");
  main.style.minWidth = "";
  var w1 = getComputedStyle(main).getPropertyValue("min-width");
  var w2 = getComputedStyle(sidebar).getPropertyValue("width");
  var w3 = getComputedStyle(sidebar).getPropertyValue("left");
  main.style.minWidth = `calc(${w1} - ${w2} - ${w3})`;
}
</script>

<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>


  
    
  




    
  </body>
</html>

