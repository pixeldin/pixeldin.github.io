<!DOCTYPE html>
<html lang="en-us">
  <head>
    
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="generator" content="Hugo 0.80.0 with theme Tranquilpeak 0.4.8-BETA">
<meta name="author" content="pixelpig">
<meta name="keywords" content="">
<meta name="description" content="在Go语言中，错误处理是一个常见的操作">


<meta property="og:description" content="在Go语言中，错误处理是一个常见的操作">
<meta property="og:type" content="article">
<meta property="og:title" content="聊一聊Go语言的error处理">
<meta name="twitter:title" content="聊一聊Go语言的error处理">
<meta property="og:url" content="/2020/03/%E8%81%8A%E4%B8%80%E8%81%8Ago%E8%AF%AD%E8%A8%80%E7%9A%84error%E5%A4%84%E7%90%86/">
<meta property="twitter:url" content="/2020/03/%E8%81%8A%E4%B8%80%E8%81%8Ago%E8%AF%AD%E8%A8%80%E7%9A%84error%E5%A4%84%E7%90%86/">
<meta property="og:site_name" content="Pixelpig&#39;s blog">
<meta property="og:description" content="在Go语言中，错误处理是一个常见的操作">
<meta name="twitter:description" content="在Go语言中，错误处理是一个常见的操作">
<meta property="og:locale" content="zh-cn">

  
    <meta property="article:published_time" content="2020-03-15T00:00:00">
  
  
    <meta property="article:modified_time" content="2020-03-15T00:00:00">
  
  
  
    
      <meta property="article:section" content="Go">
    
  
  
    
      <meta property="article:tag" content="errors">
    
  


<meta name="twitter:card" content="summary">











  <meta property="og:image" content="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/pig.jpg">
  <meta property="twitter:image" content="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/pig.jpg">


    <title>聊一聊Go语言的error处理</title>

    <link rel="icon" href="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/blog/static/pixel.ico">
    

    

    <link rel="canonical" href="/2020/03/%E8%81%8A%E4%B8%80%E8%81%8Ago%E8%AF%AD%E8%A8%80%E7%9A%84error%E5%A4%84%E7%90%86/">

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/jquery.fancybox.min.css" integrity="sha256-vuXZ9LGmmwtjqFX1F+EKin1ThZMub58gKULUyf0qECk=" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.4/helpers/jquery.fancybox-thumbs.min.css" integrity="sha256-SEa4XYAHihTcEP1f5gARTB2K26Uk8PsndQYHQC1f4jU=" crossorigin="anonymous" />
    
    
    <link rel="stylesheet" href="/css/style-twzjdbqhmnnacqs0pwwdzcdbt8yhv8giawvjqjmyfoqnvazl0dalmnhdkvp7.min.css" />
    
    

    
      
    
    
  </head>

  <body>
    <div id="blog">
      <header id="header" data-behavior="5">
  <i id="btn-open-sidebar" class="fa fa-lg fa-bars"></i>
  <div class="header-title">
    <a class="header-title-link" href="/">Pixelpig&#39;s blog</a>
  </div>
  
    
      <a class="header-right-picture "
         href="/#about">
    
    
    
      
        <img class="header-picture" src="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/pig.jpg" alt="作者的图片" />
      
    
    </a>
  
</header>

      <nav id="sidebar" data-behavior="5">
  <div class="sidebar-container">
    
      <div class="sidebar-profile">
        <a href="/#about">
          <img class="sidebar-profile-picture" src="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/pig.jpg" alt="作者的图片" />
        </a>
        <h4 class="sidebar-profile-name">pixelpig</h4>
        
          <h5 class="sidebar-profile-bio">Stay hungry, stay foolish <strong>:）</strong></h5>
        
      </div>
    
    <ul class="sidebar-buttons">
      
  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/">
    
      <i class="sidebar-button-icon fa fa-lg fa-home"></i>
      
      <span class="sidebar-button-desc">首页</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/categories">
    
      <i class="sidebar-button-icon fa fa-lg fa-bookmark"></i>
      
      <span class="sidebar-button-desc">分类</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/tags">
    
      <i class="sidebar-button-icon fa fa-lg fa-tags"></i>
      
      <span class="sidebar-button-desc">标签</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/archives">
    
      <i class="sidebar-button-icon fa fa-lg fa-archive"></i>
      
      <span class="sidebar-button-desc">归档</span>
    </a>
  </li>

  <li class="sidebar-button">
    
      <a class="sidebar-button-link " href="/#about">
    
      <i class="sidebar-button-icon fa fa-lg fa-question"></i>
      
      <span class="sidebar-button-desc">关于</span>
    </a>
  </li>


    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
    <ul class="sidebar-buttons">
      

    </ul>
  </div>
</nav>

      

      <div id="main" data-behavior="5"
        class="
               hasCoverMetaIn
               ">
        <article class="post" itemscope itemType="http://schema.org/BlogPosting">
          
          
            <div class="post-header main-content-wrap text-left">
  
    <h1 class="post-title" itemprop="headline">
      聊一聊Go语言的error处理
    </h1>
  
  
  <div class="postShorten-meta post-meta">
    
      <time itemprop="datePublished" datetime="2020-03-15T00:00:00Z">
        
  三月 15, 2020

      </time>
    
    
  
  
    <span>发布在</span>
    
      <a class="category-link" href="/categories/go">Go</a>
    
  

  </div>

</div>
          
          <div class="post-content markdown" itemprop="articleBody">
            <div class="main-content-wrap">
              <p>在Go语言中，错误处理是一个常见的操作</p>
<h2 id="前言">前言</h2>
<p>Go语言的错误处理是一个常见的操作，经常可以见到一个函数返回错误类型(error)，后续通过<code>if err != nil</code>来判断错误以及错误类型。<br>
这一次尝试通过<strong>Go</strong>内置的<strong>error</strong>接口，我们聊一聊Go语言的错误处理以及<strong>Error</strong>的惯例用法。</p>
<h2 id="单一职责error接口">单一职责：Error接口</h2>
<h3 id="接口签名">接口签名</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#66d9ef">error</span> <span style="color:#66d9ef">interface</span> {
    <span style="color:#a6e22e">Error</span>() <span style="color:#66d9ef">string</span>
}
</code></pre></div><p>我们先看<strong>Go</strong>的src/builtin内置<strong>error</strong>接口，它只有一个<strong>Error</strong>()方法，返回一个<strong>string</strong>，用来备注错误信息。任何实现了这个方法的结构体都实现了<strong>error</strong>接口。</p>
<h3 id="实现类">实现类</h3>
<p>随便列举一个Go自带的栗子，实现了<strong>Error接口</strong>的结构体，比如<code>Go1.12/src/net/net.go</code>的<code>AddrError</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">AddrError</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#a6e22e">Err</span>  <span style="color:#66d9ef">string</span>
    <span style="color:#a6e22e">Addr</span> <span style="color:#66d9ef">string</span>
}

<span style="color:#75715e">//使用指针接收器实现该Error()接口
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">e</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">AddrError</span>) <span style="color:#a6e22e">Error</span>() <span style="color:#66d9ef">string</span> {
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">e</span> <span style="color:#f92672">==</span> <span style="color:#66d9ef">nil</span> {
    	<span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;&lt;nil&gt;&#34;</span>
    }
    <span style="color:#a6e22e">s</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Err</span>
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Addr</span> <span style="color:#f92672">!=</span> <span style="color:#e6db74">&#34;&#34;</span> {
    	<span style="color:#a6e22e">s</span> = <span style="color:#e6db74">&#34;address &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Addr</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;: &#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">s</span>
    }
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">s</span>
}
</code></pre></div><h3 id="那么问题来了">那么问题来了</h3>
<h4 id="为什么接口实现用指针接收器的场景">为什么接口实现用指针接收器的场景？</h4>
<p>在Go里面，使用指针实现接口有两个主要用途：</p>
<ol>
<li>为了在实现该函数处可以修改指针调用者</li>
<li>大结构使用指针可以减小拷贝，另外可以保证共享，维持全局一个类型，类似于单例。</li>
</ol>
<h4 id="用指针接收器实现error方法">用指针接收器实现Error()方法</h4>
<p>我们可以看到上面<code>AddrError</code>使用指针接收器<strong>AddrError</strong>实现 <strong>Error()</strong> 接口，结合上一个问题的用途分析，<strong>Error()</strong> 方法主要是为了第二点，唯一标识错误类型。</p>
<p>在Go中，Error是一个可比较的接口，我们都知道，指针的比较是比较地址，如果通过结构体(值)比较，无法确定当前Error是自定义Error或者内置Error，如io.EOF。</p>
<p>通过这种方式，我们可以在<code>err == io.EOF</code>等于true的时候，大胆地be sure这err不会是其他自定义Error实现类，一定来自于<strong>io包</strong>的内置<strong>error</strong>，这种内置错误更多作为一个全局变量贯穿在<strong>Go</strong>程序中，类似于单例。</p>
<p>其次，在自定义错误中，通过指针的<code>.(type)</code>断言，可以针对不同<strong>error</strong>类型进行判断，执行多态处理，统一使用指针进行实现方便断言判断处进行归纳。可以在src/encoding/json/decode.go找到几个常用错误类型。</p>
<h4 id="程序示例">程序示例:</h4>
<p>下面是一个通过断言switch作出不同处理的例子</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">u</span> <span style="color:#a6e22e">user</span>
<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Unmarshal</span>([]byte({<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">quot</span>;<span style="color:#a6e22e">name</span><span style="color:#f92672">&amp;</span><span style="color:#a6e22e">quot</span>;:<span style="color:#f92672">&amp;</span><span style="color:#a6e22e">quot</span>;<span style="color:#a6e22e">bill</span><span style="color:#f92672">&amp;</span><span style="color:#a6e22e">quot</span>;}), <span style="color:#a6e22e">u</span>)
<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">e</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">err</span>.(<span style="color:#66d9ef">type</span>) {
<span style="color:#66d9ef">case</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">UnmarshalTypeError</span>:
    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;UnmarshalTypeError: Value[%s] Type[%v]\n&#34;</span>, <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Value</span>, <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Type</span>)
<span style="color:#66d9ef">case</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">InvalidUnmarshalError</span>:
    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;InvalidUnmarshalError: Type[%v]\n&#34;</span>, <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Type</span>)
<span style="color:#66d9ef">default</span>:
    <span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
}
</code></pre></div><p>如果是通过值实现<code>Error()</code>方法，在case判断处，需要归纳<code>*json.UnmarshalTypeError</code>以及<code>json.UnmarshalTypeError</code>，因为<strong>通过值实现的函数调用方可以是指针或者是值。</strong></p>
<h2 id="个性化自定义error">个性化：自定义Error</h2>
<h3 id="应用场景">应用场景</h3>
<p>当<strong>Error</strong>需要包装额外的信息，内置error又没有拓展空间时候，我偏要勉强怎么办？比如调用对象，程序栈信息等。<br>
曲线救国，可以使用自定义错误，并且把调用栈信息填入该<strong>error</strong>，下面通过列举一个<strong>自定义Error</strong>的demo，尝试在<strong>自定义Error</strong>中加入上下文信息。</p>
<p>上下文信息指的是对当前结构进行一些属性关联（如当前结构体类型，时间，情景要素等），可以封装一个<strong>context</strong>属性或者新增几个所需属性，这里列举几个简单自定义错误类型，添加不同场景的上下文数据以及调用栈。</p>
<h3 id="程序栗子">程序栗子：</h3>
<p>新建三个自定义错误，分别适应不同的场景：类型错误/容量错误/时间错误，并且在<strong>TypeError</strong>嵌入我们需要的：</p>
<ul>
<li><strong>上下文</strong>，这里简单用string作描述</li>
<li><strong>栈信息</strong>，可能用于追踪程序的执行</li>
<li><strong>Type</strong>字段，这里用于后续本例调试</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#f92672">package</span> <span style="color:#a6e22e">main</span>

<span style="color:#f92672">import</span> (
    <span style="color:#e6db74">&#34;fmt&#34;</span>
    <span style="color:#e6db74">&#34;reflect&#34;</span>
)

<span style="color:#75715e">//自定义错误1
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">TypeError</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#75715e">//上下文
</span><span style="color:#75715e"></span>    <span style="color:#a6e22e">context</span> <span style="color:#66d9ef">string</span>
    <span style="color:#a6e22e">Type</span> <span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">Type</span>
    <span style="color:#a6e22e">trace</span> <span style="color:#66d9ef">string</span>
}

<span style="color:#75715e">//具体Error()实现，返回类型，上下文，以及调用栈描述
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">tye</span><span style="color:#f92672">*</span> <span style="color:#a6e22e">TypeError</span>) <span style="color:#a6e22e">Error</span>() <span style="color:#66d9ef">string</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;Type of TypeError %s, contex: %s, trace[%s]&#34;</span>,
        <span style="color:#a6e22e">tye</span>.<span style="color:#a6e22e">Type</span>, <span style="color:#a6e22e">tye</span>.<span style="color:#a6e22e">context</span>, <span style="color:#a6e22e">tye</span>.<span style="color:#a6e22e">trace</span>)
}

<span style="color:#75715e">//自定义错误2
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">SizeError</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#a6e22e">context</span> <span style="color:#66d9ef">string</span>
    <span style="color:#a6e22e">Type</span> <span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">Type</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">sie</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">SizeError</span>) <span style="color:#a6e22e">Error</span>() <span style="color:#66d9ef">string</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;SizeError context: %s&#34;</span>, <span style="color:#a6e22e">sie</span>.<span style="color:#a6e22e">context</span>)
}

<span style="color:#75715e">//自定义错误3
</span><span style="color:#75715e"></span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">UserError</span> <span style="color:#66d9ef">struct</span> {
    <span style="color:#a6e22e">context</span> <span style="color:#66d9ef">string</span>
    <span style="color:#a6e22e">Type</span> <span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">Type</span>
}

<span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">tie</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">UserError</span>) <span style="color:#a6e22e">Error</span>() <span style="color:#66d9ef">string</span> {
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;UserError %s, contex: %s&#34;</span>, <span style="color:#a6e22e">tie</span>.<span style="color:#a6e22e">context</span>)
}

</code></pre></div><p><strong>执行栈的获取示例：</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">/*
</span><span style="color:#75715e">	https://www.komu.engineer/blogs/golang-stacktrace/golang-stacktrace
</span><span style="color:#75715e">	获取当前执行点的栈信息
</span><span style="color:#75715e">*/</span>
<span style="color:#75715e">//Package errors provides ability to annotate you regular Go errors with stack traces.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">getStackTrace</span>() <span style="color:#66d9ef">string</span> {
    <span style="color:#a6e22e">stackBuf</span> <span style="color:#f92672">:=</span> make([]<span style="color:#66d9ef">uintptr</span>, <span style="color:#ae81ff">50</span>)
    <span style="color:#a6e22e">length</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">Callers</span>(<span style="color:#ae81ff">3</span>, <span style="color:#a6e22e">stackBuf</span>[:])
    <span style="color:#a6e22e">stack</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">stackBuf</span>[:<span style="color:#a6e22e">length</span>]

    <span style="color:#a6e22e">trace</span> <span style="color:#f92672">:=</span> <span style="color:#e6db74">&#34;&#34;</span>
    <span style="color:#a6e22e">frames</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">CallersFrames</span>(<span style="color:#a6e22e">stack</span>)
    <span style="color:#66d9ef">for</span> {
    	<span style="color:#a6e22e">frame</span>, <span style="color:#a6e22e">more</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">frames</span>.<span style="color:#a6e22e">Next</span>()
    	<span style="color:#a6e22e">trace</span> = <span style="color:#a6e22e">trace</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Sprintf</span>(<span style="color:#e6db74">&#34;\n\tFile: %s, Line: %d. Function: %s&#34;</span>,
    		<span style="color:#a6e22e">frame</span>.<span style="color:#a6e22e">File</span>, <span style="color:#a6e22e">frame</span>.<span style="color:#a6e22e">Line</span>, <span style="color:#a6e22e">frame</span>.<span style="color:#a6e22e">Function</span>)
    	<span style="color:#66d9ef">if</span> !<span style="color:#a6e22e">more</span> {
    		<span style="color:#66d9ef">break</span>
    	}
    }
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">trace</span>
}
</code></pre></div><p><strong>生成错误示例：</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">/*
</span><span style="color:#75715e">	模拟不同场景产生不同错误，使用入参instruction进行选择
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">CreateWithDiffError</span>(<span style="color:#a6e22e">instruction</span> <span style="color:#66d9ef">string</span>) <span style="color:#66d9ef">error</span> {
    <span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">instruction</span> {
    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;typeErr&#34;</span>:
	<span style="color:#75715e">//上下文添加备注
</span><span style="color:#75715e"></span>    	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">TypeError</span>{<span style="color:#e6db74">&#34;Lack of energy.&#34;</span>, <span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">TypeOf</span>(<span style="color:#a6e22e">TypeError</span>{}), <span style="color:#a6e22e">getStackTrace</span>()}
    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;sizeErr&#34;</span>:
    	<span style="color:#75715e">//上下文添加时间信息
</span><span style="color:#75715e"></span>    	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">SizeError</span>{<span style="color:#e6db74">&#34;time:&#34;</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">time</span>.<span style="color:#a6e22e">UnixDate</span>, <span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">TypeOf</span>(<span style="color:#a6e22e">SizeError</span>{})}
    <span style="color:#66d9ef">case</span> <span style="color:#e6db74">&#34;userErr&#34;</span>:
    	<span style="color:#75715e">//上下文添加用户
</span><span style="color:#75715e"></span>    	<span style="color:#66d9ef">return</span> <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">UserError</span>{<span style="color:#e6db74">&#34;UserErr with selfContext: @pixelpig.&#34;</span>,
    		<span style="color:#a6e22e">reflect</span>.<span style="color:#a6e22e">TypeOf</span>(<span style="color:#a6e22e">UserError</span>{})}
    <span style="color:#66d9ef">default</span>:
	<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">errors</span>.<span style="color:#a6e22e">New</span>(<span style="color:#e6db74">&#34;UnknownError&#34;</span>)
    }	
}
</code></pre></div><hr>
<p>上面提到，因为Error的接口实现是通过指针实现的，所以可以通过.(type)进行类型断言，针对不同错误类型进行处理。</p>
<p><strong>我们来看下类型断言场景：</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">ParseErr</span>(<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) {
    <span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
    	<span style="color:#66d9ef">switch</span> <span style="color:#a6e22e">e</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">err</span>.(<span style="color:#66d9ef">type</span>) {
    	<span style="color:#66d9ef">case</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">TypeError</span>:
    		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;ErrType[%v] Context[%s]\n, Trace[%s]\n&#34;</span>, <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Type</span>, <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">context</span>, <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">trace</span>)
    		<span style="color:#75715e">//TODO: Handle 类型错误
</span><span style="color:#75715e"></span>    		<span style="color:#66d9ef">break</span>
    	<span style="color:#66d9ef">case</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">UserError</span>:
    		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;ErrType[%v] Context[%s]\n&#34;</span>, <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Type</span>, <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">context</span>)
    		<span style="color:#75715e">//TODO: Handle 用户错误
</span><span style="color:#75715e"></span>    		<span style="color:#66d9ef">break</span>
    	<span style="color:#66d9ef">case</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">SizeError</span>:
    		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Printf</span>(<span style="color:#e6db74">&#34;ErrType[%v] Context[%s]\n&#34;</span>, <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">Type</span>, <span style="color:#a6e22e">e</span>.<span style="color:#a6e22e">context</span>)
    		<span style="color:#75715e">//TODO: Handle 容量错误
</span><span style="color:#75715e"></span>    		<span style="color:#66d9ef">break</span>
    	<span style="color:#66d9ef">default</span>:
    		<span style="color:#a6e22e">log</span>.<span style="color:#a6e22e">Println</span>(<span style="color:#a6e22e">err</span>)
    	}
    }
}
</code></pre></div><blockquote>
<p>err.(type)，这里的type是自定义Error结构体反射获取的类型，与生成<code>Error</code>处赋值的Type属性是两个含义。</p>
</blockquote>
<p><strong>主程序：</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#66d9ef">var</span> (
    <span style="color:#a6e22e">TYE</span> = <span style="color:#e6db74">&#34;typeErr&#34;</span>
    <span style="color:#a6e22e">SE</span> = <span style="color:#e6db74">&#34;sizeErr&#34;</span>
    <span style="color:#a6e22e">UE</span> = <span style="color:#e6db74">&#34;userErr&#34;</span>
)

<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">main</span>() {
    <span style="color:#a6e22e">typeErr</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">CreateWithDiffError</span>(<span style="color:#a6e22e">TYE</span>)
    <span style="color:#a6e22e">seErr</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">CreateWithDiffError</span>(<span style="color:#a6e22e">SE</span>)
    <span style="color:#a6e22e">timeErr</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">CreateWithDiffError</span>(<span style="color:#a6e22e">UE</span>)
    
    <span style="color:#a6e22e">ParseErr</span>(<span style="color:#a6e22e">typeErr</span>)
    <span style="color:#a6e22e">ParseErr</span>(<span style="color:#a6e22e">seErr</span>)
    <span style="color:#a6e22e">ParseErr</span>(<span style="color:#a6e22e">timeErr</span>)
}
</code></pre></div><p><strong>程序输出：</strong></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ae81ff">2020</span><span style="color:#f92672">/</span><span style="color:#ae81ff">02</span><span style="color:#f92672">/</span><span style="color:#ae81ff">02</span> <span style="color:#ae81ff">13</span>:<span style="color:#ae81ff">08</span>:<span style="color:#ae81ff">25</span> <span style="color:#a6e22e">ErrType</span>[<span style="color:#a6e22e">main</span>.<span style="color:#a6e22e">TypeError</span>] <span style="color:#a6e22e">Context</span>[<span style="color:#a6e22e">Lack</span> <span style="color:#a6e22e">of</span> <span style="color:#a6e22e">energy</span>.]
, <span style="color:#a6e22e">Trace</span>[
	<span style="color:#a6e22e">File</span>: <span style="color:#a6e22e">D</span>:<span style="color:#f92672">/</span><span style="color:#a6e22e">goProject</span><span style="color:#f92672">/</span><span style="color:#a6e22e">src</span><span style="color:#f92672">/</span><span style="color:#a6e22e">HelloGo</span><span style="color:#f92672">/</span><span style="color:#a6e22e">basic</span><span style="color:#f92672">/</span><span style="color:#a6e22e">ErrorHandle</span><span style="color:#f92672">/</span><span style="color:#a6e22e">ErrorDemo</span>.<span style="color:#66d9ef">go</span>, <span style="color:#a6e22e">Line</span>: <span style="color:#ae81ff">19.</span> <span style="color:#a6e22e">Function</span>: <span style="color:#a6e22e">main</span>.<span style="color:#a6e22e">main</span>
	<span style="color:#a6e22e">File</span>: <span style="color:#a6e22e">D</span>:<span style="color:#f92672">/</span><span style="color:#a6e22e">Go1</span><span style="color:#ae81ff">.12</span><span style="color:#f92672">/</span><span style="color:#a6e22e">src</span><span style="color:#f92672">/</span><span style="color:#a6e22e">runtime</span><span style="color:#f92672">/</span><span style="color:#a6e22e">proc</span>.<span style="color:#66d9ef">go</span>, <span style="color:#a6e22e">Line</span>: <span style="color:#ae81ff">200.</span> <span style="color:#a6e22e">Function</span>: <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">main</span>
	<span style="color:#a6e22e">File</span>: <span style="color:#a6e22e">D</span>:<span style="color:#f92672">/</span><span style="color:#a6e22e">Go1</span><span style="color:#ae81ff">.12</span><span style="color:#f92672">/</span><span style="color:#a6e22e">src</span><span style="color:#f92672">/</span><span style="color:#a6e22e">runtime</span><span style="color:#f92672">/</span><span style="color:#a6e22e">asm_amd64</span>.<span style="color:#a6e22e">s</span>, <span style="color:#a6e22e">Line</span>: <span style="color:#ae81ff">1337.</span> <span style="color:#a6e22e">Function</span>: <span style="color:#a6e22e">runtime</span>.<span style="color:#a6e22e">goexit</span>]
<span style="color:#ae81ff">2020</span><span style="color:#f92672">/</span><span style="color:#ae81ff">02</span><span style="color:#f92672">/</span><span style="color:#ae81ff">02</span> <span style="color:#ae81ff">13</span>:<span style="color:#ae81ff">08</span>:<span style="color:#ae81ff">25</span> <span style="color:#a6e22e">ErrType</span>[<span style="color:#a6e22e">main</span>.<span style="color:#a6e22e">SizeError</span>] <span style="color:#a6e22e">Context</span>[<span style="color:#a6e22e">time</span>:<span style="color:#a6e22e">Mon</span> <span style="color:#a6e22e">Jan</span> <span style="color:#a6e22e">_2</span> <span style="color:#ae81ff">15</span>:<span style="color:#ae81ff">04</span>:<span style="color:#ae81ff">05</span> <span style="color:#a6e22e">MST</span> <span style="color:#ae81ff">2006</span>]
<span style="color:#ae81ff">2020</span><span style="color:#f92672">/</span><span style="color:#ae81ff">02</span><span style="color:#f92672">/</span><span style="color:#ae81ff">02</span> <span style="color:#ae81ff">13</span>:<span style="color:#ae81ff">08</span>:<span style="color:#ae81ff">25</span> <span style="color:#a6e22e">ErrType</span>[<span style="color:#a6e22e">main</span>.<span style="color:#a6e22e">UserError</span>] <span style="color:#a6e22e">Context</span>[<span style="color:#a6e22e">UserErr</span> <span style="color:#a6e22e">with</span> <span style="color:#a6e22e">selfContext</span>: <span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">pixelpig</span>.]
</code></pre></div><p>可以看到第一个自定义类型打印出了程序执行的栈信息。</p>
<h3 id="wrapingerror嵌套">Wraping：error嵌套</h3>
<p>如果不想通过<strong>自定义error</strong>来实现内嵌信息，在Go1.13以上版本，提供了一个新的错误包装方式，通过扩展<strong>fmt.Errorf</strong>函数，加一个<code>%w</code>来生成一个可以包装的错误，通过这种方式，我们可以创建一个嵌套Error。</p>
<h4 id="示例">示例：</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#75715e">/*
</span><span style="color:#75715e">	包装错误
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">func</span> <span style="color:#a6e22e">WrapErr</span>(<span style="color:#a6e22e">err</span> <span style="color:#66d9ef">error</span>) <span style="color:#66d9ef">error</span>{
    <span style="color:#66d9ef">return</span> <span style="color:#a6e22e">fmt</span>.<span style="color:#a6e22e">Errorf</span>(<span style="color:#e6db74">&#34;Wrap with shell: %v&#34;</span>, <span style="color:#a6e22e">err</span>)
}
</code></pre></div><p>经过<code>Errorf</code>的包装会返回一个新的<code>Error</code>，其中“Wrap with shell”是包装的内容。</p>
<h4 id="输出如下">输出如下：</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-go" data-lang="go"><span style="color:#ae81ff">2020</span><span style="color:#f92672">/</span><span style="color:#ae81ff">02</span><span style="color:#f92672">/</span><span style="color:#ae81ff">02</span> <span style="color:#ae81ff">17</span>:<span style="color:#ae81ff">20</span>:<span style="color:#ae81ff">38</span> <span style="color:#a6e22e">Wrap</span> <span style="color:#a6e22e">with</span> <span style="color:#a6e22e">shell</span>: <span style="color:#a6e22e">UserError</span> <span style="color:#a6e22e">contex</span>: <span style="color:#a6e22e">UserErr</span> <span style="color:#a6e22e">with</span> <span style="color:#a6e22e">selfContext</span>: <span style="color:#960050;background-color:#1e0010">@</span><span style="color:#a6e22e">pixelpig</span>.
</code></pre></div><p>如果要还原解开错误，<strong>Go1.13</strong> 的<code>errors</code>提供了一个<strong>errors.Unwrap(w)</strong> 方法，返回原始错误，即被嵌套的那个<strong>error</strong> ，支持多次还原，直到返回nil。</p>
<h2 id="总结">总结</h2>
<p><strong>Go语言</strong>不像<strong>Java</strong>有<strong>Exception</strong>异常和<strong>JVM堆栈</strong>环境，没有帮我们封装执行栈的数据到内置<strong>error</strong>中，它建议程序员在错误发生处尽早处理，不倾向于把错误往上层抛，所以如果要方便追溯错误在程序的位置，可以通过生成自定义错误，植入函数栈的位置。</p>
<p>如果遵循Go的推荐实践，大部分情况希望我们在错误发生处进行handle，尽早处理，那么假如仅仅需要一些上下文信息，比如时间，用户等。这种情况可以使用<strong>自定义error</strong>，或者使用Go自带包装方式，存储我们额外需要的字段，如上述的<strong>UserError</strong>。</p>
<h2 id="参考链接">参考链接</h2>
<p><strong>Custom errors in golang and pointer receivers</strong><br>
<a href="https://stackoverflow.com/questions/50333428/custom-errors-in-golang-and-pointer-receivers">https://stackoverflow.com/questions/50333428/custom-errors-in-golang-and-pointer-receivers</a></p>
<p><strong>Error Handling In Go, Part I</strong><br>
<a href="https://www.ardanlabs.com/blog/2014/10/error-handling-in-go-part-i.html">https://www.ardanlabs.com/blog/2014/10/error-handling-in-go-part-i.html</a><br>
<strong>Error Handling In Go, Part II</strong><br>
<a href="https://www.ardanlabs.com/blog/2014/11/error-handling-in-go-part-ii.html">https://www.ardanlabs.com/blog/2014/11/error-handling-in-go-part-ii.html</a></p>
<p>//TODO：
<a href="https://dave.cheney.net/2015/01/26/errors-and-exceptions-redux">https://dave.cheney.net/2015/01/26/errors-and-exceptions-redux</a></p>
              
            </div>
          </div>
          <div id="post-footer" class="post-footer main-content-wrap">
            
              
                
                
                  <div class="post-footer-tags">
                    <span class="text-color-light text-small">标签</span><br/>
                    
  <a class="tag tag--primary tag--small" href="/tags/errors/">errors</a>

                  </div>
                
              
            
            <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="/2020/03/grpc-action/" data-tooltip="Grpc action">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">下一篇</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="/2020/02/%E8%81%8A%E4%B8%80%E8%81%8Ago%E7%BC%96%E5%86%99%E7%9A%84%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7%E7%B1%BB/" data-tooltip="聊一聊Go编写的命令行工具类">
              
                  <span class="hide-xs hide-sm text-small icon-mr">上一篇</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#">
        
          <i class="fa fa-list"></i>
        </a>
      </li>
    </ul>
  
</div>

            
              
            
          </div>
        </article>
        <footer id="footer" class="main-content-wrap">
  <span class="copyrights">
    &copy; 2022 <a href="https://github.com/pixeldin">pixeldin</a>. All Rights Reserved
  </span>
</footer>

      </div>
      <div id="bottom-bar" class="post-bottom-bar" data-behavior="5">
        <div class="post-actions-wrap">
  
      <nav >
        <ul class="post-actions post-action-nav">
          
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="/2020/03/grpc-action/" data-tooltip="Grpc action">
              
                  <i class="fa fa-angle-left"></i>
                  <span class="hide-xs hide-sm text-small icon-ml">下一篇</span>
                </a>
            </li>
            <li class="post-action">
              
                <a class="post-action-btn btn btn--default tooltip--top" href="/2020/02/%E8%81%8A%E4%B8%80%E8%81%8Ago%E7%BC%96%E5%86%99%E7%9A%84%E5%91%BD%E4%BB%A4%E8%A1%8C%E5%B7%A5%E5%85%B7%E7%B1%BB/" data-tooltip="聊一聊Go编写的命令行工具类">
              
                  <span class="hide-xs hide-sm text-small icon-mr">上一篇</span>
                  <i class="fa fa-angle-right"></i>
                </a>
            </li>
          
        </ul>
      </nav>
    <ul class="post-actions post-action-share" >
      
      
      <li class="post-action">
        
          <a class="post-action-btn btn btn--default" href="#">
        
          <i class="fa fa-list"></i>
        </a>
      </li>
    </ul>
  
</div>

      </div>
      <div id="share-options-bar" class="share-options-bar" data-behavior="5">
  <i id="btn-close-shareoptions" class="fa fa-close"></i>
  <ul class="share-options">
    
  </ul>
</div>
<div id="share-options-mask" class="share-options-mask"></div>
    </div>
    
    <div id="about">
  <div id="about-card">
    <div id="about-btn-close">
      <i class="fa fa-remove"></i>
    </div>
    
      <img id="about-card-picture" src="https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/pig.jpg" alt="作者的图片" />
    
    <h4 id="about-card-name">pixelpig</h4>
    
      <div id="about-card-bio">Stay hungry, stay foolish <strong>:）</strong></div>
    
    
      <div id="about-card-job">
        <i class="fa fa-briefcase"></i>
        <br/>
        后端开发@广州虎牙
      </div>
    
    
      <div id="about-card-location">
        <i class="fa fa-map-marker"></i>
        <br/>
        CHINA-ZH
      </div>
    
  </div>
</div>

    

    
  
    <div id="cover" style="background-image:url('https://pixelpig-1253685321.cos.ap-guangzhou.myqcloud.com/cover.jpg');"></div>
  


    
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.7/js/jquery.fancybox.min.js" integrity="sha256-GEAnjcTqVP+vBp3SSc8bEDQqvWAZMiHyUSIorrWwH50=" crossorigin="anonymous"></script>


<script src="/js/script-pcw6v3xilnxydl1vddzazdverrnn9ctynvnxgwho987mfyqkuylcb1nlt.min.js"></script>


<script lang="javascript">
window.onload = updateMinWidth;
window.onresize = updateMinWidth;
document.getElementById("sidebar").addEventListener("transitionend", updateMinWidth);
function updateMinWidth() {
  var sidebar = document.getElementById("sidebar");
  var main = document.getElementById("main");
  main.style.minWidth = "";
  var w1 = getComputedStyle(main).getPropertyValue("min-width");
  var w2 = getComputedStyle(sidebar).getPropertyValue("width");
  var w3 = getComputedStyle(sidebar).getPropertyValue("left");
  main.style.minWidth = `calc(${w1} - ${w2} - ${w3})`;
}
</script>

<script>
$(document).ready(function() {
  hljs.configure({ classPrefix: '', useBR: false });
  $('pre.code-highlight > code, pre > code').each(function(i, block) {
    if (!$(this).hasClass('codeblock')) {
      $(this).addClass('codeblock');
    }
    hljs.highlightBlock(block);
  });
});
</script>


  
    
  




    
  </body>
</html>

